<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="KiseokLee" />

<meta name="date" content="2022-02-07" />

<title>220207_pH_simulation_1st_trial</title>

<script src="site_libs/header-attrs-2.9/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Denit_simulation</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/KiseokLee/Denit_simulation">
    <span class="fa fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">220207_pH_simulation_1st_trial</h1>
<h4 class="author">KiseokLee</h4>
<h4 class="date">2022-02-07</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2022-02-15
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>Denit_simulation/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.6.2). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date </a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20220207code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20220207)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20220207code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20220207)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomKiseokLeeDenitsimulationtree6a18c131b4c8a1e9e2a367e2bb5081d5e9895d36targetblank6a18c13a"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://github.com/KiseokLee/Denit_simulation/tree/6a18c131b4c8a1e9e2a367e2bb5081d5e9895d36" target="_blank">6a18c13</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomKiseokLeeDenitsimulationtree6a18c131b4c8a1e9e2a367e2bb5081d5e9895d36targetblank6a18c13a" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version <a href="https://github.com/KiseokLee/Denit_simulation/tree/6a18c131b4c8a1e9e2a367e2bb5081d5e9895d36" target="_blank">6a18c13</a>. See the <em>Past versions</em> tab to see a history of the changes made to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/

Untracked files:
    Untracked:  data/consumer_resource_parameters_ADM.csv
    Untracked:  data/consumer_resource_parameters_SDM.csv
    Untracked:  mat_CV.csv
    Untracked:  mat_Rsquare.csv
    Untracked:  tutorial_coupled_odes.pdf

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made to the R Markdown (<code>analysis/220207_pH_simulation_1st_trial.Rmd</code>) and HTML (<code>docs/220207_pH_simulation_1st_trial.html</code>) files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/KiseokLee/Denit_simulation/blob/6a18c131b4c8a1e9e2a367e2bb5081d5e9895d36/analysis/220207_pH_simulation_1st_trial.Rmd" target="_blank">6a18c13</a>
</td>
<td>
KiseokLee
</td>
<td>
2022-02-15
</td>
<td>
wflow_publish(“analysis/220207_pH_simulation_1st_trial.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/KiseokLee/Denit_simulation/a22e2a0550f481efd9b5a5affe1e99e535ad46f0/docs/220207_pH_simulation_1st_trial.html" target="_blank">a22e2a0</a>
</td>
<td>
KiseokLee
</td>
<td>
2022-02-08
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/KiseokLee/Denit_simulation/blob/1cce975ee5e9d087723bdba02ecb5428ae3eb168/analysis/220207_pH_simulation_1st_trial.Rmd" target="_blank">1cce975</a>
</td>
<td>
KiseokLee
</td>
<td>
2022-02-08
</td>
<td>
wflow_publish(“analysis/220207_pH_simulation_1st_trial.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/KiseokLee/Denit_simulation/b1dc610ae08b8bad515972f68e7dbb3f40fac3d7/docs/220207_pH_simulation_1st_trial.html" target="_blank">b1dc610</a>
</td>
<td>
KiseokLee
</td>
<td>
2022-02-08
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/KiseokLee/Denit_simulation/blob/521e7673213939564fb6e646ae3a89d2ff13b0c1/analysis/220207_pH_simulation_1st_trial.Rmd" target="_blank">521e767</a>
</td>
<td>
KiseokLee
</td>
<td>
2022-02-08
</td>
<td>
wflow_publish(“analysis/220207_pH_simulation_1st_trial.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/KiseokLee/Denit_simulation/51a9edc8a831f2ca18af504281f3e781d1ab63ab/docs/220207_pH_simulation_1st_trial.html" target="_blank">51a9edc</a>
</td>
<td>
KiseokLee
</td>
<td>
2022-02-07
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/KiseokLee/Denit_simulation/blob/c4b6f8b358b3a7ee4c099cc5a2620d9c976fe13a/analysis/220207_pH_simulation_1st_trial.Rmd" target="_blank">c4b6f8b</a>
</td>
<td>
KiseokLee
</td>
<td>
2022-02-07
</td>
<td>
wflow_publish(“analysis/220207_pH_simulation_1st_trial.Rmd”)
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="denitrification-and-ph-perturbation-simulation-first-trial" class="section level2">
<h2>220207 Denitrification and pH perturbation simulation first trial</h2>
<p>Name: <strong>Kiseok Lee</strong><br />
Date: 2/7/22<br />
Lab: <strong>Seppe Kuehn lab</strong></p>
</div>
<div id="setting-up" class="section level2">
<h2>1. Setting up</h2>
</div>
<div id="first-lets-set-up-the-consumer-resource-model-dynamics" class="section level2">
<h2>1.1. First let’s set up the consumer resource model dynamics</h2>
<pre class="r"><code>## Consumer resource model
#&#39; @param x cell biomass (OD)
#&#39; @param I nitrite concentration (mM)
#&#39; @param A nitrate concentration (mM)
#&#39; @param gamI biomass yields from nitrite (OD/mM)
#&#39; @param gamA biomass yields from nitrate (OD/mM)
#&#39; @param rI reduction rate of nitrite ((mM/OD)/h)
#&#39; @param rA reduction rate of nitrate ((mM/OD)/h)
#&#39; @param kI half velocity constant of nitrate reduction (mM)
#&#39; @param kA half velocity constant of nitrate reduction (mM)

# set up the Consumer Resource model ode (for 1 strain)
crGrowth1 &lt;- function(t, state, parameters) {
    with(as.list(c(state, parameters)), {
        # biomass
        dx &lt;- (gamA * rA * (A/(kA + A)) + gamI * rI * (I/(kI + I))) * x
        # nitrate
        dA &lt;- -rA * (A/(kA + A)) * x
        # nitrite
        dI &lt;- (rA * (A/(kA + A)) - rI * (I/(kI + I))) * x
        list(c(dx, dA, dI))
    })  # end with(as.list ...
}

parameters &lt;- c(gamI = 0.01, rI = 1.6, gamA = 0.01, rA = 3.1, kI = 0.01, kA = 0.01)
parameters &lt;- c(gamI = 1, rI = 1, gamA = 1, rA = 1, kI = 1, kA = 1)

state &lt;- c(x = 2, A = 2, I = 0)

times &lt;- seq(0, 10, by = 1)
outc &lt;- ode(state, times, crGrowth1, parameters, method = &quot;lsoda&quot;, atol = 1e-04,
    rtol = 1e-04)
outc</code></pre>
<pre><code>   time        x             A             I
1     0 2.000000  2.000000e+00  0.000000e+00
2     1 4.530518  4.314895e-01  6.065030e-01
3     2 5.971205  2.634032e-03  2.352718e-02
4     3 5.999901  5.141715e-06  8.889920e-05
5     4 6.000003 -1.521840e-07 -2.807206e-06
6     5 6.000001 -4.045027e-08 -8.435248e-07
7     6 6.000000 -5.779288e-09 -1.255200e-07
8     7 6.000000 -8.256193e-10 -1.863979e-08
9     8 6.000000 -1.179472e-10 -2.764095e-09
10    9 6.000000 -1.684985e-11 -4.093402e-10
11   10 6.000000 -2.407158e-12 -6.054445e-11</code></pre>
<pre class="r"><code>plot(outc, xlab = &quot;time&quot;, ylab = &quot;-&quot;)
plot(outc, xlab = &quot;Time (hr)&quot;, ylab = c(&quot;Biomass (OD)&quot;, &quot;Nitrite (mM)&quot;, &quot;Nitrate (mM)&quot;),
    col = &quot;black&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1, main = &quot;Consumer Resource model&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-2-1.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-2-2.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="enable-many-strains-community-level-dynamics" class="section level2">
<h2>1.2. Enable many strains (community level dynamics)</h2>
<pre class="r"><code># set up the Consumer Resource model ode
crGrowth &lt;- function(t, state, parameters ) {
with(as.list(c(state, parameters)),{
  # x is a vector of strain absolute abundance
  x = state[1:(length(state)-2)]
  dx &lt;- diag(x) %*% (diag(gamA) %*% diag(rA) %*% (A/(kA + A)) + diag(gamI) %*% diag(rI) %*% (I/(kI + I)))
  # nitrate concentration is A
  dA &lt;- - t(diag(rA) %*% (A/(kA + A))) %*% x
  # nitrite concentration is I
  dI &lt;- ( t(diag(rA) %*% (A/(kA + A))) - t( diag(rI) %*% (I/(kI + I)) ) ) %*% x
  return(list( c(dx, dA, dI) ))
  })
}

# set up the Consumer Resource model ode (that works with both 1 species &amp; n (&gt;1) strain community)
crGrowth &lt;- function(t, state, parameters ) {
  if (length(state) == 3){
    with(as.list(c(state, parameters)),{
    # biomass
    dx &lt;- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
    # nitrate
    dA &lt;- - rA*(A/(kA + A)) *x
    # nitrite
    dI &lt;- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
    list(c(dx, dA, dI))
    })
  } else{
    with(as.list(c(state, parameters)),{
    # x is a vector of strain absolute abundance
    x = state[1:(length(state)-2)]
    dx &lt;- diag(x) %*% (diag(gamA) %*% diag(rA) %*% (A/(kA + A)) + diag(gamI) %*% diag(rI) %*% (I/(kI + I)))
    # nitrate concentration is A
    dA &lt;- - t(diag(rA) %*% (A/(kA + A))) %*% x
    # nitrite concentration is I
    dI &lt;- ( t(diag(rA) %*% (A/(kA + A))) - t( diag(rI) %*% (I/(kI + I)) ) ) %*% x
    return(list( c(dx, dA, dI) ))
    })
  }
}

parameters = list(gamI=c(0.01,0.02), rI =c(1.6,1.5), gamA= c(0.01,0.02), rA = c(3.1,3.2), kI = c(0.01,0.02), kA = c(0.01,0.02))
state = list(x = c(2,3), A = 2, I = 0)

# ODE solver
times &lt;- seq(0, 10, by = 0.1)
outc &lt;- ode(unlist(state), times, crGrowth, parameters, method = &quot;ode45&quot;, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
# I&#39;ll use ode45
outc</code></pre>
<pre><code>    time       x1       x2             A             I
1    0.0 2.000000 3.000000  2.000000e+00  0.000000e+00
2    0.1 2.009139 3.027119  4.387032e-01  8.526813e-01
3    0.2 2.014119 3.041185  9.566777e-06  5.288413e-01
4    0.3 2.016396 3.047207  7.481851e-06 -9.112898e-06
5    0.4 2.016396 3.047207  6.925327e-05 -1.210558e-04
6    0.5 2.016396 3.047208  5.698588e-05 -1.053165e-04
7    0.6 2.016396 3.047208  4.814721e-05 -9.036422e-05
8    0.7 2.016396 3.047208  4.738993e-05 -8.839500e-05
9    0.8 2.016396 3.047208 -2.487696e-05  4.609326e-05
10   0.9 2.016396 3.047208 -2.442479e-05  4.849939e-05
11   1.0 2.016396 3.047208  5.037551e-05 -9.392275e-05
12   1.1 2.016396 3.047208 -2.451057e-05  4.283475e-05
13   1.2 2.016396 3.047208  2.413668e-05 -3.301707e-05
14   1.3 2.016396 3.047208 -1.162307e-05  2.323798e-05
15   1.4 2.016396 3.047209  2.790094e-05 -4.849429e-05
16   1.5 2.016396 3.047209  1.004004e-05 -1.122437e-05
17   1.6 2.016396 3.047208  4.204556e-05 -7.591024e-05
18   1.7 2.016396 3.047209  8.444569e-06 -1.527790e-05
19   1.8 2.016396 3.047209 -3.614262e-05  6.366913e-05
20   1.9 2.016396 3.047208  1.226578e-04 -2.190247e-04
21   2.0 2.016396 3.047209 -1.075921e-04  1.716499e-04
22   2.1 2.016396 3.047208  1.987866e-06 -2.373436e-06
23   2.2 2.016396 3.047208 -4.206492e-06  6.222346e-06
24   2.3 2.016396 3.047208  1.998847e-05 -3.928594e-05
25   2.4 2.016396 3.047208 -2.510349e-06  3.892779e-06
26   2.5 2.016396 3.047208  9.360811e-06 -1.625020e-05
27   2.6 2.016396 3.047208 -5.737527e-05  1.027879e-04
28   2.7 2.016396 3.047208 -1.434521e-05  1.720633e-05
29   2.8 2.016396 3.047208  3.256083e-05 -4.974466e-05
30   2.9 2.016396 3.047208 -4.678890e-05  8.609022e-05
31   3.0 2.016396 3.047208  4.286475e-05 -7.895249e-05
32   3.1 2.016396 3.047208 -8.466925e-05  1.508332e-04
33   3.2 2.016396 3.047208  1.988778e-06 -2.682752e-06
34   3.3 2.016396 3.047208  2.839148e-05 -5.245549e-05
35   3.4 2.016396 3.047208  4.116053e-05 -7.581366e-05
36   3.5 2.016396 3.047208  2.399091e-05 -4.087155e-05
37   3.6 2.016396 3.047208  4.270361e-06 -8.585930e-06
38   3.7 2.016396 3.047208  9.282977e-05 -1.641070e-04
39   3.8 2.016396 3.047208 -2.927406e-05  5.564836e-05
40   3.9 2.016396 3.047208  6.911225e-06 -1.115286e-05
41   4.0 2.016396 3.047208  2.160602e-05 -3.670595e-05
42   4.1 2.016396 3.047208  6.238618e-05 -1.153404e-04
43   4.2 2.016396 3.047208  1.178509e-05 -2.138375e-05
44   4.3 2.016396 3.047208  9.609113e-06 -1.711036e-05
45   4.4 2.016396 3.047208 -2.902659e-05  5.349019e-05
46   4.5 2.016396 3.047208  3.020105e-05 -5.321731e-05
47   4.6 2.016396 3.047208 -2.792770e-05  5.327538e-05
48   4.7 2.016396 3.047208  3.261226e-06 -4.333457e-06
49   4.8 2.016396 3.047209  5.528311e-05 -1.060959e-04
50   4.9 2.016396 3.047208  1.244284e-05 -2.316567e-05
51   5.0 2.016396 3.047209  2.390831e-06 -4.553561e-06
52   5.1 2.016396 3.047209  4.267672e-05 -7.897931e-05
53   5.2 2.016396 3.047209  1.456939e-06 -2.241346e-06
54   5.3 2.016396 3.047209 -2.574566e-05  5.148345e-05
55   5.4 2.016396 3.047209  4.040550e-05 -7.374184e-05
56   5.5 2.016396 3.047209  5.511481e-06 -1.080399e-05
57   5.6 2.016396 3.047209  8.568685e-06 -8.989181e-06
58   5.7 2.016396 3.047209 -4.982217e-05  9.289796e-05
59   5.8 2.016396 3.047209  1.260783e-05 -2.522875e-05
60   5.9 2.016395 3.047209  2.877074e-05 -4.026808e-05
61   6.0 2.016395 3.047209 -5.618405e-05  1.019418e-04
62   6.1 2.016395 3.047209 -1.038344e-06  3.117952e-06
63   6.2 2.016395 3.047209  9.286111e-06 -1.300407e-05
64   6.3 2.016395 3.047210  5.274792e-06 -1.043870e-05
65   6.4 2.016395 3.047210  3.899441e-05 -7.154668e-05
66   6.5 2.016395 3.047210 -1.537212e-05  2.933891e-05
67   6.6 2.016395 3.047210  1.223882e-05 -2.346343e-05
68   6.7 2.016395 3.047210  5.730285e-06 -7.833830e-06
69   6.8 2.016395 3.047210 -2.857587e-05  4.950585e-05
70   6.9 2.016395 3.047210  5.066110e-06 -1.157107e-05
71   7.0 2.016395 3.047209  1.011602e-04 -1.754943e-04
72   7.1 2.016395 3.047209 -1.554104e-05  3.065251e-05
73   7.2 2.016395 3.047209 -2.245701e-05  4.217958e-05
74   7.3 2.016395 3.047210 -2.804344e-05  4.774029e-05
75   7.4 2.016395 3.047209 -3.081848e-05  5.594290e-05
76   7.5 2.016395 3.047209  1.640748e-05 -2.268455e-05
77   7.6 2.016395 3.047210  1.943011e-06 -3.199751e-06
78   7.7 2.016395 3.047210  9.863575e-05 -1.742169e-04
79   7.8 2.016395 3.047210  5.291242e-05 -9.372874e-05
80   7.9 2.016395 3.047210 -4.436011e-05  8.176250e-05
81   8.0 2.016395 3.047210  3.529064e-05 -6.212815e-05
82   8.1 2.016395 3.047210  3.212333e-05 -5.965296e-05
83   8.2 2.016395 3.047210 -3.874289e-05  6.536869e-05
84   8.3 2.016395 3.047210 -6.158302e-05  1.085258e-04
85   8.4 2.016395 3.047210 -9.026755e-05  1.561467e-04
86   8.5 2.016395 3.047210 -2.551677e-05  4.887653e-05
87   8.6 2.016395 3.047210  7.257198e-06 -1.411320e-05
88   8.7 2.016395 3.047210 -1.496540e-05  2.907419e-05
89   8.8 2.016395 3.047210  1.043779e-05 -8.340222e-06
90   8.9 2.016395 3.047210  4.200921e-06 -6.742556e-06
91   9.0 2.016395 3.047210  3.413187e-05 -5.188594e-05
92   9.1 2.016395 3.047210  6.632030e-05 -1.112680e-04
93   9.2 2.016395 3.047210 -4.394536e-05  7.958885e-05
94   9.3 2.016395 3.047210 -1.844952e-07  2.317138e-06
95   9.4 2.016395 3.047210  3.978153e-05 -6.470272e-05
96   9.5 2.016395 3.047210  2.258839e-05 -3.194199e-05
97   9.6 2.016395 3.047210  9.030973e-06 -1.402012e-05
98   9.7 2.016395 3.047211  7.339729e-06 -1.356697e-05
99   9.8 2.016395 3.047210  1.288078e-05 -1.754536e-05
100  9.9 2.016395 3.047210  3.040074e-05 -6.210939e-05
101 10.0 2.016395 3.047210  4.475552e-05 -8.130978e-05</code></pre>
<pre class="r"><code># plot
n_strains &lt;- length(state$x)
plot(outc, xlab = &quot;time&quot;, ylab = &quot;&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-3-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot(outc, xlab=&quot;Time (hr)&quot;, ylab=c(rep(&quot;Biomass (OD)&quot;,n_strains),&quot;Nitrate NO3- (mM)&quot;,&quot;Nitrite NO2- (mM)&quot;), col=&#39;black&#39;, type = &quot;l&quot;,lty = 1, pch=19,lwd=1, main=&quot;Consumer Resource model&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-3-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## as in Karna&#39;s paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna&#39;s paper)
## rI, rA max is 15 (from Karna&#39;s paper)
k = 10
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(1,k), A = 2, I = 0)

# ODE solver
times &lt;- seq(0, 10, by = 0.1)
outc &lt;- ode(unlist(state), times, crGrowth, parameters, method = &quot;vode&quot;, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
outc</code></pre>
<pre><code>    time       x1       x2       x3       x4       x5       x6       x7
1    0.0 1.000000 1.000000 1.000000 1.000000 1.000000 1.000000 1.000000
2    0.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
3    0.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
4    0.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
5    0.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
6    0.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
7    0.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
8    0.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
9    0.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
10   0.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
11   1.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
12   1.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
13   1.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
14   1.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
15   1.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
16   1.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
17   1.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
18   1.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
19   1.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
20   1.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
21   2.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
22   2.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
23   2.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
24   2.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
25   2.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
26   2.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
27   2.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
28   2.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
29   2.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
30   2.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
31   3.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
32   3.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
33   3.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
34   3.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
35   3.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
36   3.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
37   3.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
38   3.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
39   3.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
40   3.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
41   4.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
42   4.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
43   4.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
44   4.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
45   4.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
46   4.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
47   4.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
48   4.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
49   4.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
50   4.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
51   5.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
52   5.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
53   5.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
54   5.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
55   5.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
56   5.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
57   5.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
58   5.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
59   5.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
60   5.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
61   6.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
62   6.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
63   6.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
64   6.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
65   6.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
66   6.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
67   6.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
68   6.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
69   6.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
70   6.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
71   7.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
72   7.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
73   7.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
74   7.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
75   7.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
76   7.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
77   7.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
78   7.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
79   7.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
80   7.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
81   8.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
82   8.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
83   8.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
84   8.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
85   8.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
86   8.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
87   8.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
88   8.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
89   8.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
90   8.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
91   9.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
92   9.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
93   9.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
94   9.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
95   9.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
96   9.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
97   9.6 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
98   9.7 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
99   9.8 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
100  9.9 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
101 10.0 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432
          x8       x9      x10              A              I
1   1.000000 1.000000 1.000000   2.000000e+00   0.000000e+00
2   1.001309 1.004155 1.002888   7.486725e-19  -1.630817e-07
3   1.001309 1.004155 1.002888  -5.145732e-20   1.641853e-08
4   1.001309 1.004155 1.002888  -2.800363e-20   8.892873e-09
5   1.001309 1.004155 1.002888  -2.299140e-22   7.329550e-11
6   1.001309 1.004155 1.002888   1.247024e-21  -3.957657e-10
7   1.001309 1.004155 1.002888   1.248889e-22  -3.965093e-11
8   1.001309 1.004155 1.002888  -4.497520e-23   1.427269e-11
9   1.001309 1.004155 1.002888  -9.781601e-24   3.104968e-12
10  1.001309 1.004155 1.002888   1.137629e-24  -3.609464e-13
11  1.001309 1.004155 1.002888   5.471689e-25  -1.736718e-13
12  1.001309 1.004155 1.002888  -1.257313e-27   3.928272e-16
13  1.001309 1.004155 1.002888  -2.488100e-26   7.896674e-15
14  1.001309 1.004155 1.002888  -2.227311e-27   7.071803e-16
15  1.001309 1.004155 1.002888   9.216660e-28  -2.924904e-16
16  1.001309 1.004155 1.002888   1.854252e-28  -5.886020e-17
17  1.001309 1.004155 1.002888  -2.469268e-29   7.834786e-18
18  1.001309 1.004155 1.002888  -1.065952e-29   3.383367e-18
19  1.001309 1.004155 1.002888   1.390176e-31  -4.399993e-20
20  1.001309 1.004155 1.002888   4.952260e-31  -1.571750e-19
21  1.001309 1.004155 1.002888   3.917249e-32  -1.243808e-20
22  1.001309 1.004155 1.002888  -1.881831e-32   5.972055e-21
23  1.001309 1.004155 1.002888  -3.500626e-33   1.111233e-21
24  1.001309 1.004155 1.002888   5.303631e-34  -1.682854e-22
25  1.001309 1.004155 1.002888   2.071333e-34  -6.574538e-23
26  1.001309 1.004155 1.002888  -4.988891e-36   1.581007e-24
27  1.001309 1.004155 1.002888  -9.833127e-36   3.120866e-24
28  1.001309 1.004155 1.002888  -6.769341e-37   2.149551e-25
29  1.001309 1.004155 1.002888   3.829135e-37  -1.215203e-25
30  1.001309 1.004155 1.002888   6.579258e-38  -2.088541e-26
31  1.001309 1.004155 1.002888  -1.129102e-38   3.582765e-27
32  1.001309 1.004155 1.002888  -4.014438e-39   1.274219e-27
33  1.001309 1.004155 1.002888   1.424976e-40  -4.517989e-29
34  1.001309 1.004155 1.002888   1.947807e-40  -6.182057e-29
35  1.001309 1.004155 1.002888   1.143237e-41  -3.630585e-30
36  1.001309 1.004155 1.002888  -7.766470e-42   2.464770e-30
37  1.001309 1.004155 1.002888  -1.230450e-42   3.906050e-31
38  1.001309 1.004155 1.002888   2.385580e-43  -7.569887e-32
39  1.001309 1.004155 1.002888   7.759277e-44  -2.462888e-32
40  1.001309 1.004155 1.002888  -3.673978e-45   1.165155e-33
41  1.001309 1.004155 1.002888  -3.849241e-45   1.221703e-33
42  1.001309 1.004155 1.002888  -1.870936e-46   5.942294e-35
43  1.001309 1.004155 1.002888   1.570453e-46  -4.984047e-35
44  1.001309 1.004155 1.002888   2.288576e-47  -7.265202e-36
45  1.001309 1.004155 1.002888  -5.007029e-48   1.588857e-36
46  1.001309 1.004155 1.002888  -1.495513e-48   4.746986e-37
47  1.001309 1.004155 1.002888   8.932785e-50  -2.833363e-38
48  1.001309 1.004155 1.002888   7.588967e-50  -2.408666e-38
49  1.001309 1.004155 1.002888   2.924016e-51  -9.288778e-40
50  1.001309 1.004155 1.002888  -3.166423e-51   1.004917e-39
51  1.001309 1.004155 1.002888  -4.230406e-52   1.342994e-40
52  1.001309 1.004155 1.002888   1.044788e-52  -3.315438e-41
53  1.001309 1.004155 1.002888   2.873912e-53  -9.122326e-42
54  1.001309 1.004155 1.002888  -2.090428e-54   6.631277e-43
55  1.001309 1.004155 1.002888  -1.492683e-54   4.737672e-43
56  1.001309 1.004155 1.002888  -4.242142e-56   1.348054e-44
57  1.001309 1.004155 1.002888   6.366622e-56  -2.020572e-44
58  1.001309 1.004155 1.002888   7.764974e-57  -2.465148e-45
59  1.001309 1.004155 1.002888  -2.168746e-57   6.882221e-46
60  1.001309 1.004155 1.002888  -5.505561e-58   1.747586e-46
61  1.001309 1.004155 1.002888   4.761600e-59  -1.510598e-47
62  1.001309 1.004155 1.002888   2.916646e-59  -9.257523e-48
63  1.001309 1.004155 1.002888   3.425088e-62  -1.244233e-50
64  1.001309 1.004155 1.002888   4.022162e-65  -1.668873e-53
65  1.001309 1.004155 1.002888   4.723322e-68  -2.238429e-56
66  1.001309 1.004155 1.002888   5.546710e-71  -3.002363e-59
67  1.001309 1.004155 1.002888   6.513635e-74  -4.027013e-62
68  1.001309 1.004155 1.002888   7.649117e-77  -5.401358e-65
69  1.001309 1.004155 1.002888   8.982542e-80  -7.244740e-68
70  1.001309 1.004155 1.002888   1.054841e-82  -9.717235e-71
71  1.001309 1.004155 1.002888   1.238726e-85  -1.303355e-73
72  1.001309 1.004155 1.002888   1.454665e-88  -1.748165e-76
73  1.001309 1.004155 1.002888   1.708248e-91  -2.344781e-79
74  1.001309 1.004155 1.002888   2.006037e-94  -3.145012e-82
75  1.001309 1.004155 1.002888   2.355737e-97  -4.218345e-85
76  1.001309 1.004155 1.002888  2.766399e-100  -5.657988e-88
77  1.001309 1.004155 1.002888  3.248648e-103  -7.588953e-91
78  1.001309 1.004155 1.002888  3.814965e-106  -1.017892e-93
79  1.001309 1.004155 1.002888  4.480005e-109  -1.365280e-96
80  1.001309 1.004155 1.002888  5.260978e-112  -1.831224e-99
81  1.001309 1.004155 1.002888  6.178092e-115 -2.456187e-102
82  1.001309 1.004155 1.002888  7.255082e-118 -3.294438e-105
83  1.001309 1.004155 1.002888  8.519816e-121 -4.418768e-108
84  1.001309 1.004155 1.002888  1.000502e-123 -5.926811e-111
85  1.001309 1.004155 1.002888  1.174914e-126 -7.949521e-114
86  1.001309 1.004155 1.002888  1.379730e-129 -1.066254e-116
87  1.001309 1.004155 1.002888  1.620250e-132 -1.430147e-119
88  1.001309 1.004155 1.002888  1.902698e-135 -1.918230e-122
89  1.001309 1.004155 1.002888  2.234384e-138 -2.572886e-125
90  1.001309 1.004155 1.002888  2.623891e-141 -3.450964e-128
91  1.001309 1.004155 1.002888  3.081298e-144 -4.628713e-131
92  1.001309 1.004155 1.002888  3.618442e-147 -6.208406e-134
93  1.001309 1.004155 1.002888  4.249223e-150 -8.327220e-137
94  1.001309 1.004155 1.002888  4.989964e-153 -1.116914e-139
95  1.001309 1.004155 1.002888  5.859835e-156 -1.498097e-142
96  1.001309 1.004155 1.002888  6.881345e-159 -2.009369e-145
97  1.001309 1.004155 1.002888  8.080928e-162 -2.695129e-148
98  1.001309 1.004155 1.002888  9.489627e-165 -3.614926e-151
99  1.001309 1.004155 1.002888  1.114390e-167 -4.848633e-154
100 1.001309 1.004155 1.002888  1.308655e-170 -6.503381e-157
101 1.001309 1.004155 1.002888  1.536784e-173 -8.722864e-160</code></pre>
<pre class="r"><code># plot
n_strains &lt;- length(state$x)
plot(outc, xlab = &quot;time&quot;, ylab = &quot;&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-3-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot(outc, xlab=&quot;Time (hr)&quot;, ylab=c(rep(&quot;Biomass (OD)&quot;,n_strains),&quot;Nitrate NO3- (mM)&quot;,&quot;Nitrite NO2- (mM)&quot;), col=&#39;black&#39;, type = &quot;l&quot;,lty = 1, pch=19,lwd=1, main=&quot;Consumer Resource model&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-3-4.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-3-5.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># using ggplot to get 3 graphs
colnames(outc)</code></pre>
<pre><code> [1] &quot;time&quot; &quot;x1&quot;   &quot;x2&quot;   &quot;x3&quot;   &quot;x4&quot;   &quot;x5&quot;   &quot;x6&quot;   &quot;x7&quot;   &quot;x8&quot;   &quot;x9&quot;  
[11] &quot;x10&quot;  &quot;A&quot;    &quot;I&quot;   </code></pre>
<pre class="r"><code>class(outc)</code></pre>
<pre><code>[1] &quot;deSolve&quot; &quot;matrix&quot; </code></pre>
<pre class="r"><code>df_out &lt;- as.data.frame(outc)
head(df_out)</code></pre>
<pre><code>  time       x1       x2       x3       x4       x5       x6       x7       x8
1  0.0 1.000000 1.000000 1.000000 1.000000 1.000000 1.000000 1.000000 1.000000
2  0.1 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432 1.001309
3  0.2 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432 1.001309
4  0.3 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432 1.001309
5  0.4 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432 1.001309
6  0.5 1.003544 1.001748 1.005644 1.006124 1.004573 1.002005 1.004432 1.001309
        x9      x10             A             I
1 1.000000 1.000000  2.000000e+00  0.000000e+00
2 1.004155 1.002888  7.486725e-19 -1.630817e-07
3 1.004155 1.002888 -5.145732e-20  1.641853e-08
4 1.004155 1.002888 -2.800363e-20  8.892873e-09
5 1.004155 1.002888 -2.299140e-22  7.329550e-11
6 1.004155 1.002888  1.247024e-21 -3.957657e-10</code></pre>
<pre class="r"><code>df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;))
dim(df_out)</code></pre>
<pre><code>[1] 1212    3</code></pre>
<pre class="r"><code>df_com &lt;- df_out %&gt;% filter(!(variable %in% c(&quot;A&quot;,&quot;I&quot;)))
dim(df_com)</code></pre>
<pre><code>[1] 1010    3</code></pre>
<pre class="r"><code>tail(df_com)</code></pre>
<pre><code>     time variable    value
1005  9.5      x10 1.002888
1006  9.6      x10 1.002888
1007  9.7      x10 1.002888
1008  9.8      x10 1.002888
1009  9.9      x10 1.002888
1010 10.0      x10 1.002888</code></pre>
<pre class="r"><code>df_ai &lt;- df_out %&gt;% filter(variable %in% c(&quot;A&quot;,&quot;I&quot;))
dim(df_ai)</code></pre>
<pre><code>[1] 202   3</code></pre>
<pre class="r"><code># plot strain dynamics
names(df_com)[2] &lt;- &quot;Strain&quot; 

p_strain &lt;- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  # scale_color_manual(values=grad_pH) +
  ylab(&quot;Biomass (OD) \n&quot;) +
  xlab(&quot;\n Time (hr)&quot;) +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  # expand_limits(y=0) +
  ggtitle(&quot;Consumer-resource model community dynamics \n&quot;) +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))

p_strain

# plot nitrate, nitrite
names(df_ai)[2] &lt;- &quot;Metabolite&quot;
df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)

df_ai$Metabolite</code></pre>
<pre><code>  [1] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
  [5] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
  [9] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [13] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [17] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [21] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [25] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [29] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [33] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [37] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [41] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [45] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [49] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [53] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [57] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [61] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [65] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [69] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [73] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [77] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [81] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [85] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [89] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [93] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
 [97] &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot; &quot;Nitrate (NO3-)&quot;
[101] &quot;Nitrate (NO3-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[105] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[109] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[113] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[117] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[121] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[125] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[129] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[133] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[137] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[141] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[145] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[149] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[153] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[157] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[161] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[165] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[169] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[173] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[177] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[181] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[185] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[189] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[193] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[197] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;
[201] &quot;Nitrite (NO2-)&quot; &quot;Nitrite (NO2-)&quot;</code></pre>
<pre class="r"><code>p_ai &lt;- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  scale_color_manual(values=c(&quot;#3958ab&quot;,&quot;#ad4620&quot;)) + ## blue = nitrate, red = nitrite
  ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
  xlab(&quot;\n Time (hr)&quot;) +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  # expand_limits(y=0) +
  ggtitle(&quot;Metabolite dynamics \n&quot;) +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
p_ai

df_i &lt;- df_ai %&gt;% filter(Metabolite == &quot;Nitrite (NO2-)&quot;)
p_nitrite &lt;- ggplot(df_i, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  scale_color_manual(values=c(&quot;#ad4620&quot;)) + ## blue = nitrate, red = nitrite
  ylab(&quot;Nitrite (mM) \n&quot;) +
  xlab(&quot;\n Time (hr)&quot;) +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  # expand_limits(y=0) +
  ggtitle(&quot;Nitrite close-up dynamics \n&quot;) +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
p_nitrite

require(gridExtra)
grid.arrange(p_strain, p_ai, p_nitrite, nrow=1)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-3-6.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="wrap-this-into-a-function" class="section level2">
<h2>1.4. Wrap this into a function</h2>
<pre class="r"><code># plot community dynamics, metabolite, nitrite close up

## as in Karna&#39;s paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna&#39;s paper)
## rI, rA max is 15 (from Karna&#39;s paper)
k = 10 # number of strains in a community
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(1,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))

plot_3results &lt;- function(time = 10, time_by = 0.01,  parameters, state){
  # ODE solver
  times &lt;- seq(0, time, by = time_by)
  outc &lt;- ode(unlist(state), times, crGrowth, parameters, method = &quot;vode&quot;, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out &lt;- as.data.frame(outc)
  head(df_out)
  df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;))
  dim(df_out)
  df_com &lt;- df_out %&gt;% filter(!(variable %in% c(&quot;A&quot;,&quot;I&quot;)))
  dim(df_com)
  tail(df_com)
  df_ai &lt;- df_out %&gt;% filter(variable %in% c(&quot;A&quot;,&quot;I&quot;))
  dim(df_ai)
  
  # plot strain dynamics
  names(df_com)[2] &lt;- &quot;Strain&quot; 
  
  p_strain &lt;- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=grad_pH) +
    ylab(&quot;Biomass (OD) \n&quot;) +
    xlab(&quot;\n Time (hr)&quot;) +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(&quot;Consumer-resource model community dynamics \n&quot;) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
  # p_strain
  
  # plot nitrate, nitrite
  names(df_ai)[2] &lt;- &quot;Metabolite&quot;
  df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
  
  p_ai &lt;- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c(&quot;#3958ab&quot;,&quot;#ad4620&quot;)) + ## blue = nitrate, red = nitrite
    ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
    xlab(&quot;\n Time (hr)&quot;) +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(&quot;Metabolite dynamics \n&quot;) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
  # p_ai
  
  df_i &lt;- df_ai %&gt;% filter(Metabolite == &quot;Nitrite (NO2-)&quot;)
  p_nitrite &lt;- ggplot(df_i, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c(&quot;#ad4620&quot;)) + ## blue = nitrate, red = nitrite
    ylab(&quot;Nitrite (mM) \n&quot;) +
    xlab(&quot;\n Time (hr)&quot;) +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(&quot;Nitrite close-up dynamics \n&quot;) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
  # p_nitrite
  
  require(gridExtra)
  return(grid.arrange(p_strain, p_ai, p_nitrite, nrow=1))
}

plot_2results &lt;- function(title, time = 10, time_by = 0.01, ode_method = &quot;vode&quot;, parameters, state){
  # ODE solver
  times &lt;- seq(0, time, by = time_by)
  outc &lt;- ode(unlist(state), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out &lt;- as.data.frame(outc)
  head(df_out)
  df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;))
  dim(df_out)
  df_com &lt;- df_out %&gt;% filter(!(variable %in% c(&quot;A&quot;,&quot;I&quot;)))
  dim(df_com)
  tail(df_com)
  df_ai &lt;- df_out %&gt;% filter(variable %in% c(&quot;A&quot;,&quot;I&quot;))
  dim(df_ai)
  
  # plot strain dynamics
  names(df_com)[2] &lt;- &quot;Strain&quot; 
  
  p_strain &lt;- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=grad_pH) +
    ylab(&quot;Biomass (OD) \n&quot;) +
    xlab(&quot;\n Time (hr)&quot;) +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(paste0(title,&quot; \n&quot;)) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
  # p_strain
  
  # plot nitrate, nitrite
  names(df_ai)[2] &lt;- &quot;Metabolite&quot;
  df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
  df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)
  
  p_ai &lt;- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c(&quot;#3958ab&quot;,&quot;#ad4620&quot;)) + ## blue = nitrate, red = nitrite
    ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
    xlab(&quot;\n Time (hr)&quot;) +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(&quot;Metabolite dynamics \n&quot;) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
  require(gridExtra)
  return(grid.arrange(p_strain, p_ai, nrow=1))
}

plot_community &lt;- function(time = 10, time_by = 0.01, ode_method = &quot;vode&quot;, parameters, state, title){
  # ODE solver
  times &lt;- seq(0, time, by = time_by)
  outc &lt;- ode(unlist(state), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out &lt;- as.data.frame(outc)
  head(df_out)
  df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;))
  dim(df_out)
  df_com &lt;- df_out %&gt;% filter(!(variable %in% c(&quot;A&quot;,&quot;I&quot;)))
  dim(df_com)
  tail(df_com)
  df_ai &lt;- df_out %&gt;% filter(variable %in% c(&quot;A&quot;,&quot;I&quot;))
  dim(df_ai)
  
  # plot strain dynamics
  names(df_com)[2] &lt;- &quot;Strain&quot; 
  
  p_strain &lt;- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=grad_pH) +
    ylab(&quot;Biomass (OD) \n&quot;) +
    xlab(&quot;\n Time (hr)&quot;) +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(paste0(title)) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
  # p_strain
  return(p_strain)
}

plot_metabolite &lt;- function(time = 10, time_by = 0.01, ode_method = &quot;vode&quot;, parameters, state, title){
  # ODE solver
  times &lt;- seq(0, time, by = time_by)
  outc &lt;- ode(unlist(state), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out &lt;- as.data.frame(outc)
  head(df_out)
  df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;))
  dim(df_out)
  df_com &lt;- df_out %&gt;% filter(!(variable %in% c(&quot;A&quot;,&quot;I&quot;)))
  dim(df_com)
  tail(df_com)
  df_ai &lt;- df_out %&gt;% filter(variable %in% c(&quot;A&quot;,&quot;I&quot;))
  dim(df_ai)
  
  # plot nitrate, nitrite
  names(df_ai)[2] &lt;- &quot;Metabolite&quot;
  df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
  df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)
  
  p_ai &lt;- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c(&quot;#3958ab&quot;,&quot;#ad4620&quot;)) + ## blue = nitrate, red = nitrite
    ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
    xlab(&quot;\n Time (hr)&quot;) +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(title) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&quot;serif&quot;, show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour=&quot;black&quot;, fill=&quot;white&quot;, size=0.1))
  return(p_ai)
}

## testing if the function works
## as in Karna&#39;s paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna&#39;s paper)
## rI, rA max is 15 (from Karna&#39;s paper)
k = 10 # number of strains in a community
set.seed(2)
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.01,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = &quot;Consumer resource model: uniformly sampled model parameters&quot;,time = 30, time_by= 0.01,  parameters=parameters, state=state)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-4-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>k = 10 # number of strains in a community
set.seed(2)
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.1,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = &quot;Consumer resource model: uniformly sampled model parameters&quot;,time = 30, time_by= 0.01,  parameters=parameters, state=state)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-4-2.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="why-is-the-time-scale-so-fast" class="section level2">
<h2>1.5. Why is the time scale so fast?</h2>
<pre class="r"><code>k = 3  # number of strains in a community
parameters = list(gamI = runif(k, 0, 0.02), rI = runif(k, 0, 15), gamA = runif(k,
    0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(1e-04, k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = &quot;Consumer resource model&quot;, time = 50, time_by = 0.01, parameters = parameters,
    state = state, ode_method = &quot;ode45&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-5-1.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="lets-import-karna-sdmsuccinate-defined-media-and-plot-those-dynamics" class="section level2">
<h2>1.6. Let’s import Karna SDM(succinate defined media) and plot those dynamics</h2>
<pre class="r"><code>df_karna &lt;- read.csv(&quot;data/consumer_resource_parameters_SDM.csv&quot;)  # succinate defined media 
names(df_karna)[1] &lt;- &quot;Strain&quot;

head(df_karna)</code></pre>
<pre><code>  Strain rA_mM.OD.h gamA_OD.mM rI_mM.OD.h gamI_OD.mM
1  ACM01   5.897555 0.02442641   2.924547 0.01878696
2  ACM02   6.939172 0.02162215   2.721175 0.01136920
3  ACM03   6.898489 0.01963414   3.152465 0.01429434
4  ACM04   5.530593 0.02029729   2.738106 0.02088657
5  ACM05   6.063978 0.01199931   1.677104 0.01781786
6  ACV01   8.786990 0.01111173   0.000000 0.00000000</code></pre>
<pre class="r"><code>df_karna[1, ]</code></pre>
<pre><code>  Strain rA_mM.OD.h gamA_OD.mM rI_mM.OD.h gamI_OD.mM
1  ACM01   5.897555 0.02442641   2.924547 0.01878696</code></pre>
<pre class="r"><code>parameters = c(rA = df_karna[1, 2], gamA = df_karna[1, 3], rI = df_karna[1, 4], gamI = df_karna[1,
    5], kI = 0.01, kA = 0.01)
state = list(x = 0.01, A = 2, I = 0)
plot_2results(title = &quot;Consumer resource model (1 strain: ACM01)&quot;, time = 30, time_by = 0.01,
    parameters = parameters, state = state)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-6-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Another strain
head(df_karna)</code></pre>
<pre><code>  Strain rA_mM.OD.h gamA_OD.mM rI_mM.OD.h gamI_OD.mM
1  ACM01   5.897555 0.02442641   2.924547 0.01878696
2  ACM02   6.939172 0.02162215   2.721175 0.01136920
3  ACM03   6.898489 0.01963414   3.152465 0.01429434
4  ACM04   5.530593 0.02029729   2.738106 0.02088657
5  ACM05   6.063978 0.01199931   1.677104 0.01781786
6  ACV01   8.786990 0.01111173   0.000000 0.00000000</code></pre>
<pre class="r"><code>df_karna[1, ]</code></pre>
<pre><code>  Strain rA_mM.OD.h gamA_OD.mM rI_mM.OD.h gamI_OD.mM
1  ACM01   5.897555 0.02442641   2.924547 0.01878696</code></pre>
<pre class="r"><code>strain_i = 2
parameters = c(rA = df_karna[strain_i, 2], gamA = df_karna[strain_i, 3], rI = df_karna[strain_i,
    4], gamI = df_karna[strain_i, 5], kI = 0.01, kA = 0.01)
state = list(x = 0.01, A = 2, I = 0)
plot_2results(title = paste0(&quot;Consumer resource model (1 strain:&quot;, df_karna[strain_i,
    1], &quot;)&quot;), time = 30, time_by = 0.01, parameters = parameters, state = state)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-6-2.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="validate-with-2-strain-community" class="section level2">
<h2>1.7. Validate with 2 strain community</h2>
<p>There is sth wrong with my ode function</p>
<pre class="r"><code># 2 strain
head(df_karna)</code></pre>
<pre><code>  Strain rA_mM.OD.h gamA_OD.mM rI_mM.OD.h gamI_OD.mM
1  ACM01   5.897555 0.02442641   2.924547 0.01878696
2  ACM02   6.939172 0.02162215   2.721175 0.01136920
3  ACM03   6.898489 0.01963414   3.152465 0.01429434
4  ACM04   5.530593 0.02029729   2.738106 0.02088657
5  ACM05   6.063978 0.01199931   1.677104 0.01781786
6  ACV01   8.786990 0.01111173   0.000000 0.00000000</code></pre>
<pre class="r"><code>df_2strain &lt;- df_karna %&gt;%
    filter(Strain %in% c(&quot;ACV02&quot;, &quot;AGB01&quot;))

k = 2
vec_strain = 1:k
parameters = list(rA = df_2strain[vec_strain, 2], gamA = df_2strain[vec_strain, 3],
    rI = df_2strain[vec_strain, 4], gamI = df_2strain[vec_strain, 5], kI = rep(0.01,
        k), kA = rep(0.01, k))
state = list(x = c(0.01, 0.01), A = 2, I = 0)
plot_2results(title = paste0(&quot;Consumer resource model (2 strain:&quot;, df_2strain[1,
    1], &quot;+&quot;, df_2strain[2, 1], &quot;)&quot;), time = 72, time_by = 0.01, parameters = parameters,
    state = state, ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-7-1.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="strains-from-real-data" class="section level2">
<h2>1.8. 10 strains from real data</h2>
<pre class="r"><code>head(df_karna)</code></pre>
<pre><code>  Strain rA_mM.OD.h gamA_OD.mM rI_mM.OD.h gamI_OD.mM
1  ACM01   5.897555 0.02442641   2.924547 0.01878696
2  ACM02   6.939172 0.02162215   2.721175 0.01136920
3  ACM03   6.898489 0.01963414   3.152465 0.01429434
4  ACM04   5.530593 0.02029729   2.738106 0.02088657
5  ACM05   6.063978 0.01199931   1.677104 0.01781786
6  ACV01   8.786990 0.01111173   0.000000 0.00000000</code></pre>
<pre class="r"><code>dim(df_karna)</code></pre>
<pre><code>[1] 79  5</code></pre>
<pre class="r"><code># randomly pick k=10 strains
k = 10
set.seed(1)
vec_strain = sample(1:nrow(df_karna), k, replace = F)

parameters = list(rA = df_karna[vec_strain, 2], gamA = df_karna[vec_strain, 3], rI = df_karna[vec_strain,
    4], gamI = df_karna[vec_strain, 5], kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Consumer resource model (&quot;, k, &quot; Karna strains)&quot;),
    time = 30, time_by = 0.01, parameters = parameters, state = state)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-8-1.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="strains-from-real-data-parameters" class="section level2">
<h2>1.9. 5 strains from real data parameters</h2>
<pre class="r"><code>head(df_karna)</code></pre>
<pre><code>  Strain rA_mM.OD.h gamA_OD.mM rI_mM.OD.h gamI_OD.mM
1  ACM01   5.897555 0.02442641   2.924547 0.01878696
2  ACM02   6.939172 0.02162215   2.721175 0.01136920
3  ACM03   6.898489 0.01963414   3.152465 0.01429434
4  ACM04   5.530593 0.02029729   2.738106 0.02088657
5  ACM05   6.063978 0.01199931   1.677104 0.01781786
6  ACV01   8.786990 0.01111173   0.000000 0.00000000</code></pre>
<pre class="r"><code>dim(df_karna)</code></pre>
<pre><code>[1] 79  5</code></pre>
<pre class="r"><code># randomly pick k=10 strains
k = 5
set.seed(1)
vec_strain = sample(1:nrow(df_karna), k, replace = F)

parameters = list(rA = df_karna[vec_strain, 2], gamA = df_karna[vec_strain, 3], rI = df_karna[vec_strain,
    4], gamI = df_karna[vec_strain, 5], kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Consumer resource model (&quot;, k, &quot; Karna strains)&quot;),
    time = 30, time_by = 0.01, parameters = parameters, state = state)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-9-1.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="strains-from-randomly-sampled-parameters" class="section level2">
<h2>1.10. 5 strains from randomly sampled parameters</h2>
<pre class="r"><code>k = 5  # number of strains in a community
set.seed(2)
parameters = list(gamI = runif(k, 0, 0.02), rI = runif(k, 0, 15), gamA = runif(k,
    0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.01, k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = &quot;Consumer resource model: uniformly sampled model parameters&quot;,
    time = 30, time_by = 0.01, parameters = parameters, state = state)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-10-1.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="now-simulate-ph-perturbation" class="section level2">
<h2>2. Now simulate pH perturbation</h2>
<ol style="list-style-type: decimal">
<li>First, simulate rI_i dependent on pH (gaussian distribution of mean = opt_pH)</li>
<li>Second, construct soil community of pH 7, where relative abundance of strains with opt_pH is high.</li>
<li>Third, perturb the pH and see how it changes.</li>
</ol>
</div>
<div id="first-step-simulate-ri_i-dependent-on-ph" class="section level2">
<h2>2.1. First step: simulate rI_i dependent on pH</h2>
<pre class="r"><code># Constructing Gaussian function
par(mfrow = c(1, 1))
hist(rnorm(1000, mean = 7, sd = 1))</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-11-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># function
gaussian_function &lt;- function(x, std, mean, max_height = 0.3989423) {
    factor = max_height * std * sqrt(2 * pi)
    return(factor * (1/(std * sqrt(2 * pi))) * exp((-0.5) * ((x - mean)/std)^2))
}

# gaussian function
x &lt;- seq(-3, 3, by = 0.01)
plot(x, gaussian_function(x, mean = 0, std = 1))</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-11-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># rI_i
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = 7, std = 2, max_height = 15), xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;,
    main = &quot;Gaussian distribution of rI parameter of strain with opt_pH = 7&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-11-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># simulate many rI_i
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = 7, std = 2, max_height = 15), xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;,
    main = &quot;Simulating rI parameter of strain with various opt_pH&quot;)

rand_pH &lt;- runif(1000, 0, 14)
for (i in rand_pH) {
    lines(x, gaussian_function(x, mean = i, std = 2, max_height = 15))
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-11-4.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## Create a soil sample with pH = 7
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = 7, std = 1), xlab = &quot;optimal_pH of strains&quot;,
    ylab = &quot;Relative abundance of strains&quot;, col = &quot;black&quot;, type = &quot;l&quot;, lty = 1, pch = 19,
    lwd = 1, main = &quot;Relative abundance of stains with optimal pH values (Soil native pH = 7)&quot;)
abline(v = 7, lty = 3, col = &quot;blue&quot;)
abline(v = 6, lty = 3, col = &quot;red&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-11-5.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## 100 strains, standard deviation 2
set.seed(1)
vec_opt_pH &lt;- rnorm(100, mean = 7, sd = 3)
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-11-6.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rI
x &lt;- seq(0, 14, by = 0.01)
start &lt;- vec_opt_pH[1]
plot(x, gaussian_function(x, mean = start, std = 2, max_height = 15), xlab = &quot;pH&quot;,
    ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1, main = &quot;Simulating rI parameter of strains in soil of pH = 7&quot;)

for (i in vec_opt_pH[2:length(vec_opt_pH)]) {
    lines(x, gaussian_function(x, mean = i, std = 2, max_height = 15), col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-11-7.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="dynamics-of-soil-ph-at-7" class="section level2">
<h2>2.1.1. Dynamics of soil pH at 7</h2>
<ul>
<li>This is a 100 strain community in a soil of original pH 7<br />
</li>
<li>Scenario 1: only rI is influenced by pH</li>
</ul>
<pre class="r"><code>## rI when current pH is 7
vec_rI = gaussian_function(x = 7, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at natural state, pH=7&quot;), time = 30,
    time_by = 0.01, parameters = parameters, state = state, ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-12-1.png" width="1056" style="display: block; margin: auto;" /> Need to find a sweet spot… uses up nitrate too fast…</p>
</div>
<div id="perturb-the-ph-to-6-and-so-on" class="section level2">
<h2>2.1.2. Perturb the pH to 6 and so on</h2>
<pre class="r"><code>## when we perturb the pH plot rI
par(mfrow = c(1, 1))
x &lt;- seq(0, 14, by = 0.01)
start &lt;- vec_opt_pH[1]
plot(x, gaussian_function(x, mean = start, std = 2, max_height = 15), xlab = &quot;pH&quot;,
    ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1, main = &quot;Simulating rI parameter of strains in soil of pH = 7&quot;)

for (i in vec_opt_pH[2:length(vec_opt_pH)]) {
    lines(x, gaussian_function(x, mean = i, std = 2, max_height = 15), col = &quot;blue&quot;)
}
abline(v = 7, lty = 3, col = &quot;blue&quot;)
abline(v = 6, lty = 3, col = &quot;red&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## rI at perturbed to pH 6
current_pH = 6
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH6&quot;),
    time = 30, time_by = 0.01, parameters = parameters, state = state, ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## rI at perturbed to pH 5
current_pH = 5
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH &quot;,
    current_pH), time = 30, time_by = 0.01, parameters = parameters, state = state,
    ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## rI at perturbed to pH 4
current_pH = 4
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH &quot;,
    current_pH), time = 30, time_by = 0.01, parameters = parameters, state = state,
    ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-4.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## rI at perturbed to pH 3
current_pH = 3
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH &quot;,
    current_pH), time = 30, time_by = 0.01, parameters = parameters, state = state,
    ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-5.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## basic rI at perturbed to pH 8
current_pH = 8
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH &quot;,
    current_pH), time = 30, time_by = 0.01, parameters = parameters, state = state,
    ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-6.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## rI at perturbed to pH 9
current_pH = 9
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH &quot;,
    current_pH), time = 30, time_by = 0.01, parameters = parameters, state = state,
    ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-7.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## rI at perturbed to pH 10
current_pH = 10
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH &quot;,
    current_pH), time = 30, time_by = 0.01, parameters = parameters, state = state,
    ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-8.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## rI at perturbed to pH 11
current_pH = 11
vec_rI = gaussian_function(x = current_pH, mean = vec_opt_pH, std = 2, max_height = 15)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;Community dynamics at perturbed from pH 7 to pH &quot;,
    current_pH), time = 30, time_by = 0.01, parameters = parameters, state = state,
    ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-13-9.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="let-me-tune-the-parameters-so-i-get-slower-dynamics" class="section level2">
<h2>2.1.3. Let me tune the parameters so I get slower dynamics</h2>
<pre class="r"><code>## 100 strains, standard deviation 2
set.seed(1)
k = 100  # number of strains in a community
vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-14-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI &lt;- runif(k, 0, 15)

# plot rI
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = 2, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = &quot;Simulating rI parameter of strains in soil of pH = 7&quot;, ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = 2, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-14-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot dynamics rI when current pH is 7
vec_rI = gaussian_function(x = 7, mean = vec_opt_pH, std = 2, max_height = vec_max_rI)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
set.seed(31)
parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01, k), A = 2, I = 0)
set.seed(31)
plot_2results(title = paste0(&quot;Community dynamics at natural state, pH=7&quot;), time = 2,
    time_by = 0.01, parameters = parameters, state = state, ode_method = &quot;vode&quot;)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-14-3.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="lets-correlate-ra-also-with-ph" class="section level2">
<h2>2.1.4. Let’s correlate rA also with pH</h2>
<pre class="r"><code>dev.off()</code></pre>
<pre><code>null device 
          1 </code></pre>
<pre class="r"><code># function
gaussian_function &lt;- function(x, std, mean, max_height = 0.3989423) {
    factor = max_height * std * sqrt(2 * pi)
    return(factor * (1/(std * sqrt(2 * pi))) * exp((-0.5) * ((x - mean)/std)^2))
}

## 100 strains, standard deviation 2
set.seed(1)
k = 100  # number of strains in a community
vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;)


# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI &lt;- runif(k, 0, 15)
vec_max_rA &lt;- runif(k, 0, 15)


# plot rI
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = 2, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = &quot;Simulating rI parameter of strains in soil of pH = 7&quot;, ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = 2, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}

# plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = 2, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = &quot;Simulating rA parameter of strains in soil of pH = 7&quot;, ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = 2, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}

# plot dynamics rI when current pH is 7
vec_rI = gaussian_function(x = 7, mean = vec_opt_pH, std = 2, max_height = vec_max_rI)
length(vec_rI)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>vec_rA = gaussian_function(x = 7, mean = vec_opt_pH, std = 2, max_height = vec_max_rA)
length(vec_rA)</code></pre>
<pre><code>[1] 100</code></pre>
<pre class="r"><code>k = 100
parameter_1 = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0, 0.02),
    rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state_1 = list(x = rep(0.01, k), A = 2, I = 0)
plot_2results(title = paste0(&quot;[rI &amp; rA] Community dynamics at natural state, pH=7&quot;),
    time = 2, time_by = 0.01, parameters = parameter_1, state = state_1, ode_method = &quot;vode&quot;)</code></pre>
</div>
<div id="plot-the-perturbation-levels-with-simulation" class="section level2">
<h2>2.1.5. Plot the perturbation levels with simulation</h2>
<pre class="r"><code>plot_perturbation &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1,
    1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;), title, time = 10, time_by = 0.01,
    ode_method = &quot;vode&quot;) {
    # ODE solver
    k = length(vec_opt_pH)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)
    set.seed(4)
    parameter_1 = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0,
        0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = rep(0.01, k), A = 2, I = 0)

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        set.seed(4)
        parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k,
            0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = rep(0.01, k), A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    # pH color
    col_pH &lt;- colorRampPalette(c(&quot;purple&quot;, &quot;red&quot;, &quot;gold&quot;))

    library(colorRamps)
    df_ai %&gt;%
        select(Metabolite) %&gt;%
        unique()
    df_ai %&gt;%
        select(pH) %&gt;%
        unique()

    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + ggplot(df_ai,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + aes(x
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + time,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + y
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + value,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + color
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + group
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH))
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + #
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + geom_point(size=2.5,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + shape=16)
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite geom_line(size
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite 1.2)
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite #
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_colour_gradientn(colours
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite col_pH(100))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite ##
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite blue
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrate,
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite red
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrite
    scale_colour_gradientn(colours = col_pH(100)) + ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
        xlab(&quot;\n Time (hr)&quot;) + scale_y_continuous(breaks = seq(0, 2, 0.25), limits = c(0,
        2)) + # expand_limits(y=0) + 2)) + # expand_limits(y=0) +
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ ggtitle(paste0(title,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ &quot;
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ \n&quot;))
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ +
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ #
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ label
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ geom_text(aes(label
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ round(Ave_NO3_mM,3)),
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ size
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ 3,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ vjust
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ -1.5,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ family=&#39;serif&#39;,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    mytheme_2d + facet_grid(. ~ Metabolite) + theme(strip.background = element_rect(colour = &quot;black&quot;,
        fill = &quot;white&quot;, size = 0.1))
}

# A &amp; I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1,
    1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;), title = &quot;pH perturbation simulation&quot;,
    time = 10, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 3
[1] 4
[1] 5
[1] 6
[1] 8
[1] 9
[1] 10
[1] &quot;removing dynamics of pH: 9&quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code># A
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1,
    1:3), gauss_std = 3, vec_met = c(&quot;A&quot;), title = &quot;pH perturbation simulation (n=100)&quot;,
    time = 1, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 3
[1] 4
[1] 5
[1] 6
[1] 8
[1] 9
[1] 10
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code># I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1,
    1:3), gauss_std = 3, vec_met = c(&quot;I&quot;), title = &quot;pH perturbation simulation (n=100)&quot;,
    time = 1, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 3
[1] 4
[1] 5
[1] 6
[1] 8
[1] 9
[1] 10
[1] &quot;removing dynamics of pH: 9&quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code>## how about writing a function that removes runs that have a burst in nitrite?

plot_perturbation &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1,
    1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;), title, time = 10, time_by = 0.01,
    ode_method = &quot;vode&quot;) {
    # ODE solver
    k = length(vec_opt_pH)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)
    set.seed(4)
    parameter_1 = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0,
        0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = rep(0.01, k), A = 2, I = 0)

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        set.seed(4)
        parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k,
            0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = rep(0.01, k), A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    # pH color
    col_pH &lt;- colorRampPalette(c(&quot;purple&quot;, &quot;red&quot;, &quot;gold&quot;))

    library(colorRamps)
    df_ai %&gt;%
        select(Metabolite) %&gt;%
        unique()
    df_ai %&gt;%
        select(pH) %&gt;%
        unique()

    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + ggplot(df_ai,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + aes(x
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + time,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + y
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + value,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + color
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + group
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH))
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + #
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + geom_point(size=2.5,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + shape=16)
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite geom_line(size
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite 1.2)
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite #
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_colour_gradientn(colours
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite col_pH(100))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite ##
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite blue
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrate,
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite red
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrite
    scale_colour_gradientn(colours = col_pH(100)) + ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
        xlab(&quot;\n Time (hr)&quot;) + scale_y_continuous(breaks = seq(0, 2, 0.25), limits = c(0,
        2)) + # expand_limits(y=0) + 2)) + # expand_limits(y=0) +
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ ggtitle(paste0(title,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ &quot;
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ \n&quot;))
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ +
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ #
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ label
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ geom_text(aes(label
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ round(Ave_NO3_mM,3)),
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ size
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ 3,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ vjust
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ -1.5,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ family=&#39;serif&#39;,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    mytheme_2d + facet_grid(. ~ Metabolite) + theme(strip.background = element_rect(colour = &quot;black&quot;,
        fill = &quot;white&quot;, size = 0.1))
}

plot_perturbation_auc &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7,
    pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;), title, time = 10,
    time_by = 0.01, ode_method = &quot;vode&quot;, annotate_x, annotate_y) {
    # ODE solver
    k = length(vec_opt_pH)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)
    set.seed(4)
    parameter_1 = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0,
        0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = rep(0.01, k), A = 2, I = 0)

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        set.seed(4)
        parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k,
            0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = rep(0.01, k), A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    require(pracma)
    df_a &lt;- df_ai %&gt;%
        filter(Metabolite == &quot;Nitrate (NO3-)&quot;)
    colnames(df_a)
    df_corr &lt;- df_a %&gt;%
        group_by(pH) %&gt;%
        summarize(auc = trapz(time, value)) %&gt;%
        ungroup()

    plot(df_corr$pH, df_corr$auc)

    df_corr$pH_2 &lt;- (df_corr$pH)^2
    fit.no3 &lt;- lm(auc ~ pH + pH_2, df_corr)
    summary(fit.no3)

    perturbpH &lt;- seq(2, 13, 0.1)
    aucPredict &lt;- predict(fit.no3, list(pH = perturbpH, pH_2 = perturbpH^2))
    df_auc_quad &lt;- data.frame(pH = perturbpH, Time_hours = aucPredict)
    plot(perturbpH, aucPredict)

    # (1) Plot fitted linear regression line
    ggplot(df_corr, aes(x = pH, y = auc)) + geom_point(size = 2.5, shape = 16, color = &quot;brown&quot;) +
        # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +
        # geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM),
        # width=.05)+ scale_color_brewer(palette=&#39;Set2&#39;) +
        # scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ xlab(&quot;perturbed
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ pH
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ \n&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ ylab(&quot;\n
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ Area
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ under
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ curve
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ (NO3-)&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ #
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_x_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,16,1),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 16))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_y_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,0.3,0.05),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 0.3))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ geom_text_repel(aes(label
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ round(NO3_mM,3)),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ size
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 3,family=&#39;serif&#39;,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line ggtitle(paste0(title,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line &quot;
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line \n&quot;))
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line +
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line #
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line geom_abline(slope
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line 1,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line intercept=0,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line show.legend
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line &#39;y=x&#39;)+
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line regression
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line line
    geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &quot;maroon2&quot;,
        size = 1) + # show equation size = 1) + # show equation
    annotate(&quot;text&quot;, x = annotate_x, y = annotate_y, label = paste0(&quot;y = &quot;, round(coef(fit.no3)[[1]],
        3), &quot;+&quot;, round(coef(fit.no3)[[2]], 3), &quot;x+&quot;, round(coef(fit.no3)[[3]], 3),
        &quot;x^2&quot;, &quot;,  R^2: &quot;, round(summary(fit.no3)$r.squared, 3)), color = &quot;maroon2&quot;) +
        mytheme_2d
}</code></pre>
</div>
<div id="decrease-the-number-of-strains" class="section level2">
<h2>2.1.5.1. [15] Decrease the number of strains</h2>
<p>If it goes above 50 strains, nitrite goes crazy</p>
<pre class="r"><code>## 15 strains, standard deviation 2
set.seed(1)
k = 15  # number of strains in a community
vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI &lt;- runif(k, 0, 15)
vec_max_rA &lt;- runif(k, 0, 15)

###### histogram and rI, rA distribution######
hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;,
    breaks = 14)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-17-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rI
g_std = 3
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = &quot;Simulating rI parameter of strains in soil of opt_pH = 7&quot;, ylim = c(0,
        16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-17-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = &quot;Simulating rA parameter of strains in soil of opt_pH = 7&quot;, ylim = c(0,
        16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-17-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>######

# A &amp; I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 3] pH perturbation simulation (n=&quot;, k, &quot;)&quot;), time = 60,
    time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code># A
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 3, vec_met = c(&quot;A&quot;), title = paste0(&quot;[rI_std = 3] pH perturbation simulation (n=&quot;,
    k, &quot;)&quot;), time = 60, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code># I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 3, vec_met = c(&quot;I&quot;), title = paste0(&quot;[rI_std = 3] pH perturbation simulation (n=&quot;,
    k, &quot;)&quot;), time = 60, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code>## smaller variance

###### histogram and rI, rA distribution######
hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;,
    breaks = 14)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-17-4.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rI
g_std = 1
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = &quot;Simulating rI parameter of strains in soil of opt_pH = 7&quot;, ylim = c(0,
        16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-17-5.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = &quot;Simulating rA parameter of strains in soil of opt_pH = 7&quot;, ylim = c(0,
        16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-17-6.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>######


# A &amp; I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 1, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 1] pH perturbation simulation (n=&quot;, k, &quot;)&quot;), time = 72,
    time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code># A
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 1, vec_met = c(&quot;A&quot;), title = paste0(&quot;[rI_std = 1] pH perturbation simulation (n=&quot;,
    k, &quot;)&quot;), time = 72, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code># I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 1, vec_met = c(&quot;I&quot;), title = paste0(&quot;[rI_std = 1] pH perturbation simulation (n=&quot;,
    k, &quot;)&quot;), time = 72, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
</div>
<div id="change-number-of-strains-and-ode-method" class="section level2">
<h2>2.1.5.2. Change number of strains and ode method</h2>
<p>ode45 can do the job?? wow..</p>
<pre class="r"><code>## 50 strains, standard deviation 2
set.seed(1)
k = 50  # number of strains in a community
vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI &lt;- runif(k, 0, 15)
set.seed(103)
vec_max_rA &lt;- runif(k, 0, 15)

###### histogram and rI, rA distribution######
hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;,
    breaks = 14)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rI
g_std = 3
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rI parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rA parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rI
g_std = 1
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rI parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-4.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rA parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-5.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## more pH variance A &amp; I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 3] pH perturbation simulation (n=&quot;, k, &quot;)&quot;), time = 10,
    time_by = 0.01, ode_method = &quot;ode45&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code>## smaller variance A &amp; I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 1, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 1] pH perturbation simulation (n=&quot;, k, &quot;)&quot;), time = 10,
    time_by = 0.01, ode_method = &quot;ode45&quot;)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code># A &amp; I
plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 3] Simulated Area under curve NO3- (n=&quot;, k, &quot;)&quot;), time = 72,
    time_by = 0.01, ode_method = &quot;ode45&quot;, annotate_x = 7, annotate_y = 3)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-6.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-7.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-8.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## smaller variance A &amp; I
plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 1, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 1] Simulated Area under curve NO3- (n=&quot;, k, &quot;)&quot;), time = 72,
    time_by = 0.01, ode_method = &quot;ode45&quot;, annotate_x = 7, annotate_y = 10)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-9.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-10.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-18-11.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="change-number-of-strains-and-ode-method-1" class="section level2">
<h2>2.1.5.3. [100] Change number of strains and ode method</h2>
<p>ode45 can do the job?? wow..</p>
<pre class="r"><code>## 15 strains, standard deviation 2
set.seed(1)
k = 100  # number of strains in a community
vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI &lt;- runif(k, 0, 15)
set.seed(103)
vec_max_rA &lt;- runif(k, 0, 15)

###### histogram and rI, rA distribution######
hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;,
    breaks = 14)</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rI
g_std = 3
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rI parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rA parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rI
g_std = 1
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rI parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-4.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rA parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-5.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## test the range
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-5,
    5), gauss_std = 1, vec_met = c(&quot;A&quot;, &quot;I&quot;), title = paste0(&quot;[rI_std = 1] pH perturbation simulation (n=&quot;,
    k, &quot;)&quot;), time = 10, time_by = 0.01, ode_method = &quot;ode45&quot;)</code></pre>
<pre><code>[1] 2
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre class="r"><code>plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-5,
    5), gauss_std = 1, vec_met = c(&quot;A&quot;, &quot;I&quot;), title = paste0(&quot;[rI_std = 1] Simulated Area under curve NO3- (n=&quot;,
    k, &quot;)&quot;), time = 72, time_by = 0.01, ode_method = &quot;ode45&quot;, annotate_x = 7, annotate_y = 10)</code></pre>
<pre><code>[1] 2
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-6.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-7.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-19-8.png" width="1056" style="display: block; margin: auto;" /></p>
<p>k=100 simulations (takes a long time 5 min each)</p>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: 5.5&quot; &quot;removing dynamics of pH: 8.5&quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<pre><code>Error: Can&#39;t add `ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH))` to a ggplot object.</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: 5.5&quot; &quot;removing dynamics of pH: 8.5&quot;</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-20-1.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-20-2.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-20-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-20-4.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-20-5.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-20-6.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="area-under-curve" class="section level2">
<h2>2.1.6. Area under curve</h2>
<pre class="r"><code>plot_perturbation_auc &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7,
    pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;), title, time = 10,
    time_by = 0.01, ode_method = &quot;vode&quot;, annotate_x, annotate_y) {
    # ODE solver
    k = length(vec_opt_pH)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)
    set.seed(4)
    parameter_1 = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0,
        0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = rep(0.01, k), A = 2, I = 0)

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        set.seed(4)
        parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k,
            0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = rep(0.01, k), A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    require(pracma)
    df_a &lt;- df_ai %&gt;%
        filter(Metabolite == &quot;Nitrate (NO3-)&quot;)
    colnames(df_a)
    df_corr &lt;- df_a %&gt;%
        group_by(pH) %&gt;%
        summarize(auc = trapz(time, value)) %&gt;%
        ungroup()

    plot(df_corr$pH, df_corr$auc)

    df_corr$pH_2 &lt;- (df_corr$pH)^2
    fit.no3 &lt;- lm(auc ~ pH + pH_2, df_corr)
    summary(fit.no3)

    perturbpH &lt;- seq(2, 13, 0.1)
    aucPredict &lt;- predict(fit.no3, list(pH = perturbpH, pH_2 = perturbpH^2))
    df_auc_quad &lt;- data.frame(pH = perturbpH, Time_hours = aucPredict)
    plot(perturbpH, aucPredict)

    # (1) Plot fitted linear regression line
    ggplot(df_corr, aes(x = pH, y = auc)) + geom_point(size = 2.5, shape = 16, color = &quot;brown&quot;) +
        # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +
        # geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM),
        # width=.05)+ scale_color_brewer(palette=&#39;Set2&#39;) +
        # scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ xlab(&quot;perturbed
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ pH
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ \n&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ ylab(&quot;\n
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ Area
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ under
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ curve
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ (NO3-)&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ #
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_x_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,16,1),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 16))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_y_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,0.3,0.05),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 0.3))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ geom_text_repel(aes(label
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ round(NO3_mM,3)),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ size
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 3,family=&#39;serif&#39;,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line ggtitle(paste0(title,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line &quot;
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line \n&quot;))
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line +
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line #
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line geom_abline(slope
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line 1,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line intercept=0,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line show.legend
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line &#39;y=x&#39;)+
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line regression
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line line
    geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &quot;maroon2&quot;,
        size = 1) + # show equation size = 1) + # show equation
    annotate(&quot;text&quot;, x = annotate_x, y = annotate_y, label = paste0(&quot;y = &quot;, round(coef(fit.no3)[[1]],
        3), &quot;+&quot;, round(coef(fit.no3)[[2]], 3), &quot;x+&quot;, round(coef(fit.no3)[[3]], 3),
        &quot;x^2&quot;, &quot;,  R^2: &quot;, round(summary(fit.no3)$r.squared, 3)), color = &quot;maroon2&quot;) +
        mytheme_2d
}

# plot with 15 strain model

## 15 strains, standard deviation 2
set.seed(1)
k = 15  # number of strains in a community
vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI &lt;- runif(k, 0, 15)
vec_max_rA &lt;- runif(k, 0, 15)

# A &amp; I
plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 3] Simulated Area under curve NO3- (n=&quot;, k, &quot;)&quot;), time = 72,
    time_by = 0.01, ode_method = &quot;vode&quot;, annotate_x = 7, annotate_y = 3)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-21-1.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-21-2.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-21-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## smaller variance A &amp; I
plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 1, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 1] Simulated Area under curve NO3- (n=&quot;, k, &quot;)&quot;), time = 72,
    time_by = 0.01, ode_method = &quot;vode&quot;, annotate_x = 7, annotate_y = 10)</code></pre>
<pre><code>[1] 2
[1] 2.5
[1] 3
[1] 3.5
[1] 4
[1] 4.5
[1] 5
[1] 5.5
[1] 6
[1] 6.5
[1] 7.5
[1] 8
[1] 8.5
[1] 9
[1] 9.5
[1] 10
[1] 10.5
[1] 11
[1] 11.5
[1] 12
[1] &quot;removing dynamics of pH: &quot;</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-21-4.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-21-5.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-21-6.png" width="1056" style="display: block; margin: auto;" /></p>
</div>
<div id="ecological-drivers-perturb-the-soil-ph-by-ecology" class="section level2">
<h2>3. [Ecological drivers] Perturb the soil pH: by Ecology</h2>
<p>The previous simulation relied on each individual strain’s physiology. Now we will simulate the pH perturbation in a slightly different method. (1) Strain level first we will fix the rI, rA of 15 strains. They will have the same max_height of rI, rA curve at opt_pH. (2) Soil level First community and the second community will have the same 15 strains. But their relative abundance will be different. First community will have a gaussian distribution of relative abundance with mean = opt_pH = 7. Second community will have uniform distribution of the relative abundance. The total biomass of both community will be same, 0.1 OD.</p>
</div>
<div id="set-up-soil-community" class="section level2">
<h2>3.1. Set up soil community</h2>
<pre class="r"><code>dev.off()</code></pre>
<pre><code>null device 
          1 </code></pre>
<pre class="r"><code># function
gaussian_function &lt;- function(x, std, mean, max_height = 0.3989423) {
    factor = max_height * std * sqrt(2 * pi)
    return(factor * (1/(std * sqrt(2 * pi))) * exp((-0.5) * ((x - mean)/std)^2))
}

## 15 strains, standard deviation 2
set.seed(1)
k = 15  # number of strains in a community
vec_opt_pH = seq(3, 12, length = 15)

## same max_height of rI, rA = 10
vec_max_rI &lt;- rep(10, 15)
vec_max_rA &lt;- rep(10, 15)

## plot rI and rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = 2, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i or rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19,
    lwd = 1, main = &quot;Simulating rI &amp; rA parameter of strains&quot;, ylim = c(0, 12))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = 2, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}

## relative abundance of first community
opt_pH = 7
rel_abun1 &lt;- gaussian_function(vec_opt_pH, mean = opt_pH, std = 2, max_height = 10)
rel_abun1 &lt;- rel_abun1/sum(rel_abun1)
abs_abun1 &lt;- rel_abun1/10  # sum to 0.1 OD
sum(abs_abun1)  # 0.1 OD</code></pre>
<pre><code>[1] 0.1</code></pre>
<pre class="r"><code>## of second community
rel_abun2 = rep(1/k, k)
abs_abun2 = rep(0.1/k, k)
sum(abs_abun2)</code></pre>
<pre><code>[1] 0.1</code></pre>
<pre class="r"><code># plot relative abundance
plot(vec_opt_pH, rel_abun1, xlab = &quot;optimal pH&quot;, ylab = &quot;Relative abundance&quot;, col = &quot;red&quot;,
    type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1, main = &quot;Relative abundance of strains with varying optimal pH&quot;,
    ylim = c(0, 0.3))
lines(vec_opt_pH, rel_abun2, lty = 1, pch = 19, lwd = 1, col = &quot;blue&quot;)
legend(7, 0.25, legend = c(&quot;Gaussian community&quot;, &quot;Uniform community&quot;), col = c(&quot;Red&quot;,
    &quot;Blue&quot;), lty = c(1, 1), cex = 0.8, box.lty = 0)


# plot dynamics rI when current pH is 7
vec_rI = gaussian_function(x = 7, mean = vec_opt_pH, std = 2, max_height = vec_max_rI)
length(vec_rI)</code></pre>
<pre><code>[1] 15</code></pre>
<pre class="r"><code>vec_rA = gaussian_function(x = 7, mean = vec_opt_pH, std = 2, max_height = vec_max_rA)
length(vec_rA)</code></pre>
<pre><code>[1] 15</code></pre>
<pre class="r"><code>## Gaussian community
k = 15
set.seed(1)
vec_gamma = runif(k, 0, 0.02)
parameter_1 = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
    kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state_1 = list(x = abs_abun1, A = 2, I = 0)
plot_2results(title = paste0(&quot;Gaussian Community dynamics at natural state, pH=7&quot;),
    time = 5, time_by = 0.01, parameters = parameter_1, state = state_1, ode_method = &quot;vode&quot;)

## Uniform community
k = 15
set.seed(1)
vec_gamma = runif(k, 0, 0.02)
parameter_1 = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
    kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state_1 = list(x = abs_abun2, A = 2, I = 0)
plot_2results(title = paste0(&quot;Uniform Community dynamics at natural state, pH=7&quot;),
    time = 5, time_by = 0.01, parameters = parameter_1, state = state_1, ode_method = &quot;vode&quot;)</code></pre>
</div>
<div id="ph-perturbation-simulation" class="section level2">
<h2>3.2. pH Perturbation simulation</h2>
<pre class="r"><code># function modify
plot_perturbation_rel_abun &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun,
    pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title, time = 10, time_by = 0.01, ode_method = &quot;vode&quot;) {
    # ODE solver
    k = length(vec_opt_pH)
    set.seed(6)
    vec_gamma = runif(k, 0, 0.02)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)

    parameter_1 = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
        kI = rep(0.01, k), kA = rep(0.01, k))
    abs_abun &lt;- rel_abun/10
    state_1 = list(x = abs_abun, A = 2, I = 0)
    print(abs_abun)
    print(paste0(&quot;The sum of absolution abundance = &quot;, sum(abs_abun)))

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        parameters = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
            kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = abs_abun, A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    # pH color
    col_pH &lt;- colorRampPalette(c(&quot;purple&quot;, &quot;red&quot;, &quot;gold&quot;))

    library(colorRamps)
    df_ai %&gt;%
        select(Metabolite) %&gt;%
        unique()
    df_ai %&gt;%
        select(pH) %&gt;%
        unique()

    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + ggplot(df_ai,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + aes(x
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + time,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + y
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + value,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + color
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + group
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH))
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + #
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + geom_point(size=2.5,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + shape=16)
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite geom_line(size
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite 1.2)
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite #
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_colour_gradientn(colours
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite col_pH(100))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite ##
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite blue
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrate,
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite red
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrite
    scale_colour_gradientn(colours = col_pH(100)) + ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
        xlab(&quot;\n Time (hr)&quot;) + scale_y_continuous(breaks = seq(0, 2, 0.25), limits = c(0,
        2)) + # expand_limits(y=0) + 2)) + # expand_limits(y=0) +
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ ggtitle(paste0(title,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ &quot;
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ \n&quot;))
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ +
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ #
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ label
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ geom_text(aes(label
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ round(Ave_NO3_mM,3)),
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ size
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ 3,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ vjust
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ -1.5,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ family=&#39;serif&#39;,
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title, &quot; \n&quot;)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    mytheme_2d + facet_grid(. ~ Metabolite) + theme(strip.background = element_rect(colour = &quot;black&quot;,
        fill = &quot;white&quot;, size = 0.1))
}


plot_perturbation_rel_abun_auc &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun,
    pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title, time = 10, time_by = 0.01, ode_method = &quot;vode&quot;, annotate_x, annotate_y) {
    # ODE solver
    k = length(vec_opt_pH)
    set.seed(6)
    vec_gamma = runif(k, 0, 0.02)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)

    parameter_1 = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
        kI = rep(0.01, k), kA = rep(0.01, k))
    abs_abun &lt;- rel_abun/10
    state_1 = list(x = abs_abun, A = 2, I = 0)
    print(abs_abun)
    print(paste0(&quot;The sum of absolution abundance = &quot;, sum(abs_abun)))

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        parameters = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
            kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = abs_abun, A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    require(pracma)
    df_a &lt;- df_ai %&gt;%
        filter(Metabolite == &quot;Nitrate (NO3-)&quot;)
    colnames(df_a)
    df_corr &lt;- df_a %&gt;%
        group_by(pH) %&gt;%
        summarize(auc = trapz(time, value)) %&gt;%
        ungroup()

    plot(df_corr$pH, df_corr$auc)

    df_corr$pH_2 &lt;- (df_corr$pH)^2
    fit.no3 &lt;- lm(auc ~ pH + pH_2, df_corr)
    summary(fit.no3)

    perturbpH &lt;- seq(2, 13, 0.1)
    aucPredict &lt;- predict(fit.no3, list(pH = perturbpH, pH_2 = perturbpH^2))
    df_auc_quad &lt;- data.frame(pH = perturbpH, Time_hours = aucPredict)
    plot(perturbpH, aucPredict)

    # (1) Plot fitted linear regression line
    ggplot(df_corr, aes(x = pH, y = auc)) + geom_point(size = 2.5, shape = 16, color = &quot;brown&quot;) +
        # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +
        # geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM),
        # width=.05)+ scale_color_brewer(palette=&#39;Set2&#39;) +
        # scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ xlab(&quot;perturbed
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ pH
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ \n&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ ylab(&quot;\n
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ Area
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ under
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ curve
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ (NO3-)&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ #
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_x_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,16,1),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 16))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_y_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,0.3,0.05),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 0.3))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ geom_text_repel(aes(label
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ round(NO3_mM,3)),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ size
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 3,family=&#39;serif&#39;,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line ggtitle(paste0(title,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line &quot;
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line \n&quot;))
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line +
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line #
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line geom_abline(slope
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line 1,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line intercept=0,
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line show.legend
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line &#39;y=x&#39;)+
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line regression
    ggtitle(paste0(title, &quot; \n&quot;)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line line
    geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &quot;maroon2&quot;,
        size = 1) + # show equation size = 1) + # show equation
    annotate(&quot;text&quot;, x = annotate_x, y = annotate_y, label = paste0(&quot;y = &quot;, round(coef(fit.no3)[[1]],
        3), &quot;+&quot;, round(coef(fit.no3)[[2]], 3), &quot;x+&quot;, round(coef(fit.no3)[[3]], 3),
        &quot;x^2&quot;, &quot;,  R^2: &quot;, round(summary(fit.no3)$r.squared, 3)), color = &quot;maroon2&quot;) +
        mytheme_2d
}

# for nitrate
plot_perturbation_abs_abunA &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun,
    pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title, time = 10, time_by = 0.01, ode_method = &quot;vode&quot;) {
    # ODE solver
    k = length(vec_opt_pH)
    set.seed(1)
    vec_gamma = runif(k, 0, 0.02)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)

    parameter_1 = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
        kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = abs_abun, A = 2, I = 0)
    print(abs_abun)
    print(paste0(&quot;The sum of absolution abundance = &quot;, sum(abs_abun)))

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        parameters = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
            kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = abs_abun, A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    ## end_time &lt;- df_ai$time %&gt;% max() vec_remove_pH &lt;- df_ai %&gt;% filter(time
    ## == end_time &amp; value &gt; 1e-1) %&gt;% select(pH) %&gt;% unlist()
    ## print(paste0(&#39;removing dynamics of pH: &#39;, vec_remove_pH)) df_ai$value &lt;-
    ## ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    # pH color
    col_pH &lt;- colorRampPalette(c(&quot;purple&quot;, &quot;red&quot;, &quot;gold&quot;))

    library(colorRamps)
    df_ai %&gt;%
        select(Metabolite) %&gt;%
        unique()
    df_ai %&gt;%
        select(pH) %&gt;%
        unique()

    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + ggplot(df_ai,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + aes(x
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + time,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + y
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + value,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + color
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + group
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH))
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + #
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + geom_point(size=2.5,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + shape=16)
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite geom_line(size
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite 1.2)
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite #
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_colour_gradientn(colours
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite col_pH(100))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite ##
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite blue
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrate,
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite red
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrite
    scale_colour_gradientn(colours = col_pH(100)) + ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
        xlab(&quot;\n Time (hr)&quot;) + scale_y_continuous(breaks = seq(0, 2, 0.25), limits = c(0,
        2)) + # expand_limits(y=0) + 2)) + # expand_limits(y=0) +
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ ggtitle(paste0(title))
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ +
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ #
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ label
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ geom_text(aes(label
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ round(Ave_NO3_mM,3)),
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ size
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ 3,
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ vjust
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ -1.5,
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ family=&#39;serif&#39;,
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    mytheme_2d + facet_grid(. ~ Metabolite) + theme(strip.background = element_rect(colour = &quot;black&quot;,
        fill = &quot;white&quot;, size = 0.1))
}

# for nitrite
plot_perturbation_abs_abunI &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun,
    pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title, time = 10, time_by = 0.01, ode_method = &quot;vode&quot;) {
    # ODE solver
    k = length(vec_opt_pH)
    set.seed(6)
    vec_gamma = runif(k, 0, 0.02)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)

    parameter_1 = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
        kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = abs_abun, A = 2, I = 0)
    print(abs_abun)
    print(paste0(&quot;The sum of absolution abundance = &quot;, sum(abs_abun)))

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        parameters = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
            kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = abs_abun, A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    # pH color
    col_pH &lt;- colorRampPalette(c(&quot;purple&quot;, &quot;red&quot;, &quot;gold&quot;))

    library(colorRamps)
    df_ai %&gt;%
        select(Metabolite) %&gt;%
        unique()
    df_ai %&gt;%
        select(pH) %&gt;%
        unique()

    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + ggplot(df_ai,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + aes(x
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + time,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + y
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + value,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + color
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + group
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + =
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + pH))
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + #
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + geom_point(size=2.5,
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + shape=16)
    ggplot(df_ai, aes(x = time, y = value, color = pH, group = pH)) + # geom_point(size=2.5, shape=16) + +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite geom_line(size
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite 1.2)
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite #
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_colour_gradientn(colours
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite col_pH(100))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;))
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite +
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite ##
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite blue
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrate,
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite red
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite =
    geom_line(size = 1.2) + # scale_colour_gradientn(colours = col_pH(100)) +  scale_color_manual(values=c(&#39;#3958ab&#39;,&#39;#ad4620&#39;)) + ## blue = nitrate, red = nitrite nitrite
    scale_colour_gradientn(colours = col_pH(100)) + ylab(&quot;Nitrate or Nitrite (mM) \n&quot;) +
        xlab(&quot;\n Time (hr)&quot;) + scale_y_continuous(breaks = seq(0, 2, 0.25), limits = c(0,
        2)) + # expand_limits(y=0) + 2)) + # expand_limits(y=0) +
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ ggtitle(paste0(title))
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ +
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ #
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ label
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ geom_text(aes(label
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ round(Ave_NO3_mM,3)),
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ size
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ 3,
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ vjust
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ -1.5,
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ family=&#39;serif&#39;,
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ =
    ggtitle(paste0(title)) + # label  geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    mytheme_2d + facet_grid(. ~ Metabolite) + theme(strip.background = element_rect(colour = &quot;black&quot;,
        fill = &quot;white&quot;, size = 0.1))
}


plot_perturbation_abs_abun_auc &lt;- function(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun,
    pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title, time = 10, time_by = 0.01, ode_method = &quot;vode&quot;) {
    # ODE solver
    k = length(vec_opt_pH)
    set.seed(6)
    vec_gamma = runif(k, 0, 0.02)
    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)

    parameter_1 = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
        kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = abs_abun, A = 2, I = 0)
    print(abs_abun)
    print(paste0(&quot;The sum of absolution abundance = &quot;, sum(abs_abun)))

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        parameters = list(gamI = vec_gamma, rI = vec_rI, gamA = vec_gamma, rA = vec_rA,
            kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = abs_abun, A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    require(pracma)
    df_a &lt;- df_ai %&gt;%
        filter(Metabolite == &quot;Nitrate (NO3-)&quot;)
    colnames(df_a)
    df_corr &lt;- df_a %&gt;%
        group_by(pH) %&gt;%
        summarize(auc = trapz(time, value)) %&gt;%
        ungroup()

    plot(df_corr$pH, df_corr$auc)

    # df_corr$pH_2 &lt;- (df_corr$pH)^2 fit.no3 &lt;- lm(auc ~ pH + pH_2, df_corr)
    # summary(fit.no3)

    # perturbpH &lt;- seq(2, 13, 0.1) aucPredict &lt;-
    # predict(fit.no3,list(pH=perturbpH, pH_2=perturbpH^2)) df_auc_quad &lt;-
    # data.frame(pH = perturbpH, Time_hours = aucPredict) plot(perturbpH,
    # aucPredict)

    vec_pH &lt;- unique(df_corr$pH)
    annotate_x = median(vec_pH[!is.na(vec_pH)])
    vec_auc &lt;- unique(df_corr$auc)
    annotate_y = max(vec_auc[!is.na(vec_auc)])

    # (1) Plot fitted linear regression line
    ggplot(df_corr, aes(x = pH, y = auc)) + geom_point(size = 2.5, shape = 16, color = &quot;brown&quot;) +
        # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +
        # geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM),
        # width=.05)+ scale_color_brewer(palette=&#39;Set2&#39;) +
        # scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + scale_x_continuous(breaks = seq(1,
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 13,
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 1),
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ c(1.5,
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 12.5))
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ #scale_y_continuous(breaks
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,0.3,0.05),
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 0.3))+
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ geom_text_repel(aes(label
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ round(NO3_mM,3)),
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ size
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 3,family=&#39;serif&#39;,
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
        13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + ggtitle(paste0(title))
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + +
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + #
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + geom_abline(slope
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + 1,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + intercept=0,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + show.legend
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;y=x&#39;)+
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + regression
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + line
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + geom_line(data
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + df_auc_quad,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + aes(x
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + pH,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + y
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + Time_hours),
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + color
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;maroon2&#39;,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + size
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + 1)
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + +
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + show
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + equation
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + annotate(&#39;text&#39;,x=
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + annotate_x,y=annotate_y,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + label=
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + paste0(&#39;y
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + round(coef(fit.no3)[[1]],3),
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;+&#39;,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3),
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;x^2&#39;,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + R^2:
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + round(summary(fit.no3)$r.squared,3)),
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + color
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + &#39;maroon2&#39;)
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line  geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &#39;maroon2&#39;, size = 1) +  show equation  annotate(&#39;text&#39;,x= annotate_x,y=annotate_y, label= paste0(&#39;y = &#39;, round(coef(fit.no3)[[1]],3), &#39;+&#39;, round(coef(fit.no3)[[2]],3),&#39;x+&#39;,round(coef(fit.no3)[[3]],3), &#39;x^2&#39;, &#39;,  R^2: &#39;, round(summary(fit.no3)$r.squared,3)), color = &#39;maroon2&#39;) + +
    mytheme_2d
}




## Gaussian community
plot_perturbation_rel_abun(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun1,
    pH_from = 7, pH_perturb = c(seq(-5, -0.5, by = 0.5), seq(0.5, 5, by = 0.5)),
    gauss_std = 2, vec_met = c(&quot;A&quot;, &quot;I&quot;), title = paste0(&quot;[Gaussian community] Simulated Area under curve NO3- (n=&quot;,
        k, &quot;)&quot;), time = 20, time_by = 0.01, ode_method = &quot;vode&quot;)

## Gaussian community - AUC
plot_perturbation_rel_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun1,
    pH_from = 7, pH_perturb = c(seq(-5, -0.5, by = 0.5), seq(0.5, 5, by = 0.5)),
    gauss_std = 2, vec_met = c(&quot;A&quot;, &quot;I&quot;), title = paste0(&quot;[Gaussian community] Simulated Area under curve NO3- (n=&quot;,
        k, &quot;)&quot;), time = 20, time_by = 0.01, ode_method = &quot;vode&quot;, annotate_x = 7.5,
    annotate_y = 10)

## Uniform community
plot_perturbation_rel_abun(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun2,
    pH_from = 7, pH_perturb = c(seq(-5, -0.5, by = 0.5), seq(0.5, 5, by = 0.5)),
    gauss_std = 2, vec_met = c(&quot;A&quot;, &quot;I&quot;), title = paste0(&quot;[Uniform community] Simulated Area under curve NO3- (n=&quot;,
        k, &quot;)&quot;), time = 20, time_by = 0.01, ode_method = &quot;vode&quot;)

## Uniform community - AUC
plot_perturbation_rel_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun2,
    pH_from = 7, pH_perturb = c(seq(-5, -0.5, by = 0.5), seq(0.5, 5, by = 0.5)),
    gauss_std = 2, vec_met = c(&quot;A&quot;, &quot;I&quot;), title = paste0(&quot;[Uniform community] Simulated Area under curve NO3- (n=&quot;,
        k, &quot;)&quot;), time = 20, time_by = 0.01, ode_method = &quot;vode&quot;, annotate_x = 7.5,
    annotate_y = 10)
</code></pre>
<pre><code>Error: &lt;text&gt;:674:11: unexpected &#39;,&#39;
673:         13, 1), limits = c(1.5, 12.5)) + #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = 
674:         13,
               ^</code></pre>
</div>
<div id="what-is-the-effect-of-initial-composition-change" class="section level2">
<h2>3.3. What is the effect of initial composition change?</h2>
<pre class="r"><code>dev.off()</code></pre>
<pre><code>null device 
          1 </code></pre>
<pre class="r"><code># function
gaussian_function &lt;- function(x, std, mean, max_height=0.3989423){
  factor = max_height * std*sqrt(2*pi)
  return(factor*(1/ (std * sqrt(2*pi)))*exp((-0.5)*( (x - mean) / std)^2))
}

## 15 strains, standard deviation 2
set.seed(1)
k = 15 # number of strains in a community
vec_opt_pH = seq(3, 12, length=15)

## same max_height of rI, rA = 10
vec_max_rI &lt;- rep(10, 15)
vec_max_rA &lt;- rep(10, 15)

## plot rI and rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=2, max_height= vec_max_rI[1]), xlab = &quot;pH&quot;,ylab = &quot;rI_i or rA_i&quot;, col=&#39;blue&#39;, type = &quot;l&quot;,lty = 1, pch=19,lwd=1, main = &quot;Simulating rI &amp; rA parameter of strains&quot;, ylim=c(0,12))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=2, max_height= vec_max_rI[i]), col=&#39;blue&#39;)
}

## relative abundance
## of first community
opt_pH = 7
rel_abun1 &lt;- gaussian_function(vec_opt_pH, mean=opt_pH, std=2, max_height= 10)
rel_abun1 &lt;- rel_abun1/sum(rel_abun1)
abs_abun1 &lt;- rel_abun1/10 # sum to 0.1 OD
sum(abs_abun1) # 0.1 OD</code></pre>
<pre><code>[1] 0.1</code></pre>
<pre class="r"><code>get_rel_abun &lt;- function(gauss_std){
  opt_pH = 7
  rel_abun1 &lt;- gaussian_function(vec_opt_pH, mean=opt_pH, std=gauss_std, max_height= 10)
  rel_abun1 &lt;- rel_abun1/sum(rel_abun1)
  abs_abun1 &lt;- rel_abun1/10 # sum to 0.1 OD
  sum(abs_abun1) # 0.1 OD
  return(rel_abun1)
}

get_abs_abun &lt;- function(gauss_std){
  opt_pH = 7
  rel_abun1 &lt;- gaussian_function(vec_opt_pH, mean=opt_pH, std=gauss_std, max_height= 10)
  rel_abun1 &lt;- rel_abun1/sum(rel_abun1)
  abs_abun1 &lt;- rel_abun1/10 # sum to 0.1 OD
  sum(abs_abun1) # 0.1 OD
  return(abs_abun1)
}

get_rel_abun(gauss_std = 0.1)</code></pre>
<pre><code> [1]  0.000000e+00 5.120937e-245 2.905675e-160  1.858919e-93  1.340879e-44
 [6]  1.090523e-13  9.999897e-01  1.033885e-05  1.205215e-28  1.584064e-69
[11] 2.347452e-128 3.922262e-205 7.389110e-300  0.000000e+00  0.000000e+00</code></pre>
<pre class="r"><code>plot(get_rel_abun(gauss_std = 0.1))
get_rel_abun(gauss_std = 0.5)</code></pre>
<pre><code> [1] 6.495762e-15 8.331082e-11 2.045772e-07 9.618290e-05 8.658108e-03
 [6] 1.492220e-01 4.924104e-01 3.111045e-01 3.763310e-02 8.716022e-04
[11] 3.865016e-06 3.281473e-09 5.334222e-13 1.660191e-17 9.893033e-23</code></pre>
<pre class="r"><code>plot(get_rel_abun(gauss_std = 0.5))

## uniform community
rel_abun = rep(1/k, k)
abs_abun = rep(0.1/k, k)
sum(abs_abun)</code></pre>
<pre><code>[1] 0.1</code></pre>
<pre class="r"><code># plot relative abundance
plot(vec_opt_pH, rel_abun, xlab = &quot;optimal pH&quot;, ylab = &quot;Relative abundance&quot;, col=&#39;red&#39;, type = &quot;l&quot;,lty = 1, pch=19,lwd=1, main = &quot;Relative abundance of strains with varying optimal pH&quot;, ylim=c(0,1))
lines(vec_opt_pH, get_rel_abun(gauss_std = 0.1), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 0.3), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 0.5), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 0.7), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 1), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 1.5), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 2), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 3), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 4), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)
lines(vec_opt_pH, get_rel_abun(gauss_std = 6), lty = 1, pch=19,lwd=1, col=&#39;blue&#39;)

legend(&quot;topright&quot;, legend=c(&#39;Gaussian community (different std)&#39;, &#39;Uniform community&#39;), col=c(&quot;Blue&quot;, &quot;Red&quot;), lty=c(1,1), cex=0.5, box.lty=0)


# plot dynamics
## rI when current pH is 7
vec_rI = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=vec_max_rI)
length(vec_rI)</code></pre>
<pre><code>[1] 15</code></pre>
<pre class="r"><code>vec_rA = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=vec_max_rA)
length(vec_rA)</code></pre>
<pre><code>[1] 15</code></pre>
<pre class="r"><code>## Uniform community
k=15
set.seed(1)
vec_gamma = runif(k, 0, 0.02)
parameter_1 = list(gamI=vec_gamma, rI =vec_rI, gamA= vec_gamma, rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state_1 = list(x = abs_abun, A = 2, I = 0)
plot_2results(title = paste0(&quot;Uniform Community dynamics at natural state, pH=7&quot;),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)

# plotting the distribution of opt_pH
plot_distribution &lt;- function(vec_opt_pH, abs_abun, title){
  df_hist &lt;- data.frame(opt_pH = vec_opt_pH, rel_abun = abs_abun*10)

  pd &lt;- ggplot(df_hist, aes(x=opt_pH, y=rel_abun)) +
    geom_bar(stat=&quot;identity&quot;,position=&quot;dodge&quot;, fill = &quot;royalblue&quot;)+
    # geom_errorbar(aes(ymin=Ratio_retrieved - Std_Ratio_retrieved, ymax=Ratio_retrieved + Std_Ratio_retrieved), width=.05, position = position_dodge(0.8))+
    # geom_line(size=0.2)+
    # scale_fill_brewer(palette=&#39;Set1&#39;) +
    ylab(&quot;Relative abundance of strains with opt_pH \n&quot;) +
    xlab(&quot;\n Optimal pH of strain &quot;) +
    scale_y_continuous(breaks = seq(0,1,0.1), limits=c(0, 1))+
    # scale_x_continuous(breaks = seq(2,12.5,1), limits=c(2, 12))+
    ggtitle(title) +
    mytheme_2d
  return(pd)
}
 
## Gaussian community
gauss_std &lt;- 0.1
abs_abun0.1 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun0.1, A = 2, I = 0)
pd1 &lt;- plot_distribution(vec_opt_pH, abs_abun0.1, title = paste0(&quot;Community sd: &quot;, gauss_std))
pc1 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm1 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pA1 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 100, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI1 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 100, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc1 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun0.1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 100, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 0.3
abs_abun0.3 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun0.3, A = 2, I = 0)
pd2 &lt;- plot_distribution(vec_opt_pH, abs_abun0.3, title = paste0(&quot;Community sd: &quot;, gauss_std))
pc2 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm2 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pA2 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.3, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI2 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.3, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc2 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun0.3, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 0.5
abs_abun0.5 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun0.5, A = 2, I = 0)
pc3 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm3 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd3 &lt;- plot_distribution(vec_opt_pH, abs_abun0.5, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA3 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.5, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI3 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.5, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc3 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun0.5, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 0.7
abs_abun0.7 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun0.7, A = 2, I = 0)
pc4 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm4 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd4 &lt;- plot_distribution(vec_opt_pH, abs_abun0.7, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA4 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.7, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI4 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun0.7, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc4 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun0.7, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 1
abs_abun1 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun1, A = 2, I = 0)
pc5 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm5 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd5 &lt;- plot_distribution(vec_opt_pH, abs_abun1, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA5 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI5 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc5 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 1.5
abs_abun1.5 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun1.5, A = 2, I = 0)
pc6 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm6 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd6 &lt;- plot_distribution(vec_opt_pH, abs_abun1.5, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA6 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun1.5, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI6 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun1.5, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc6 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun1.5, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 60, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 2
abs_abun2 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun2, A = 2, I = 0)
pc7 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm7 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd7 &lt;- plot_distribution(vec_opt_pH, abs_abun2, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA7 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun2, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 20, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI7 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun2, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 20, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc7 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun2, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 20, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 3
abs_abun3 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun3, A = 2, I = 0)
pc8 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm8 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd8 &lt;- plot_distribution(vec_opt_pH, abs_abun3, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA8 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun3, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 20, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI8 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun3, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 20, time_by = 0.1, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc8 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun3, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 20, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 4
abs_abun4 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun4, A = 2, I = 0)
pc9 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm9 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd9 &lt;- plot_distribution(vec_opt_pH, abs_abun4, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA9 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun4, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 15, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI9 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun4, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 15, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc9 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun4, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 15, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## Gaussian community
gauss_std &lt;- 6
abs_abun6 &lt;- get_abs_abun(gauss_std)
state_1 = list(x = abs_abun6, A = 2, I = 0)
pc10 &lt;- plot_community(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pm10 &lt;- plot_metabolite(title = paste0(&quot;Community sd: &quot;, gauss_std),time = 10, time_by = 0.01, parameter_1, state_1, ode_method = &quot;vode&quot;)
pd10 &lt;- plot_distribution(vec_opt_pH, abs_abun6, title = paste0(&quot;Community sd: &quot;, gauss_std))
pA10 &lt;- plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun6, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 15, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre class="r"><code>pI10 &lt;- plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun = abs_abun6, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 15, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre class="r"><code>auc10 &lt;- plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, abs_abun6, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c(&quot;A&quot;,&quot;I&quot;), title = paste0(&quot;Community sd: &quot;, gauss_std), time = 15, time_by = 0.01, ode_method = &quot;vode&quot;)</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre class="r"><code>## plot
library(gridExtra)
library(grid)

# confer this thread: https://stackoverflow.com/questions/11076567/plot-a-legend-and-well-spaced-universal-y-axis-and-main-titles-in-grid-arrange 

# Extract the legend from p1
library(gtable)
legend = gtable_filter(ggplotGrob(pc1), &quot;guide-box&quot;) 

# plot community
grid.arrange(arrangeGrob(pc1+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), 
                         pc2+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pc3+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pc4+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pc5+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pc6+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pc7+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pc8+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pc9+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), 
                         pc10+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), nrow = 2,
             top = textGrob(&quot;Community dynamics at pH 7&quot;, vjust = 0.5, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             left = textGrob(&quot;Biomass (OD)&quot;, vjust = 0.5, rot=90, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             bottom = textGrob(&quot;Time (hr)&quot;, vjust = 0, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5))),
             
             legend, 
             widths=unit.c(unit(1, &quot;npc&quot;) - legend$width, legend$width), 
             nrow=1
)

# plot metabolite
legend = gtable_filter(ggplotGrob(pm1), &quot;guide-box&quot;) 

grid.arrange(arrangeGrob(pm1+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm2+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm3+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm4+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm5+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm6+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm7+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm8+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm9+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pm10+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), nrow = 2,
             top = textGrob(&quot;Metabolite dynamics at pH 7&quot;, vjust = 0.5, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             left = textGrob(&quot;NO2- or NO3- (mM)&quot;, vjust = 0.5, rot=90, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             bottom = textGrob(&quot;Time (hr)&quot;, vjust = 0, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5))),
             
             legend, 
             widths=unit.c(unit(1, &quot;npc&quot;) - legend$width, legend$width), 
             nrow=1
)

# plot community opt_pH distribution
grid.arrange(arrangeGrob(pd1+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd2+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd3+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd4+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd5+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd6+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd7+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd8+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd9+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pd10+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), nrow = 2,
             top = textGrob(&quot;Optimal pH distribution in a soil sample with different std&quot;, vjust = 0.5, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             left = textGrob(&quot;Relative abundance of strains with opt_pH&quot;, vjust = 0.5, rot=90, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             bottom = textGrob(&quot;Optimal pH of strains&quot;, vjust = 0, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)))
             
             # legend, 
             # widths=unit.c(unit(1, &quot;npc&quot;) - legend$width, legend$width), 
             # nrow=1
)


# plot pH perturbation - Nitrate dynamics
legend = gtable_filter(ggplotGrob(pA1), &quot;guide-box&quot;) </code></pre>
<pre><code>Error in ggplot_build(x): object &#39;pA1&#39; not found</code></pre>
<pre class="r"><code>grid.arrange(arrangeGrob(pA1+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA2+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA3+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA4+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA5+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA6+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA7+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA8+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA9+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pA10+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), nrow = 2,
             top = textGrob(&quot;Change in Nitrate (NO3-) dynamics from pH perturbation&quot;, vjust = 0.5, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             left = textGrob(&quot;NO3- (mM)&quot;, vjust = 0.5, rot=90, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             bottom = textGrob(&quot;Time (hr)&quot;, vjust = 0, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5))),
             
             legend, 
             widths=unit.c(unit(1, &quot;npc&quot;) - legend$width, legend$width), 
             nrow=1
)</code></pre>
<pre><code>Error in arrangeGrob(pA1 + ylab(NULL) + xlab(NULL) + theme(legend.position = &quot;none&quot;), : object &#39;pA1&#39; not found</code></pre>
<pre class="r"><code># plot pH perturbation - Nitrite dynamics
legend = gtable_filter(ggplotGrob(pI1), &quot;guide-box&quot;) </code></pre>
<pre><code>Error in ggplot_build(x): object &#39;pI1&#39; not found</code></pre>
<pre class="r"><code>grid.arrange(arrangeGrob(pI1+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI2+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI3+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI4+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI5+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI6+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI7+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI8+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI9+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         pI10+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), nrow = 2,
             top = textGrob(&quot;Change in Nitrite (NO2-) dynamics from pH perturbation&quot;, vjust = 0.5, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             left = textGrob(&quot;NO2- (mM)&quot;, vjust = 0.5, rot=90, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             bottom = textGrob(&quot;Time (hr)&quot;, vjust = 0, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5))),
             
             legend, 
             widths=unit.c(unit(1, &quot;npc&quot;) - legend$width, legend$width), 
             nrow=1
)</code></pre>
<pre><code>Error in arrangeGrob(pI1 + ylab(NULL) + xlab(NULL) + theme(legend.position = &quot;none&quot;), : object &#39;pI1&#39; not found</code></pre>
<pre class="r"><code># plot pH perturbation - auc
# legend = gtable_filter(ggplotGrob(auc1), &quot;guide-box&quot;) 

grid.arrange(arrangeGrob(auc1+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc2+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc3+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc4+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc5+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc6+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc7+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc8+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc9+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;),
                         auc10+ylab(NULL)+xlab(NULL)+theme(legend.position=&quot;none&quot;), nrow = 2,
             top = textGrob(&quot;Area under curve (AUC) of nitrate dynamics during pH perturbation&quot;, vjust = 0.5, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             left = textGrob(&quot;AUC (Area under curve)&quot;, vjust = 0.5, rot=90, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)),
             bottom = textGrob(&quot;perturbed pH&quot;, vjust = 0, gp = gpar(fontface = &quot;bold&quot;, cex = 1.5)))
             
             # legend, 
             # widths=unit.c(unit(1, &quot;npc&quot;) - legend$width, legend$width), 
             # nrow=1
)</code></pre>
<pre><code>Error in arrangeGrob(auc1 + ylab(NULL) + xlab(NULL) + theme(legend.position = &quot;none&quot;), : object &#39;auc1&#39; not found</code></pre>
<p>Hmm… I think I made a huge mistake by changing both the standard deviation of the community and the standard deviation of the enzyme….. so stupid. I’ll save the results here</p>
</div>
<div id="lets-use-this-to-see-the-difference-in-gauss_std-of-enzymes" class="section level2">
<h2>Let’s use this to see the difference in gauss_std (of enzymes)</h2>
<pre><code>[1] 0.1</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-1.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-2.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-3.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-4.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-5.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-6.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-7.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-8.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-9.png" width="1056" style="display: block; margin: auto;" /><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-25-10.png" width="1056" style="display: block; margin: auto;" /></p>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunA(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunA&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abunI(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abunI&quot;</code></pre>
<pre><code>Error in plot_perturbation_abs_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, : could not find function &quot;plot_perturbation_abs_abun_auc&quot;</code></pre>
<pre><code>Error in ggplot_build(x): object &#39;pA1&#39; not found</code></pre>
<pre><code>Error in arrangeGrob(pA1 + ylab(NULL) + xlab(NULL) + theme(legend.position = &quot;none&quot;), : object &#39;pA1&#39; not found</code></pre>
<pre><code>Error in ggplot_build(x): object &#39;pI1&#39; not found</code></pre>
<pre><code>Error in arrangeGrob(pI1 + ylab(NULL) + xlab(NULL) + theme(legend.position = &quot;none&quot;), : object &#39;pI1&#39; not found</code></pre>
<pre><code>Error in arrangeGrob(auc1 + ylab(NULL) + xlab(NULL) + theme(legend.position = &quot;none&quot;), : object &#39;auc1&#39; not found</code></pre>
</div>
<div id="varying-number-of-species-and-gaussian-std-at-the-same-time" class="section level2">
<h2>4. Varying number of species and gaussian std at the same time</h2>
</div>
<div id="using-random-sampling" class="section level2">
<h2>4.1. Using random sampling</h2>
<ul>
<li>uniform distribution of relative abundance<br />
</li>
<li>uniform distribution of optimal pH<br />
</li>
</ul>
<pre class="r"><code>
# function to measure smoothness
smoothness_auc_k_std &lt;- function(k = 50, gauss_std = 3, pH_from = 7, pH_perturb = c(-4:-1,
    1:3), vec_met = c(&quot;A&quot;, &quot;I&quot;), title, time = 10, time_by = 0.01, ode_method = &quot;vode&quot;) {
    # ODE solver number of strains in a community
    set.seed(1)
    vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
    vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
    vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

    # what if I make the max_height uniform distribution
    set.seed(33)
    vec_max_rI &lt;- runif(k, 0, 15)
    set.seed(103)
    vec_max_rA &lt;- runif(k, 0, 15)

    ###### histogram and rI, rA distribution######
    hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;,
        breaks = 14)

    # plot rI
    x &lt;- seq(0, 14, by = 0.01)
    plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = gauss_std, max_height = vec_max_rI[1]),
        xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19,
        lwd = 1, main = paste0(&quot;[std = &quot;, gauss_std, &quot;] Simulating rI parameter of strains in soil of opt_pH = 7&quot;),
        ylim = c(0, 16))

    for (i in 2:k) {
        lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = gauss_std, max_height = vec_max_rI[i]),
            col = &quot;blue&quot;)
    }

    # plot rA
    x &lt;- seq(0, 14, by = 0.01)
    plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = gauss_std, max_height = vec_max_rA[1]),
        xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19,
        lwd = 1, main = paste0(&quot;[std = &quot;, gauss_std, &quot;] Simulating rA parameter of strains in soil of opt_pH = 7&quot;),
        ylim = c(0, 16))

    for (i in 2:k) {
        lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = gauss_std, max_height = vec_max_rA[i]),
            col = &quot;blue&quot;)
    }

    vec_rI = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rI)
    vec_rA = gaussian_function(x = pH_from, mean = vec_opt_pH, std = gauss_std, max_height = vec_max_rA)
    set.seed(4)
    parameter_1 = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k, 0,
        0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    state_1 = list(x = rep(0.01, k), A = 2, I = 0)

    times &lt;- seq(0, time, by = time_by)
    outc &lt;- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method,
        atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_out &lt;- as.data.frame(outc)
    df_out$pH &lt;- pH_from
    dim(df_out)

    for (i in pH_perturb) {
        pH_to = pH_from + i
        print(pH_to)
        vec_rI = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rI)
        # print(tail(vec_rI)) print(tail(vec_rA))
        vec_rA = gaussian_function(x = pH_to, mean = vec_opt_pH, std = gauss_std,
            max_height = vec_max_rA)
        set.seed(4)
        parameters = list(gamI = runif(k, 0, 0.02), rI = vec_rI, gamA = runif(k,
            0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
        # print(parameter$rI)
        states = list(x = rep(0.01, k), A = 2, I = 0)
        outc &lt;- ode(unlist(states), times, crGrowth, parameters, method = ode_method,
            atol = 1e-04, rtol = 1e-04)  # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
        df_add &lt;- as.data.frame(outc)
        df_add$pH &lt;- pH_to
        df_out &lt;- rbind(df_out, df_add)
    }
    colnames(df_out)
    df_out &lt;- melt(df_out, id.vars = c(&quot;time&quot;, &quot;pH&quot;))
    tail(df_out)
    dim(df_out)
    df_ai &lt;- df_out %&gt;%
        filter(variable %in% vec_met)  # use 1 or both
    dim(df_ai)
    colnames(df_ai)

    # plot nitrate, nitrite
    names(df_ai)[3] &lt;- &quot;Metabolite&quot;  # variable -&gt; Metabolite
    colnames(df_ai)

    df_ai$Metabolite &lt;- ifelse(df_ai$Metabolite == &quot;A&quot;, &quot;Nitrate (NO3-)&quot;, &quot;Nitrite (NO2-)&quot;)
    colnames(df_ai)
    head(df_ai)
    df_ai$value &lt;- ifelse(df_ai$value &lt; 0, 0, df_ai$value)

    ## remove the pH gradient when nitrite does not end at 0mM maximum time
    end_time &lt;- df_ai$time %&gt;%
        max()
    vec_remove_pH &lt;- df_ai %&gt;%
        filter(time == end_time &amp; value &gt; 0.1) %&gt;%
        select(pH) %&gt;%
        unlist()
    print(paste0(&quot;removing dynamics of pH: &quot;, vec_remove_pH))
    df_ai$value &lt;- ifelse(df_ai$pH %in% vec_remove_pH, NA, df_ai$value)

    require(pracma)
    df_a &lt;- df_ai %&gt;%
        filter(Metabolite == &quot;Nitrate (NO3-)&quot;)
    colnames(df_a)
    df_corr &lt;- df_a %&gt;%
        group_by(pH) %&gt;%
        summarize(auc = trapz(time, value)) %&gt;%
        ungroup()

    plot(df_corr$pH, df_corr$auc)

    df_corr$pH_2 &lt;- (df_corr$pH)^2
    fit.no3 &lt;- lm(auc ~ pH + pH_2, df_corr)
    summary(fit.no3)

    perturbpH &lt;- seq(2, 13, 0.1)
    aucPredict &lt;- predict(fit.no3, list(pH = perturbpH, pH_2 = perturbpH^2))
    df_auc_quad &lt;- data.frame(pH = perturbpH, Time_hours = aucPredict)
    plot(perturbpH, aucPredict)

    vec_pH &lt;- unique(df_corr$pH)
    annotate_x = median(vec_pH[!is.na(vec_pH)])
    vec_auc &lt;- unique(df_corr$auc)
    annotate_y = max(vec_auc[!is.na(vec_auc)])

    # (1) Plot fitted linear regression line
    p1 &lt;- ggplot(df_corr, aes(x = pH, y = auc)) + geom_point(size = 2.5, shape = 16,
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ color
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ =
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ &quot;brown&quot;)
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ +
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ #
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ stat_smooth(method
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ =
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ &#39;lm&#39;,
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ formula
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ =
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ y
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ ~
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ x
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ +
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ I(x^2),
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ size
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ =
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ 1)
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ +
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ geom_errorbar(aes(ymin=NO3_mM
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ -
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ sd_NO3_mM,
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ ymax=NO3_mM
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ +
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ sd_NO3_mM),
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ width=.05)+
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ scale_color_brewer(palette=&#39;Set2&#39;)
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ +
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ scale_color_manual(values
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ =
        color = &quot;brown&quot;) + # stat_smooth(method = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(values = c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+ c(&#39;maroon2&#39;,&#39;deepskyblue4&#39;))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ xlab(&quot;perturbed
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ pH
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ \n&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ ylab(&quot;\n
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ Area
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ under
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ curve
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ (NO3-)&quot;)
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ +
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ #
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_x_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,16,1),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 16))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ scale_y_continuous(breaks
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ seq(0,0.3,0.05),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ limits=c(0,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 0.3))+
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ geom_text_repel(aes(label
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ round(NO3_mM,3)),
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ size
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ 3,family=&#39;serif&#39;,
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ show.legend
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ =
    xlab(&quot;perturbed pH \n&quot;) + ylab(&quot;\n Area under curve (NO3-)&quot;) + # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+ scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+  geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family=&#39;serif&#39;, show.legend = FALSE)+ FALSE)+
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line ggtitle(paste0(title))
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line +
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line #
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line geom_abline(slope
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line 1,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line intercept=0,
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line show.legend
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line =
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line &#39;y=x&#39;)+
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line regression
    ggtitle(paste0(title)) + # geom_abline(slope = 1, intercept=0, show.legend = &#39;y=x&#39;)+  regression line line
    geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = &quot;maroon2&quot;,
        size = 1) + # show equation size = 1) + # show equation
    annotate(&quot;text&quot;, x = annotate_x, y = annotate_y, label = paste0(&quot;y = &quot;, round(coef(fit.no3)[[1]],
        3), &quot;+&quot;, round(coef(fit.no3)[[2]], 3), &quot;x+&quot;, round(coef(fit.no3)[[3]], 3),
        &quot;x^2&quot;, &quot;,  R^2: &quot;, round(summary(fit.no3)$r.squared, 3)), color = &quot;maroon2&quot;) +
        mytheme_2d

    p1
    # Smoothness parameter1: R squared
    R_squared &lt;- summary(fit.no3)$r.squared

    # if less than 5 points, R_squared is NA
    if (length(df_corr$auc[!is.na(df_corr$auc)]) &lt; 5) {
        R_squared &lt;- NA
    }

    # Smoothness parameter2: coefficient of variation
    # https://stats.stackexchange.com/questions/24607/how-to-measure-smoothness-of-a-time-series-in-r
    vec_auc &lt;- df_corr %&gt;%
        arrange(pH) %&gt;%
        select(auc) %&gt;%
        unlist()

    # when there is NA at the edges, remove them
    while (is.na(vec_auc[1]) | is.na(vec_auc[length(vec_auc)])) {
        if (is.na(vec_auc[1])) {
            vec_auc = vec_auc[2:length(vec_auc)]
        }
        if (is.na(vec_auc[length(vec_auc)])) {
            vec_auc = vec_auc[1:(length(vec_auc) - 1)]
        }
    }

    # when there is NA, average in between
    for (i in 1:length(vec_auc)) {
        # print(i)
        if (is.na(vec_auc[i])) {
            if (!(i %in% c(1, length(vec_auc)))) {
                vec_auc[i] &lt;- sum(vec_auc[i - 1], vec_auc[i + 1])/2
            }
        }
    }

    vec_diff &lt;- abs(diff(vec_auc))
    # hist(vec_diff)
    sd(vec_diff)
    mean(vec_diff)
    cv &lt;- sd(vec_diff)/mean(vec_diff)  # coefficient of variation

    return(c(R_squared, cv))  # first element is R_squared, and second element is cv
}

k = 50  # number of strains in a community
set.seed(1)
# vec_opt_pH &lt;- runif(k, min=2, max = 12)
vec_opt_pH &lt;- rnorm(k, mean = 7, sd = 3)  # changed the sd to 3
vec_opt_pH[vec_opt_pH &lt; 0] &lt;- 0  # none can go below 0
vec_opt_pH[vec_opt_pH &gt; 14] &lt;- 14  # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI &lt;- runif(k, 0, 15)
set.seed(103)
vec_max_rA &lt;- runif(k, 0, 15)

###### histogram and rI, rA distribution######
hist(vec_opt_pH, xlab = &quot;Optimal pH of strains&quot;, main = &quot;Opt_pH distribution in soil of pH=7&quot;,
    breaks = 14)

# plot rI
g_std = 3
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rI[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rI_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rI parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rI[i]),
        col = &quot;blue&quot;)
}

# plot rA
x &lt;- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean = vec_opt_pH[1], std = g_std, max_height = vec_max_rA[1]),
    xlab = &quot;pH&quot;, ylab = &quot;rA_i&quot;, col = &quot;blue&quot;, type = &quot;l&quot;, lty = 1, pch = 19, lwd = 1,
    main = paste0(&quot;[std = &quot;, g_std, &quot;] Simulating rA parameter of strains in soil of opt_pH = 7&quot;),
    ylim = c(0, 16))

for (i in 2:k) {
    lines(x, gaussian_function(x, mean = vec_opt_pH[i], std = g_std, max_height = vec_max_rA[i]),
        col = &quot;blue&quot;)
}

# A &amp; I
plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5,
    -0.5, by = 0.5), seq(0.5, 5, by = 0.5)), gauss_std = 3, vec_met = c(&quot;A&quot;, &quot;I&quot;),
    title = paste0(&quot;[rI_std = 3] Simulated Area under curve NO3- (n=&quot;, k, &quot;)&quot;), time = 72,
    time_by = 0.01, ode_method = &quot;ode45&quot;, annotate_x = 7, annotate_y = 3)
</code></pre>
<pre><code>Error: &lt;text&gt;:134:24: unexpected &#39;)&#39;
133:  = &#39;lm&#39;, formula = y ~ x + I(x^2), size = 1) +  geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+  scale_color_brewer(palette=&#39;Set2&#39;) +  scale_color_manual(value
134:         color = &quot;brown&quot;)
                            ^</code></pre>
<p>Plot k, std space</p>
<pre><code>Error in smoothness_auc_k_std(k = 50, gauss_std = 3, pH_from = 7, pH_perturb = c(seq(-5, : could not find function &quot;smoothness_auc_k_std&quot;</code></pre>
<pre><code>Error in smoothness_auc_k_std(k = k, gauss_std = gauss_std, pH_from = 7, : could not find function &quot;smoothness_auc_k_std&quot;</code></pre>
<pre><code>[1] 10 10</code></pre>
<pre><code>Error in smoothness_auc_k_std(k = k, gauss_std = gauss_std, pH_from = 7, : could not find function &quot;smoothness_auc_k_std&quot;</code></pre>
<p>Visualization</p>
<pre class="r"><code>vec_k = seq(10, 100, length = 10)
vec_std = seq(1, 6, length = 10)

colnames(mat_Rsquare) &lt;- vec_k
rownames(mat_Rsquare) &lt;- vec_std
colnames(mat_CV) &lt;- vec_k
rownames(mat_CV) &lt;- vec_std

col_bwr &lt;- colorRampPalette(c(&quot;blue&quot;, &quot;white&quot;, &quot;Red&quot;))

hist(c(mat_Rsquare))</code></pre>
<pre><code>Error in hist.default(c(mat_Rsquare)): &#39;x&#39; must be numeric</code></pre>
<pre class="r"><code># R square
m_Rsquare &lt;- melt(mat_Rsquare)
colnames(m_Rsquare)[3] &lt;- &quot;R_square&quot;

ggplot(data = m_Rsquare, aes(x = Var2, y = Var1)) + geom_tile(aes(fill = R_square)) +
    scale_fill_gradientn(colours = col_bwr(100), na.value = &quot;grey90&quot;) + ylab(&quot;Standard deviation of gaussian rI, rA distribution \n&quot;) +
    xlab(&quot;\n Number of strains in the community &quot;) + scale_y_continuous(breaks = seq(1,
    6, 1), labels = 1:6, expand = c(0, 0)) + scale_x_continuous(breaks = seq(10,
    100, 10), labels = vec_k, expand = c(0, 0)) + ggtitle(&quot;Smoothness parameterized by R squared value \n&quot;) +
    mytheme</code></pre>
<pre><code>Error: Discrete value supplied to continuous scale</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-28-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## 3d plot
library(latticeExtra)

cloud(R_square ~ Var2 + Var1, m_Rsquare, panel.3d.cloud = panel.3dbars, col.facet = &quot;grey&quot;,
    xbase = 0.2, ybase = 0.2, xlab = &quot;Number_strains&quot;, ylab = &quot;Std&quot;, scales = list(arrows = FALSE,
        col = 1), par.settings = list(axis.line = list(col = &quot;transparent&quot;)))</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-28-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## scatter plot install.packages(&#39;scatterplot3d&#39;)
library(&quot;scatterplot3d&quot;)
scatterplot3d(melt(mat_Rsquare), pch = 16, color = &quot;steelblue&quot;, angle = 35, type = &quot;h&quot;,
    highlight.3d = T)</code></pre>
<pre><code>Error in plot.window(c(x1, x2), c(z.min, z.max + yz.f * y.max), asp = asp): need finite &#39;ylim&#39; values</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-28-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># s3d &lt;- scatterplot3d(melt(mat), pch = 16, color=&#39;steelblue&#39;, angle = 29,
# type=&#39;h&#39;) text(s3d$xyz.convert(melt(mat)), labels = rownames(melt(mat)), cex=
# 0.8, col = &#39;red&#39;)

# Z-score transformation
mean(c(mat_Rsquare))</code></pre>
<pre><code>[1] NA</code></pre>
<pre class="r"><code>sd(c(mat_Rsquare))</code></pre>
<pre><code>[1] NA</code></pre>
<pre class="r"><code>mat_R_z &lt;- (mat_Rsquare - mean(c(mat_Rsquare)))/sd(c(mat_Rsquare))


# R square - z score
ggplot(data = melt(mat_R_z), aes(x = Var2, y = Var1)) + geom_tile(aes(fill = value)) +
    scale_fill_gradientn(colours = col_bwr(100), na.value = &quot;grey90&quot;) + ylab(&quot;Standard deviation of gaussian rI, rA distribution \n&quot;) +
    xlab(&quot;\n Number of strains in the community &quot;) + scale_y_continuous(breaks = seq(1,
    6, 1), labels = 1:6, expand = c(0, 0)) + scale_x_continuous(breaks = seq(10,
    100, 10), labels = vec_k, expand = c(0, 0)) + ggtitle(&quot;Heatmap \n&quot;) + mytheme

# CV (coefficient of variance)
m_CV &lt;- melt(mat_CV)
colnames(m_CV)[3] &lt;- &quot;CV&quot;
ggplot(data = m_CV, aes(x = Var2, y = Var1)) + geom_tile(aes(fill = CV)) + scale_fill_gradientn(colours = col_bwr(100),
    na.value = &quot;grey40&quot;) + ylab(&quot;Standard deviation of gaussian rI, rA distribution \n&quot;) +
    xlab(&quot;\n Number of strains in the community &quot;) + scale_y_continuous(breaks = seq(1,
    6, 1), labels = 1:6, expand = c(0, 0)) + scale_x_continuous(breaks = seq(10,
    100, 10), labels = vec_k, expand = c(0, 0)) + ggtitle(&quot;Coefficient of variance of AUC increments (smoothness: lower the CV, the smoother) \n&quot;) +
    mytheme</code></pre>
<pre><code>Error: Discrete value supplied to continuous scale</code></pre>
<pre class="r"><code>cloud(value ~ Var2 + Var1, melt(mat_CV), panel.3d.cloud = panel.3dbars, col.facet = &quot;grey&quot;,
    xbase = 2, ybase = 0.2, scales = list(arrows = FALSE, col = 1), par.settings = list(axis.line = list(col = &quot;transparent&quot;)))


scatterplot3d(melt(mat_CV), pch = 16, color = &quot;steelblue&quot;, angle = 35, type = &quot;h&quot;,
    highlight.3d = T)</code></pre>
<pre><code>Error in plot.window(c(x1, x2), c(z.min, z.max + yz.f * y.max), asp = asp): need finite &#39;ylim&#39; values</code></pre>
<p>Choose columns without NA</p>
<pre class="r"><code># CV (coefficient of variance)
mat_CV_trim &lt;- mat_CV[, c(1, 2, 6, 9)]
vec_r_std &lt;- round(vec_std, 1)
rownames(mat_CV_trim) &lt;- vec_r_std
dim(mat_CV_trim)</code></pre>
<pre><code>[1] 10  4</code></pre>
<pre class="r"><code>m_CV_trim &lt;- melt(mat_CV_trim)
colnames(m_CV_trim)[3] &lt;- &quot;CV&quot;
colnames(m_CV_trim)[1] &lt;- &quot;Std&quot;
colnames(m_CV_trim)[2] &lt;- &quot;n_strains&quot;

m_CV_trim$Std &lt;- factor(m_CV_trim$Std)
m_CV_trim$n_strains &lt;- factor(m_CV_trim$n_strains)

ggplot(data = m_CV_trim, aes(x = n_strains, y = Std)) + geom_tile(aes(fill = CV)) +
    scale_fill_gradientn(colours = col_bwr(100), na.value = &quot;grey40&quot;) + ylab(&quot;Standard deviation of gaussian rI, rA distribution \n&quot;) +
    xlab(&quot;\n Number of strains in the community &quot;) + scale_y_discrete(expand = c(0,
    0)) + scale_x_discrete(expand = c(0, 0)) + ggtitle(&quot;Coefficient of variance of AUC increments (smoothness: lower the CV, the smoother) \n&quot;) +
    mytheme</code></pre>
<pre><code>Error: Discrete value supplied to continuous scale</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-29-1.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code>cloud(CV ~ n_strains + Std, m_CV_trim, panel.3d.cloud = panel.3dbars, col.facet = &quot;grey&quot;,
    xbase = 0.2, ybase = 0.2, xlab = &quot;Number_strains&quot;, ylab = &quot;Std&quot;, scales = list(arrows = FALSE,
        col = 1), par.settings = list(axis.line = list(col = &quot;transparent&quot;)))</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-29-2.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># wow the labels changed?
scatterplot3d(m_CV_trim, pch = 16, color = &quot;steelblue&quot;, angle = 35, type = &quot;h&quot;, highlight.3d = F,
    ylab = &quot;Number_strains&quot;, xlab = &quot;Std&quot;)</code></pre>
<pre><code>Error in plot.window(c(x1, x2), c(z.min, z.max + yz.f * y.max), asp = asp): need finite &#39;ylim&#39; values</code></pre>
<p><img src="figure/220207_pH_simulation_1st_trial.Rmd/unnamed-chunk-29-3.png" width="1056" style="display: block; margin: auto;" /></p>
<pre class="r"><code># plot it with line

ggplot(m_CV_trim, aes(x = Std, y = CV, color = n_strains, group = n_strains)) + geom_point(size = 2.5,
    shape = 16) + geom_line(size = 2) + scale_fill_brewer(palette = &quot;Set2&quot;) + ylab(&quot;Coefficient of variance of AUC increments \n&quot;) +
    xlab(&quot;\n Standard deviation of Gaussian rI, rA distribution&quot;) + scale_y_continuous(limit = c(0,
    3.1), expand = c(0, 0)) + ggtitle(&quot;Parameterization of smoothness (smoothness: lower the CV, the smoother) \n&quot;) +
    mytheme_2d</code></pre>
<pre><code>Error: Discrete value supplied to continuous scale</code></pre>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.0.3 (2020-10-10)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 22000)

Matrix products: default

locale:
[1] LC_COLLATE=English_United States.1252 
[2] LC_CTYPE=English_United States.1252   
[3] LC_MONETARY=English_United States.1252
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.1252    

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
 [1] scatterplot3d_0.3-41 latticeExtra_0.6-29  gtable_0.3.0        
 [4] pracma_2.3.3         colorRamps_2.3       gridExtra_2.3       
 [7] rmarkdown_2.9        deSolve_1.28         ggpubr_0.4.0        
[10] ggrepel_0.9.1        ape_5.5              openxlsx_4.2.3      
[13] devtools_2.4.0       usethis_2.0.1        gtools_3.8.2        
[16] reshape2_1.4.4       readxl_1.3.1         magrittr_2.0.1      
[19] forcats_0.5.1        stringr_1.4.0        purrr_0.3.4         
[22] readr_1.4.0          tidyr_1.1.3          tibble_3.0.4        
[25] tidyverse_1.3.1      vegan_2.5-7          lattice_0.20-41     
[28] permute_0.9-5        RColorBrewer_1.1-2   ggplot2_3.3.5       
[31] dplyr_1.0.5          knitr_1.37           workflowr_1.6.2     

loaded via a namespace (and not attached):
 [1] colorspace_2.0-0  ggsignif_0.6.2    ellipsis_0.3.2    rio_0.5.27       
 [5] rprojroot_2.0.2   fs_1.5.0          rstudioapi_0.13   farver_2.1.0     
 [9] remotes_2.4.0     fansi_0.4.2       lubridate_1.7.10  xml2_1.3.2       
[13] splines_4.0.3     cachem_1.0.4      pkgload_1.2.1     jsonlite_1.7.2   
[17] broom_0.7.9       cluster_2.1.0     dbplyr_2.1.1      png_0.1-7        
[21] compiler_4.0.3    httr_1.4.2        backports_1.2.1   assertthat_0.2.1 
[25] Matrix_1.2-18     fastmap_1.1.0     cli_3.0.1         formatR_1.11     
[29] later_1.2.0       htmltools_0.5.1.1 prettyunits_1.1.1 tools_4.0.3      
[33] glue_1.4.2        Rcpp_1.0.5        carData_3.0-4     cellranger_1.1.0 
[37] jquerylib_0.1.4   vctrs_0.3.8       nlme_3.1-149      xfun_0.29        
[41] ps_1.6.0          testthat_3.0.2    rvest_1.0.1       lifecycle_1.0.0  
[45] rstatix_0.7.0     MASS_7.3-53       scales_1.1.1      hms_1.1.0        
[49] promises_1.2.0.1  parallel_4.0.3    yaml_2.2.1        curl_4.3.2       
[53] memoise_2.0.0     sass_0.4.0        stringi_1.5.3     highr_0.9        
[57] desc_1.3.0        pkgbuild_1.2.0    zip_2.1.1         rlang_0.4.10     
[61] pkgconfig_2.0.3   evaluate_0.14     labeling_0.4.2    tidyselect_1.1.1 
[65] processx_3.5.1    plyr_1.8.6        R6_2.5.0          generics_0.1.0   
[69] DBI_1.1.1         pillar_1.6.0      haven_2.4.1       whisker_0.4      
[73] foreign_0.8-80    withr_2.4.2       mgcv_1.8-33       abind_1.4-5      
[77] modelr_0.1.8      crayon_1.4.1      car_3.0-11        utf8_1.1.4       
[81] jpeg_0.1-9        data.table_1.14.0 callr_3.7.0       git2r_0.28.0     
[85] reprex_2.0.0      digest_0.6.27     httpuv_1.6.0      munsell_0.5.0    
[89] bslib_0.2.5.1     sessioninfo_1.1.1</code></pre>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
