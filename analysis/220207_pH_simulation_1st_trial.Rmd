---
title: "220207_pH_simulation_1st_trial"
author: "KiseokLee"
date: "2022-02-07"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(fig.width=11, fig.height=9,
                      error=TRUE, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE,
                      tidy.opts=list(width.cutoff=40),tidy=TRUE)
```

## 220207 Denitrification and pH perturbation simulation first trial 
Name: **Kiseok Lee** \
Date: 2/7/22 \
Lab: **Seppe Kuehn lab**

```{r, echo=FALSE}
# libraries
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(vegan)
library(tidyverse)
library(magrittr)
library(readxl)
library(reshape2)
library(gtools)
library(devtools)
library(openxlsx)
library(ape)
library(stringr)
library(tidyr)
library(ggrepel)
library(ggpubr)
library(deSolve)

## theme for ggplot
mytheme <- theme_bw() + 
  theme(text = element_text(family="serif")) +
  theme(plot.title = element_text(size = 19,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10, family="serif"))+
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank(),panel.background=element_blank(),panel.border=element_blank(),plot.background=element_blank())+
  theme(axis.ticks = element_line(size = 1.1))

mytheme_2d <- theme_bw() + 
  theme(text = element_text(family="serif")) +
  theme(plot.title = element_text(size = 19,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=13, family="serif"))+
  # theme(panel.grid.major = element_blank()) +
  # theme(panel.grid.minor = element_blank(),panel.background=element_blank(),plot.background=element_blank()) +
  theme(axis.ticks = element_line(size = 1.1))
  # theme(legend.text=element_text(size=13))


# color collection
my_color_collection <- c(
  "#CBD588", "#5F7FC7", "orange", "#AD6F3B", "#673770", 
  "#D14285", "#652926", "#C84248", "#8569D5", "#5E738F",
  "#D1A33D", "#8A7C64", "#599861","#616163", "#FFCDB2",
  "#6D9F71", "#242F40",
  "#CCA43B", "#F92A82", "#ED7B84", "#7EB77F", 
  "#DEC4A1", "#E5D1D0", '#0E8482', '#C9DAEA', '#337357', 
  '#95C623', '#E55812', '#04471C', '#F2D7EE', '#D3BCC0', 
  '#A5668B', '#69306D', '#0E103D', '#1A535C', '#4ECDC4', 
  '#F7FFF7', '#FF6B6B', '#FFE66D', '#6699CC', '#FFF275', 
  '#FF8C42', '#FF3C38', '#A23E48', '#000000', '#CF5C36', 
  '#EEE5E9', '#7C7C7C', '#EFC88B', '#2E5266', '#6E8898', 
  '#9FB1BC', '#D3D0CB', '#E2C044', '#5BC0EB', '#FDE74C', 
  '#9BC53D', '#E55934', '#FA7921', "#CD9BCD", "#508578", "#DA5724")

# for git push, use this instead of using wflow_git_push()
# git push -u origin master (in the Git app / in the working directory)

# for making pdf file
library(rmarkdown)
# render("analysis/~~.Rmd", "pdf_document")

```

## 1. Setting up 

## 1.1. First let's set up the consumer resource model dynamics

```{r}
## Consumer resource model
#' @param x cell biomass (OD)
#' @param I nitrite concentration (mM)
#' @param A nitrate concentration (mM)
#' @param gamI biomass yields from nitrite (OD/mM)
#' @param gamA biomass yields from nitrate (OD/mM)
#' @param rI reduction rate of nitrite ((mM/OD)/h)
#' @param rA reduction rate of nitrate ((mM/OD)/h)
#' @param kI half velocity constant of nitrate reduction (mM)
#' @param kA half velocity constant of nitrate reduction (mM)

# set up the Consumer Resource model ode
crGrowth <- function(t, state, parameters) {
  with(as.list(c(state, parameters)),{
  # biomass
  dx <- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
  # nitrate
  dA <- - rA*(A/(kA + A)) *x
  # nitrite
  dI <- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
  list(c(dx, dA, dI))
  }) # end with(as.list ...
} 

parameters <- c(gamI=0.01, rI=1.6, gamA=0.01, rA=3.1, kI = 0.01, kA = 0.01)
parameters <- c(gamI=1, rI=1, gamA=1, rA=1, kI = 1, kA = 1)

state <- c(x = 2, A = 2, I = 0 )

times <- seq(0, 10, by = 1)
outc <- ode(state, times, crGrowth, parameters, method = "lsoda", atol = 1e-4, rtol = 1e-4)
outc

plot(outc, xlab = "time", ylab = "-")
plot(outc, xlab="Time (hr)", ylab=c("Biomass (OD)","Nitrite (mM)","Nitrate (mM)"), col='black', type = "l",lty = 1, pch=19,lwd=1, main="Consumer Resource model")

```


## 1.2. Enable many strains (community level dynamics)

```{r}
# set up the Consumer Resource model ode
parameters = list(gamI=c(0.01,0.02), rI =c(1.6,1.5), gamA= c(0.01,0.02), rA = c(3.1,3.2), kI = c(0.01,0.02), kA = c(0.01,0.02))
state = list(x = c(2,3), A = 2, I = 0)

crGrowth <- function(t,state, parameters ) {
  with(as.list(c(state, parameters)),{
    
    dx <- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
    print(paste0("dx: ",dx))
    # nitrate
    dA <- - rA*(A/(kA + A)) *x
    print(paste0("dA: ",dA))
    # nitrite
    dI <- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
    print(paste0("dI: ",dI))
    # print(paste0("return sum(dI): ", sum(dI)))
    # print(paste0("Please return the values in the same order as state variable"))
    list( c(dx, sum(dA), sum(dI)) )
  }) # end with(as.list ...
}

crGrowth(t=1, state, parameters)
crGrowth(t=2, state, parameters)
crGrowth(t=3, state, parameters)
crGrowth(t=4, state, parameters)

# ODE solver
times <- seq(0, 10, by = 0.1)
outc <- ode(unlist(state), times, crGrowth, parameters, method = "vode", atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
outc

# plot
n_strains <- length(state$x)
plot(outc, xlab = "time", ylab = "")
plot(outc, xlab="Time (hr)", ylab=c(rep("Biomass (OD)",n_strains),"Nitrate NO3- (mM)","Nitrite NO2- (mM)"), col='black', type = "l",lty = 1, pch=19,lwd=1, main="Consumer Resource model")


## test if it is correct
# just with first component x1
parameters1 = list(gamI=c(0.01), rI =c(1.6), gamA= c(0.01), rA = c(3.1), kI = c(0.01), kA = c(0.01))
state1 = list(x = c(0.01), A = 2, I = 0)

gamI=c(0.01); rI =c(1.6); gamA= c(0.01); rA = c(3.1); kI = c(0.01); kA = c(0.01)
x = c(0.01); A = 2; I = 0
(gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x

# set up the Consumer Resource model ode
crGrowth(t=1, state1, parameters1) # 0.06169154 -6.16915423  6.16915423

# then with second compnent x2
parameters2 = list(gamI=c(0.02), rI =c(1.5), gamA= c(0.02), rA = c(3.2), kI = c(0.02), kA = c(0.02))
state2 = list(x = c(0.01), A = 2, I = 0)

gamI=c(0.02); rI =c(1.5); gamA= c(0.02); rA = c(3.2); kI = c(0.02); kA = c(0.02)
x = c(0.01); A = 2; I = 0
(gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
crGrowth(t=1, state2, parameters2) # 0.190099 -9.504950  9.504950

# sum up 
# 0.06169154, 0.190099  -15.6741 15.6741
parameters = list(gamI=c(0.01,0.02), rI =c(1.6,1.5), gamA= c(0.01,0.02), rA = c(3.1,3.2), kI = c(0.01,0.02), kA = c(0.01,0.02))
state = list(x = c(0.01,0.01), A = 2, I = 0)
crGrowth(t=1, state, parameters)

parameters3 = list(gamI=c(0.01,0.02,0.03), rI =c(1.6,1.5,1.2), gamA= c(0.01,0.02,0.03), rA = c(3.1,3.2,2), kI = rep(0.01,3), kA = rep(0.01,3))
state3 = list(x = c(1,1,1), A = 2, I = 0)
crGrowth(t=1, state3, parameters3)

```
The new crGrowth function seems to be doing a good job summing up all dA/dt from x1, x2.

## 1.3. Let's simulate a community
Let's say we have n strains
```{r}
# set up the Consumer Resource model ode
crGrowth <- function(t,state, parameters ) {
  with(as.list(c(state, parameters)),{
    dx <- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
    # nitrate
    dA <- - rA*(A/(kA + A)) *x
    # nitrite
    dI <- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
    # print(paste0("dI: ",dI))
    # print(paste0("return sum(dI): ", sum(dI)))
    # print(paste0("Please return the values in the same order as state variable"))
    list( c(dx, sum(dA), sum(dI)) )
  }) # end with(as.list ...
}

## as in Karna's paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna's paper)
## rI, rA max is 15 (from Karna's paper)
k = 10
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(1,k), A = 2, I = 0)

# hist(rpois(1000, lambda = 4))

crGrowth(t=1, state, parameters)

# ODE solver
times <- seq(0, 10, by = 0.1)
outc <- ode(unlist(state), times, crGrowth, parameters, method = "vode", atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
outc

# plot
n_strains <- length(state$x)
plot(outc, xlab = "time", ylab = "")
plot(outc, xlab="Time (hr)", ylab=c(rep("Biomass (OD)",n_strains),"Nitrate NO3- (mM)","Nitrite NO2- (mM)"), col='black', type = "l",lty = 1, pch=19,lwd=1, main="Consumer Resource model")

# using ggplot to get 3 graphs
colnames(outc)
class(outc)
df_out <- as.data.frame(outc)
head(df_out)
df_out <- melt(df_out, id.vars = c("time"))
dim(df_out)
df_com <- df_out %>% filter(!(variable %in% c("A","I")))
dim(df_com)
tail(df_com)
df_ai <- df_out %>% filter(variable %in% c("A","I"))
dim(df_ai)

# plot strain dynamics
names(df_com)[2] <- "Strain" 

p_strain <- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  # scale_color_manual(values=grad_pH) +
  ylab("Biomass (OD) \n") +
  xlab("\n Time (hr)") +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  expand_limits(y=0) +
  ggtitle("Consumer-resource model community dynamics \n") +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))

p_strain

# plot nitrate, nitrite
names(df_ai)[2] <- "Metabolite"
df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")

p_ai <- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
  ylab("Nitrate or Nitrite (mM) \n") +
  xlab("\n Time (hr)") +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  # expand_limits(y=0) +
  ggtitle("Metabolite dynamics \n") +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
p_ai

df_i <- df_ai %>% filter(Metabolite == "Nitrite (NO2-)")
p_nitrite <- ggplot(df_i, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  scale_color_manual(values=c("#ad4620")) + ## blue = nitrate, red = nitrite
  ylab("Nitrite (mM) \n") +
  xlab("\n Time (hr)") +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  # expand_limits(y=0) +
  ggtitle("Nitrite close-up dynamics \n") +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
p_nitrite

require(gridExtra)
grid.arrange(p_strain, p_ai, p_nitrite, nrow=1)



```

## 1.4. Wrap this into a function

```{r}
# set up the Consumer Resource model ode
crGrowth <- function(t,state, parameters ) {
  with(as.list(c(state, parameters)),{
    dx <- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
    # nitrate
    dA <- - rA*(A/(kA + A)) *x
    # nitrite
    dI <- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
    # print(paste0("dI: ",dI))
    # print(paste0("return sum(dI): ", sum(dI)))
    # print(paste0("Please return the values in the same order as state variable"))
    return(list( c(dx, sum(dA), sum(dI)) ))
  }) # end with(as.list ...
}

# plot community dynamics, metabolite, nitrite close up

## as in Karna's paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna's paper)
## rI, rA max is 15 (from Karna's paper)
k = 10 # number of strains in a community
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(1,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))

plot_3results <- function(time = 10, time_by = 0.01,  parameters, state){
  # ODE solver
  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state), times, crGrowth, parameters, method = "vode", atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out <- as.data.frame(outc)
  head(df_out)
  df_out <- melt(df_out, id.vars = c("time"))
  dim(df_out)
  df_com <- df_out %>% filter(!(variable %in% c("A","I")))
  dim(df_com)
  tail(df_com)
  df_ai <- df_out %>% filter(variable %in% c("A","I"))
  dim(df_ai)
  
  # plot strain dynamics
  names(df_com)[2] <- "Strain" 
  
  p_strain <- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=grad_pH) +
    ylab("Biomass (OD) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Consumer-resource model community dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_strain
  
  # plot nitrate, nitrite
  names(df_ai)[2] <- "Metabolite"
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  
  p_ai <- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
    ylab("Nitrate or Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Metabolite dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_ai
  
  df_i <- df_ai %>% filter(Metabolite == "Nitrite (NO2-)")
  p_nitrite <- ggplot(df_i, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c("#ad4620")) + ## blue = nitrate, red = nitrite
    ylab("Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Nitrite close-up dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_nitrite
  
  require(gridExtra)
  return(grid.arrange(p_strain, p_ai, p_nitrite, nrow=1))
}

plot_2results <- function(title, time = 10, time_by = 0.01, ode_method = "vode", parameters, state){
  # ODE solver
  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out <- as.data.frame(outc)
  head(df_out)
  df_out <- melt(df_out, id.vars = c("time"))
  dim(df_out)
  df_com <- df_out %>% filter(!(variable %in% c("A","I")))
  dim(df_com)
  tail(df_com)
  df_ai <- df_out %>% filter(variable %in% c("A","I"))
  dim(df_ai)
  
  # plot strain dynamics
  names(df_com)[2] <- "Strain" 
  
  p_strain <- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=grad_pH) +
    ylab("Biomass (OD) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(paste0(title," \n")) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_strain
  
  # plot nitrate, nitrite
  names(df_ai)[2] <- "Metabolite"
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  df_ai$value <- ifelse(df_ai$value < 0, 0, df_ai$value)
  
  p_ai <- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
    ylab("Nitrate or Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Metabolite dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  require(gridExtra)
  return(grid.arrange(p_strain, p_ai, nrow=1))
}

## testing if the function works
## as in Karna's paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna's paper)
## rI, rA max is 15 (from Karna's paper)
k = 10 # number of strains in a community
set.seed(2)
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.01,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = "Consumer resource model: uniformly sampled model parameters",time = 30, time_by= 0.01,  parameters=parameters, state=state)

```

## 1.5. Why is the time scale so fast?

```{r}
k = 3 # number of strains in a community
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.0001,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = "Consumer resource model",time = 30, time_by = 0.01, parameters=parameters, state=state)


```

## 1.6. Let's import Karna SDM(succinate defined media) and plot those dynamics

```{r}
df_karna <- read.csv("data/consumer_resource_parameters_SDM.csv") # succinate defined media 
names(df_karna)[1] <- "Strain"

head(df_karna)
df_karna[1,]
parameters = c(rA = df_karna[1,2], gamA = df_karna[1,3], rI = df_karna[1,4], gamI = df_karna[1,5], kI = 0.01, kA = 0.01) 
state = list(x = 0.01, A = 2, I = 0)
plot_2results(title = "Consumer resource model (1 strain: ACM01)",time = 30, time_by = 0.01, parameters=parameters, state=state)

# Another strain
head(df_karna)
df_karna[1,]
strain_i = 2
parameters = c(rA = df_karna[strain_i,2], gamA = df_karna[strain_i,3], rI = df_karna[strain_i,4], gamI = df_karna[strain_i,5], kI = 0.01, kA = 0.01) 
state = list(x = 0.01, A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (1 strain:", df_karna[strain_i,1],")"),time = 30, time_by = 0.01, parameters=parameters, state=state)

```

## 1.7. Validate with 2 strain community
There is sth wrong with my ode function
```{r}
# 2 strain
head(df_karna)
df_2strain <- df_karna %>% filter(Strain %in% c("ACV02","AGB01"))

k = 2
vec_strain = 1:k
parameters = list(rA = df_2strain[vec_strain,2], gamA = df_2strain[vec_strain,3], rI = df_2strain[vec_strain,4], gamI = df_2strain[vec_strain,5], kI = rep(0.01,k), kA = rep(0.01,k))
state = list(x = c(0.01,0.01), A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (2 strain:", df_2strain[1,1],"+",df_2strain[2,1],")"),time = 72, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

```


## 1.8. 10 strains from real data

```{r}

head(df_karna)
dim(df_karna)

# randomly pick k=10 strains
k=10
set.seed(1)
vec_strain = sample(1:nrow(df_karna), k, replace = F)

parameters = list(rA = df_karna[vec_strain,2], gamA = df_karna[vec_strain,3], rI = df_karna[vec_strain,4], gamI = df_karna[vec_strain,5], kI = rep(0.01,k), kA = rep(0.01,k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (", k," Karna strains)"),time = 30, time_by = 0.01, parameters=parameters, state=state)


```

## 1.9. 5 strains from real data parameters

```{r}

head(df_karna)
dim(df_karna)

# randomly pick k=10 strains
k=5
set.seed(1)
vec_strain = sample(1:nrow(df_karna), k, replace = F)

parameters = list(rA = df_karna[vec_strain,2], gamA = df_karna[vec_strain,3], rI = df_karna[vec_strain,4], gamI = df_karna[vec_strain,5], kI = rep(0.01,k), kA = rep(0.01,k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (", k," Karna strains)"),time = 30, time_by = 0.01, parameters=parameters, state=state)

```

## 1.10. 5 strains from randomly sampled parameters
```{r}
k = 5 # number of strains in a community
set.seed(2)
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.01,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = "Consumer resource model: uniformly sampled model parameters",time = 30, time_by= 0.01,  parameters=parameters, state=state)


```


## 2. Now simulate pH perturbation
(1) First, simulate rI_i dependent on pH (gaussian distribution of mean = opt_pH)
(2) Second, construct soil community of pH 7, where relative abundance of strains with opt_pH is high.
(3) Third, perturb the pH and see how it changes.

## 2.1. First step: simulate rI_i dependent on pH
```{r}

# Constructing Gaussian function
par(mfrow=c(1,1))
hist(rnorm(1000, mean = 7, sd =1))

# function
gaussian_function <- function(x, std, mean, max_height=0.3989423){
  factor = max_height * std*sqrt(2*pi)
  return(factor*(1/ (std * sqrt(2*pi)))*exp((-0.5)*( (x - mean) / std)^2))
}

# gaussian function
x <- seq(-3, 3, by = 0.01)
plot(x, gaussian_function(x, mean=0, std=1))

# rI_i
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=7, std=2, max_height=15), xlab = "pH",ylab = "rI_i",
     main = "Gaussian distribution of rI parameter of strain with opt_pH = 7")

# simulate many rI_i
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=7, std=2, max_height=15), xlab = "pH",ylab = "rI_i",
     main = "Simulating rI parameter of strain with various opt_pH")

rand_pH <- runif(1000, 0, 14)
for (i in rand_pH){
  lines(x, gaussian_function(x, mean=i, std=2, max_height=15))
}

## Create a soil sample with pH = 7
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=7, std=1), xlab = "optimal_pH of strains",ylab = "Relative abundance of strains",col='black', type = "l",lty = 1, pch=19,lwd=1, main = "Relative abundance of stains with optimal pH values (Soil native pH = 7)")
abline(v=7, lty = 3, col = 'blue')
abline(v=6, lty = 3, col = 'red')

## 100 strains, standard deviation 2
set.seed(1)
vec_opt_pH <- rnorm(100, mean = 7, sd = 3)
vec_opt_pH[vec_opt_pH<0] <- 0 # none can go below 0
vec_opt_pH[vec_opt_pH>14] <- 14 # none can go above 14

hist(vec_opt_pH, xlab = "Optimal pH of strains", main = "Opt_pH distribution in soil of pH=7")

# plot rI
x <- seq(0, 14, by = 0.01)
start <- vec_opt_pH[1]
plot(x, gaussian_function(x, mean=start, std=2, max_height=15), xlab = "pH",ylab = "rI_i", col='blue', type = "l",lty = 1, pch=19,lwd=1,
     main = "Simulating rI parameter of strains in soil of pH = 7")

for (i in vec_opt_pH[2:length(vec_opt_pH)]){
  lines(x, gaussian_function(x, mean=i, std=2, max_height=15), col='blue')
}


```

## 2.1.1. Dynamics of soil pH at 7
- This is a 100 strain community in a soil of original pH 7 \
- Scenario 1: only rI is influenced by pH

```{r}
## rI when current pH is 7
vec_rI = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at natural state, pH=7"),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

```
Need to find a sweet spot... uses up nitrate too fast...

## 2.1.2. Perturb the pH to 6 and so on

```{r}
## when we perturb the pH
# plot rI
par(mfrow=c(1,1))
x <- seq(0, 14, by = 0.01)
start <- vec_opt_pH[1]
plot(x, gaussian_function(x, mean=start, std=2, max_height=15), xlab = "pH",ylab = "rI_i", col='blue', type = "l",lty = 1, pch=19,lwd=1,
     main = "Simulating rI parameter of strains in soil of pH = 7")

for (i in vec_opt_pH[2:length(vec_opt_pH)]){
  lines(x, gaussian_function(x, mean=i, std=2, max_height=15), col='blue')
}
abline(v=7, lty = 3, col = 'blue')
abline(v=6, lty = 3, col = 'red')

## rI at perturbed to pH 6
current_pH = 6
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH6"),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

## rI at perturbed to pH 5
current_pH = 5
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH ",current_pH),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

## rI at perturbed to pH 4
current_pH = 4
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH ",current_pH),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

## rI at perturbed to pH 3
current_pH = 3
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH ",current_pH),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

## basic
## rI at perturbed to pH 8
current_pH = 8
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH ",current_pH),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

## rI at perturbed to pH 9
current_pH = 9
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH ",current_pH),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

## rI at perturbed to pH 10
current_pH = 10
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH ",current_pH),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

## rI at perturbed to pH 11
current_pH = 11
vec_rI = gaussian_function(x=current_pH, mean=vec_opt_pH, std=2, max_height=15)
length(vec_rI)

k=100
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Community dynamics at perturbed from pH 7 to pH ",current_pH),time = 30, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")



```
I think this is because I am controlling only controlling the nitrite reductase.

## 2.1.3. Let me tune the parameters so I get slower dynamics
```{r}

## 100 strains, standard deviation 2
set.seed(1)
k = 100 # number of strains in a community
vec_opt_pH <- rnorm(k, mean = 7, sd = 3) # changed the sd to 3
vec_opt_pH[vec_opt_pH<0] <- 0 # none can go below 0
vec_opt_pH[vec_opt_pH>14] <- 14 # none can go above 14

hist(vec_opt_pH, xlab = "Optimal pH of strains", main = "Opt_pH distribution in soil of pH=7")


# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI <- runif(k, 0, 15)

# plot rI
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=2, max_height= vec_max_rI[1]), xlab = "pH",ylab = "rI_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rI parameter of strains in soil of pH = 7", ylim=c(0,16))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=2, max_height= vec_max_rI[i]), col='blue')
}

# plot dynamics
## rI when current pH is 7
vec_rI = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=vec_max_rI)
length(vec_rI)

k=100
set.seed(31)
parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01,k), A = 2, I = 0)
set.seed(31)
plot_2results(title = paste0("Community dynamics at natural state, pH=7"),time = 2, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

```

## 2.1.4. Let's correlate rA also with pH

```{r}
dev.off()

# function
gaussian_function <- function(x, std, mean, max_height=0.3989423){
  factor = max_height * std*sqrt(2*pi)
  return(factor*(1/ (std * sqrt(2*pi)))*exp((-0.5)*( (x - mean) / std)^2))
}

## 100 strains, standard deviation 2
set.seed(1)
k = 100 # number of strains in a community
vec_opt_pH <- rnorm(k, mean = 7, sd = 3) # changed the sd to 3
vec_opt_pH[vec_opt_pH<0] <- 0 # none can go below 0
vec_opt_pH[vec_opt_pH>14] <- 14 # none can go above 14

hist(vec_opt_pH, xlab = "Optimal pH of strains", main = "Opt_pH distribution in soil of pH=7")


# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI <- runif(k, 0, 15)
vec_max_rA <- runif(k, 0, 15)


# plot rI
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=2, max_height= vec_max_rI[1]), xlab = "pH",ylab = "rI_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rI parameter of strains in soil of pH = 7", ylim=c(0,16))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=2, max_height= vec_max_rI[i]), col='blue')
}

# plot rA
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=2, max_height= vec_max_rA[1]), xlab = "pH",ylab = "rA_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rA parameter of strains in soil of pH = 7", ylim=c(0,16))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=2, max_height= vec_max_rA[i]), col='blue')
}

# plot dynamics
## rI when current pH is 7
vec_rI = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=vec_max_rI)
length(vec_rI)
vec_rA = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=vec_max_rA)
length(vec_rA)

k=100
parameter_1 = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state_1 = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("[rI & rA] Community dynamics at natural state, pH=7"),time = 2, time_by = 0.01, parameters=parameter_1, state=state_1, ode_method = "vode")

```

## 2.1.5. Plot the perturbation levels with simulation


```{r}

plot_perturbation <- function(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met =c("A","I"), title, time = 10, time_by = 0.01, ode_method = "vode"){
  # ODE solver
  k = length(vec_opt_pH)
  vec_rI = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
  vec_rA = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
  set.seed(4)
  parameter_1 = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
  state_1 = list(x = rep(0.01,k), A = 2, I = 0)

  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
  df_out <- as.data.frame(outc)
  df_out$pH <- pH_from
  dim(df_out)
  
  for (i in pH_perturb){
    pH_to = pH_from + i
    print(pH_to)
    vec_rI = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
    # print(tail(vec_rI))
    # print(tail(vec_rA))
    vec_rA = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
    set.seed(4)
    parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    # print(parameter$rI)
    states = list(x = rep(0.01,k), A = 2, I = 0)
    outc <- ode(unlist(states), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_add <- as.data.frame(outc)
    df_add$pH <- pH_to
    df_out <- rbind(df_out,df_add)
  }
  colnames(df_out)
  df_out <- melt(df_out, id.vars = c("time", "pH"))
  tail(df_out)
  dim(df_out)
  df_ai <- df_out %>% filter(variable %in% vec_met) # use 1 or both
  dim(df_ai)
  colnames(df_ai)
  
  # plot nitrate, nitrite
  names(df_ai)[3] <- "Metabolite" # variable -> Metabolite
  colnames(df_ai)
  
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  colnames(df_ai)
  head(df_ai)
  df_ai$value <- ifelse(df_ai$value < 0, 0, df_ai$value)
  
  # pH color
  col_pH <- colorRampPalette(c("purple",'red',"gold"))

  library(colorRamps)
  df_ai %>% select(Metabolite) %>% unique()
  df_ai %>% select(pH) %>% unique()

  ggplot(df_ai, aes(x=time, y=value, color=pH, group=pH)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
    scale_colour_gradientn(colours = col_pH(100)) +
    ylab("Nitrate or Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    scale_y_continuous(breaks = seq(0,2,0.25), limits=c(0, 2))+
    # expand_limits(y=0) +
    ggtitle(paste0(title," \n")) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d +
    facet_grid(. ~ Metabolite) +
    theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
}

# A & I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c("A","I"), title = "pH perturbation simulation", time = 10, time_by = 0.01, ode_method = "vode")

# A
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c("A"), title = "pH perturbation simulation (n=100)", time = 1, time_by = 0.01, ode_method = "vode")

# I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met = c("I"), title = "pH perturbation simulation (n=100)", time = 1, time_by = 0.01, ode_method = "vode")




# df_ai_7 <- df_ai %>% filter(pH %in% c(7))
# 
# ggplot(df_ai_7, aes(x=time, y=value, color=pH, group=pH)) +
#     # geom_point(size=2.5, shape=16) +
#     geom_line(size=1.2)+
#     # scale_colour_gradientn(colours = col_pH(100)) +
#     # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
#     scale_colour_gradientn(colours = col_pH(100)) +
#     ylab("Nitrate or Nitrite (mM) \n") +
#     xlab("\n Time (hr)") +
#     # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#     # expand_limits(y=0) +
#     ggtitle("Metabolite dynamics \n") +
#     # label
#     # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
#     mytheme_2d +
#     facet_grid(. ~ Metabolite) +
#     theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
# 
# df_ai_8 <- df_ai %>% filter(pH %in% c(8))
# 
# ggplot(df_ai_8, aes(x=time, y=value, color=pH, group=pH)) +
#     # geom_point(size=2.5, shape=16) +
#     geom_line(size=1.2)+
#     # scale_colour_gradientn(colours = col_pH(100)) +
#     # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
#     scale_colour_gradientn(colours = col_pH(100)) +
#     ylab("Nitrate or Nitrite (mM) \n") +
#     xlab("\n Time (hr)") +
#     # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#     # expand_limits(y=0) +
#     ggtitle("Metabolite dynamics \n") +
#     # label
#     # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
#     mytheme_2d +
#     facet_grid(. ~ Metabolite) +
#     theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
# 
# df_ai_9 <- df_ai %>% filter(pH %in% c(9))
# 
# ggplot(df_ai_9, aes(x=time, y=value, color=pH, group=pH)) +
#     # geom_point(size=2.5, shape=16) +
#     geom_line(size=1.2)+
#     # scale_colour_gradientn(colours = col_pH(100)) +
#     # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
#     scale_colour_gradientn(colours = col_pH(100)) +
#     ylab("Nitrate or Nitrite (mM) \n") +
#     xlab("\n Time (hr)") +
#     # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#     # expand_limits(y=0) +
#     ggtitle("Metabolite dynamics \n") +
#     # label
#     # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
#     mytheme_2d +
#     facet_grid(. ~ Metabolite) +
#     theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
# 
# df_ai_10 <- df_ai %>% filter(pH %in% c(10))
# 
# ggplot(df_ai_10, aes(x=time, y=value, color=pH, group=pH)) +
#     # geom_point(size=2.5, shape=16) +
#     geom_line(size=1.2)+
#     # scale_colour_gradientn(colours = col_pH(100)) +
#     # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
#     scale_colour_gradientn(colours = col_pH(100)) +
#     ylab("Nitrate or Nitrite (mM) \n") +
#     xlab("\n Time (hr)") +
#     # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#     # expand_limits(y=0) +
#     ggtitle("Metabolite dynamics \n") +
#     # label
#     # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
#     mytheme_2d +
#     facet_grid(. ~ Metabolite) +
#     theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
# 
# df_ai_5 <- df_ai %>% filter(pH %in% c(5))
# ggplot(df_ai_5, aes(x=time, y=value, color=pH, group=pH)) +
#     # geom_point(size=2.5, shape=16) +
#     geom_line(size=1.2)+
#     # scale_colour_gradientn(colours = col_pH(100)) +
#     # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
#     scale_colour_gradientn(colours = col_pH(100)) +
#     ylab("Nitrate or Nitrite (mM) \n") +
#     xlab("\n Time (hr)") +
#     # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#     # expand_limits(y=0) +
#     ggtitle("Metabolite dynamics \n") +
#     # label
#     # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
#     mytheme_2d +
#     facet_grid(. ~ Metabolite) +
#     theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
# 
# df_ai_6 <- df_ai %>% filter(pH %in% c(6))
# ggplot(df_ai_6, aes(x=time, y=value, color=pH, group=pH)) +
#     # geom_point(size=2.5, shape=16) +
#     geom_line(size=1.2)+
#     # scale_colour_gradientn(colours = col_pH(100)) +
#     # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
#     scale_colour_gradientn(colours = col_pH(100)) +
#     ylab("Nitrate or Nitrite (mM) \n") +
#     xlab("\n Time (hr)") +
#     # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#     # expand_limits(y=0) +
#     ggtitle("Metabolite dynamics \n") +
#     # label
#     # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
#     mytheme_2d +
#     facet_grid(. ~ Metabolite) +
#     theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
# 
# df_ai_4 <- df_ai %>% filter(pH %in% c(4))
# ggplot(df_ai_4, aes(x=time, y=value, color=pH, group=pH)) +
#     # geom_point(size=2.5, shape=16) +
#     geom_line(size=1.2)+
#     # scale_colour_gradientn(colours = col_pH(100)) +
#     # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
#     scale_colour_gradientn(colours = col_pH(100)) +
#     ylab("Nitrate or Nitrite (mM) \n") +
#     xlab("\n Time (hr)") +
#     # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#     # expand_limits(y=0) +
#     ggtitle("Metabolite dynamics \n") +
#     # label
#     # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
#     mytheme_2d +
#     facet_grid(. ~ Metabolite) +
#     theme(strip.background = element_rect(colour="black", fill="white", size=0.1))


```

## 2.1.5.1. Decrease the number of strains
If it goes above 50 strains, nitrite goes crazy
```{r}

## 15 strains, standard deviation 2
set.seed(1)
k = 15 # number of strains in a community
vec_opt_pH <- rnorm(k, mean = 7, sd = 3) # changed the sd to 3
vec_opt_pH[vec_opt_pH<0] <- 0 # none can go below 0
vec_opt_pH[vec_opt_pH>14] <- 14 # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI <- runif(k, 0, 15)
vec_max_rA <- runif(k, 0, 15)

###### histogram and rI, rA distribution######
hist(vec_opt_pH, xlab = "Optimal pH of strains", main = "Opt_pH distribution in soil of pH=7", breaks = 14)

# plot rI
g_std = 3
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=g_std, max_height= vec_max_rI[1]), xlab = "pH",ylab = "rI_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rI parameter of strains in soil of opt_pH = 7", ylim=c(0,16))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=g_std, max_height= vec_max_rI[i]), col='blue')
}

# plot rA
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=g_std, max_height= vec_max_rA[1]), xlab = "pH",ylab = "rA_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rA parameter of strains in soil of opt_pH = 7", ylim=c(0,16))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=g_std, max_height= vec_max_rA[i]), col='blue')
}
######

# A & I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 3, vec_met = c("A","I"), title = paste0("[rI_std = 3] pH perturbation simulation (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode")

# A
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 3, vec_met = c("A"), title = paste0("[rI_std = 3] pH perturbation simulation (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode")

# I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 3, vec_met = c("I"), title = paste0("[rI_std = 3] pH perturbation simulation (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode")




## smaller variance

###### histogram and rI, rA distribution######
hist(vec_opt_pH, xlab = "Optimal pH of strains", main = "Opt_pH distribution in soil of pH=7", breaks = 14)

# plot rI
g_std = 1
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=g_std, max_height= vec_max_rI[1]), xlab = "pH",ylab = "rI_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rI parameter of strains in soil of opt_pH = 7", ylim=c(0,16))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=g_std, max_height= vec_max_rI[i]), col='blue')
}

# plot rA
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=g_std, max_height= vec_max_rA[1]), xlab = "pH",ylab = "rA_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rA parameter of strains in soil of opt_pH = 7", ylim=c(0,16))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=g_std, max_height= vec_max_rA[i]), col='blue')
}
######


# A & I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 1, vec_met = c("A","I"), title = paste0("[rI_std = 1] pH perturbation simulation (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode")

# A
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 1, vec_met = c("A"), title = paste0("[rI_std = 1] pH perturbation simulation (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode")

# I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 1, vec_met = c("I"), title = paste0("[rI_std = 1] pH perturbation simulation (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode")

```

## 2.1.5.2. Change number of strains and ode method
ode45 can do the job?? wow..
```{r}

## 15 strains, standard deviation 2
set.seed(1)
k = 100 # number of strains in a community
vec_opt_pH <- rnorm(k, mean = 7, sd = 3) # changed the sd to 3
vec_opt_pH[vec_opt_pH<0] <- 0 # none can go below 0
vec_opt_pH[vec_opt_pH>14] <- 14 # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI <- runif(k, 0, 15)
vec_max_rA <- runif(k, 0, 15)

# A & I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-5:-1,1:5), gauss_std = 3, vec_met = c("A","I"), title = paste0("[rI_std = 3] pH perturbation simulation (n=",k,")"), time = 5, time_by = 0.01, ode_method = "ode45")

## smaller variance
# A & I
plot_perturbation(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-5:-1,1:5), gauss_std = 1, vec_met = c("A","I"), title = paste0("[rI_std = 1] pH perturbation simulation (n=",k,")"), time = 5, time_by = 0.01, ode_method = "ode45")

```


## 2.1.6. Area under curve

```{r}


plot_perturbation_auc <- function(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met =c("A","I"), title, time = 10, time_by = 0.01, ode_method = "vode", annotate_x, annotate_y){
  # ODE solver
  k = length(vec_opt_pH)
  vec_rI = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
  vec_rA = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
  set.seed(4)
  parameter_1 = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
  state_1 = list(x = rep(0.01,k), A = 2, I = 0)

  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
  df_out <- as.data.frame(outc)
  df_out$pH <- pH_from
  dim(df_out)
  
  for (i in pH_perturb){
    pH_to = pH_from + i
    print(pH_to)
    vec_rI = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
    # print(tail(vec_rI))
    # print(tail(vec_rA))
    vec_rA = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
    set.seed(4)
    parameters = list(gamI=runif(k, 0, 0.02), rI =vec_rI, gamA= runif(k, 0, 0.02), rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    # print(parameter$rI)
    states = list(x = rep(0.01,k), A = 2, I = 0)
    outc <- ode(unlist(states), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_add <- as.data.frame(outc)
    df_add$pH <- pH_to
    df_out <- rbind(df_out,df_add)
  }
  colnames(df_out)
  df_out <- melt(df_out, id.vars = c("time", "pH"))
  tail(df_out)
  dim(df_out)
  df_ai <- df_out %>% filter(variable %in% vec_met) # use 1 or both
  dim(df_ai)
  colnames(df_ai)
  
  # plot nitrate, nitrite
  names(df_ai)[3] <- "Metabolite" # variable -> Metabolite
  colnames(df_ai)
  
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  colnames(df_ai)
  head(df_ai)
  df_ai$value <- ifelse(df_ai$value < 0, 0, df_ai$value)
  
  require(pracma)
  df_a <- df_ai %>% filter(Metabolite =="Nitrate (NO3-)")
  colnames(df_a)
  df_corr <- df_a %>% group_by(pH) %>% summarize(auc = trapz(time, value)) %>% ungroup()
  
  plot(df_corr$pH, df_corr$auc)
  
  df_corr$pH_2 <- (df_corr$pH)^2
  fit.no3 <- lm(auc ~ pH + pH_2, df_corr)
  summary(fit.no3)
  
  perturbpH <- seq(2, 13, 0.1)
  aucPredict <- predict(fit.no3,list(pH=perturbpH, pH_2=perturbpH^2))
  df_auc_quad <- data.frame(pH = perturbpH, Time_hours = aucPredict)
  plot(perturbpH, aucPredict)
  
  # (1) Plot fitted linear regression line
  ggplot(df_corr, aes(x=pH, y=auc)) +
    geom_point(size=2.5, shape=16, color = "brown") +
    # stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1) +
    # geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+
    # scale_color_brewer(palette='Set2') +
    # scale_color_manual(values = c("maroon2","deepskyblue4"))+
    xlab("perturbed pH \n") +
    ylab("\n Area under curve (NO3-)") +
    # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+
    #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family="serif", show.legend = FALSE)+
    ggtitle(paste0(title," \n")) +
    # geom_abline(slope = 1, intercept=0, show.legend = "y=x")+
    # regression line
    geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = "maroon2", size = 1) +
    # show equation
    annotate("text",x= annotate_x,y=annotate_y, label= paste0("y = ", round(coef(fit.no3)[[1]],3), "+", round(coef(fit.no3)[[2]],3),"x+",round(coef(fit.no3)[[3]],3), "x^2", ",  R^2: ", round(summary(fit.no3)$r.squared,3)), color = "maroon2") +
    mytheme_2d
}

# plot with 15 strain model

## 15 strains, standard deviation 2
set.seed(1)
k = 15 # number of strains in a community
vec_opt_pH <- rnorm(k, mean = 7, sd = 3) # changed the sd to 3
vec_opt_pH[vec_opt_pH<0] <- 0 # none can go below 0
vec_opt_pH[vec_opt_pH>14] <- 14 # none can go above 14

# what if I make the max_height uniform distribution
set.seed(33)
vec_max_rI <- runif(k, 0, 15)
vec_max_rA <- runif(k, 0, 15)

# A & I
plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 3, vec_met = c("A","I"), title = paste0("[rI_std = 3] Simulated Area under curve NO3- (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode", annotate_x = 7, annotate_y = 3)

## smaller variance
# A & I
plot_perturbation_auc(vec_opt_pH, vec_max_rI, vec_max_rA, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 1, vec_met = c("A","I"), title = paste0("[rI_std = 1] Simulated Area under curve NO3- (n=",k,")"), time = 72, time_by = 0.01, ode_method = "vode", annotate_x = 7, annotate_y = 10)



# colnames(df_ai)
# df_a <- df_ai %>% filter(Metabolite =="Nitrate (NO3-)")
# mat_NO3 <- dcast(df_a, pH ~ time, value.var = "value")
# dim(mat_NO3)
# head(mat_NO3)
# mat_NO3 <- tibble::column_to_rownames(mat_NO3, var = "pH")
# mat_NO3 <- as.matrix(mat_NO3) 
# class(mat_NO3)
# dim(mat_NO3)

# require(pracma)
# colnames(df_a)
# df_corr <- df_a %>% group_by(pH) %>% summarize(auc = trapz(time, value)) %>% ungroup()
# 
# plot(df_corr$pH, df_corr$auc)
# 
# df_corr$pH_2 <- (df_corr$pH)^2
# fit.no3 <- lm(auc ~ pH + pH_2, df_corr)
# summary(fit.no3)
# 
# perturbpH <- seq(2, 13, 0.1)
# aucPredict <- predict(fit.no3,list(pH=perturbpH, pH_2=perturbpH^2))
# df_auc_quad <- data.frame(pH = perturbpH, Time_hours = aucPredict)
# plot(perturbpH, aucPredict)
# 
# # (1) Plot fitted linear regression line
# ggplot(df_corr, aes(x=pH, y=auc)) +
#   geom_point(size=2.5, shape=16, color = "brown") +
#   # stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1) +
#   # geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+
#   # scale_color_brewer(palette='Set2') +
#   # scale_color_manual(values = c("maroon2","deepskyblue4"))+
#   xlab("Amount of pH perturbation (H+ mM) \n") +
#   ylab("\n Area under curve (NO3-)") +
#   # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+
#   #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
#   # geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family="serif", show.legend = FALSE)+
#   ggtitle("Correlation with perturbation and area under nitrate curve \n") +
#   # geom_abline(slope = 1, intercept=0, show.legend = "y=x")+
#   # regression line
#   geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = "maroon2", size = 1) +
#   # show equation
#   annotate("text",x=7,y=0.5, label= paste0("y = ", round(coef(fit.no3)[[1]],3), "+", round(coef(fit.no3)[[2]],3),"x+",round(coef(fit.no3)[[3]],3), "x^2", ",  R^2: ", round(summary(fit.no3)$r.squared,3)), color = "maroon2") +
#   mytheme_2d

```


## 3. [Ecological drivers] Perturb the soil pH: by Ecology
The previous simulation relied on each individual strain's physiology. 
Now we will simulate the pH perturbation in a slightly different method.
(1) Strain level
first we will fix the rI, rA of 15 strains. They will have the same max_height of rI, rA curve at opt_pH.
(2) Soil level
First community and the second community will have the same 15 strains. But their relative abundance will be different. First community will have a gaussian distribution of relative abundance with mean = opt_pH = 7. Second community will have uniform distribution of the relative abundance. The total biomass of both community will be same, 0.1 OD.

## 3.1. Set up soil community
```{r}

dev.off()

# function
gaussian_function <- function(x, std, mean, max_height=0.3989423){
  factor = max_height * std*sqrt(2*pi)
  return(factor*(1/ (std * sqrt(2*pi)))*exp((-0.5)*( (x - mean) / std)^2))
}

## 15 strains, standard deviation 2
set.seed(1)
k = 15 # number of strains in a community
vec_opt_pH = seq(3, 12, length=15)

## same max_height of rI, rA = 10
vec_max_rI <- rep(10, 15)
vec_max_rA <- rep(10, 15)

## plot rI and rA
x <- seq(0, 14, by = 0.01)
plot(x, gaussian_function(x, mean=vec_opt_pH[1], std=2, max_height= vec_max_rI[1]), xlab = "pH",ylab = "rI_i or rA_i", col='blue', type = "l",lty = 1, pch=19,lwd=1, main = "Simulating rI & rA parameter of strains", ylim=c(0,12))

for (i in 2:k){
  lines(x, gaussian_function(x, mean=vec_opt_pH[i], std=2, max_height= vec_max_rI[i]), col='blue')
}

## relative abundance
## of first community
opt_pH = 7
rel_abun1 <- gaussian_function(vec_opt_pH, mean=opt_pH, std=2, max_height= 10)
rel_abun1 <- rel_abun1/sum(rel_abun1)
abs_abun1 <- rel_abun1/10 # sum to 0.1 OD
sum(abs_abun1) # 0.1 OD

## of second community
rel_abun2 = rep(1/k, k)
abs_abun2 = rep(0.1/k, k)
sum(abs_abun2)

# plot relative abundance
plot(vec_opt_pH, rel_abun1, xlab = "optimal pH", ylab = "Relative abundance", col='red', type = "l",lty = 1, pch=19,lwd=1, main = "Relative abundance of strains with varying optimal pH", ylim=c(0,0.3))
lines(vec_opt_pH, rel_abun2, lty = 1, pch=19,lwd=1, col='blue')
legend(7, 0.25, legend=c('Gaussian community', 'Uniform community'), col=c("Red", "Blue"), lty=c(1,1), cex=0.8, box.lty=0)


# plot dynamics
## rI when current pH is 7
vec_rI = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=vec_max_rI)
length(vec_rI)
vec_rA = gaussian_function(x=7, mean=vec_opt_pH, std=2, max_height=vec_max_rA)
length(vec_rA)

## Gaussian community
k=15
set.seed(1)
vec_gamma = runif(k, 0, 0.02)
parameter_1 = list(gamI=vec_gamma, rI =vec_rI, gamA= vec_gamma, rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state_1 = list(x = abs_abun1, A = 2, I = 0)
plot_2results(title = paste0("Gaussian Community dynamics at natural state, pH=7"),time = 5, time_by = 0.01, parameters=parameter_1, state=state_1, ode_method = "vode")

## Uniform community
k=15
set.seed(1)
vec_gamma = runif(k, 0, 0.02)
parameter_1 = list(gamI=vec_gamma, rI =vec_rI, gamA= vec_gamma, rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
# all strains will start from OD600 of 0.01
state_1 = list(x = abs_abun2, A = 2, I = 0)
plot_2results(title = paste0("Uniform Community dynamics at natural state, pH=7"),time = 5, time_by = 0.01, parameters=parameter_1, state=state_1, ode_method = "vode")

```

## 3.2. pH Perturbation simulation

```{r}
# function modify
plot_perturbation_rel_abun <- function(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun, pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met =c("A","I"), title, time = 10, time_by = 0.01, ode_method = "vode"){
  # ODE solver
  k = length(vec_opt_pH)
  set.seed(4)
  vec_gamma = runif(k, 0, 0.02)
  vec_rI = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
  vec_rA = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
  
  parameter_1 = list(gamI=vec_gamma, rI =vec_rI, gamA= vec_gamma, rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
  state_1 = list(x = rel_abun, A = 2, I = 0)
  print(rel_abun)

  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
  df_out <- as.data.frame(outc)
  df_out$pH <- pH_from
  dim(df_out)
  
  for (i in pH_perturb){
    pH_to = pH_from + i
    print(pH_to)
    vec_rI = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
    # print(tail(vec_rI))
    # print(tail(vec_rA))
    vec_rA = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
    parameters = list(gamI=vec_gamma, rI =vec_rI, gamA= vec_gamma, rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    # print(parameter$rI)
    states = list(x = rel_abun, A = 2, I = 0)
    outc <- ode(unlist(states), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_add <- as.data.frame(outc)
    df_add$pH <- pH_to
    df_out <- rbind(df_out,df_add)
  }
  colnames(df_out)
  df_out <- melt(df_out, id.vars = c("time", "pH"))
  tail(df_out)
  dim(df_out)
  df_ai <- df_out %>% filter(variable %in% vec_met) # use 1 or both
  dim(df_ai)
  colnames(df_ai)
  
  # plot nitrate, nitrite
  names(df_ai)[3] <- "Metabolite" # variable -> Metabolite
  colnames(df_ai)
  
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  colnames(df_ai)
  head(df_ai)
  df_ai$value <- ifelse(df_ai$value < 0, 0, df_ai$value)
  
  # pH color
  col_pH <- colorRampPalette(c("purple",'red',"gold"))

  library(colorRamps)
  df_ai %>% select(Metabolite) %>% unique()
  df_ai %>% select(pH) %>% unique()

  ggplot(df_ai, aes(x=time, y=value, color=pH, group=pH)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
    scale_colour_gradientn(colours = col_pH(100)) +
    ylab("Nitrate or Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    scale_y_continuous(breaks = seq(0,2,0.25), limits=c(0, 2))+
    # expand_limits(y=0) +
    ggtitle(paste0(title," \n")) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d +
    facet_grid(. ~ Metabolite) +
    theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
}


plot_perturbation_rel_abun_auc <- function(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun, pH_from = 7, pH_perturb = c(-4:-1, 1:3), gauss_std = 3, vec_met =c("A","I"), title, time = 10, time_by = 0.01, ode_method = "vode", annotate_x, annotate_y){
  # ODE solver
  k = length(vec_opt_pH)
  set.seed(4)
  vec_gamma = runif(k, 0, 0.02)
  vec_rI = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
  vec_rA = gaussian_function(x= pH_from, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
  
  parameter_1 = list(gamI=vec_gamma, rI =vec_rI, gamA= vec_gamma, rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
  state_1 = list(x = rel_abun, A = 2, I = 0)
  print(rel_abun)

  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state_1), times, crGrowth, parameter_1, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
  df_out <- as.data.frame(outc)
  df_out$pH <- pH_from
  dim(df_out)
  
  for (i in pH_perturb){
    pH_to = pH_from + i
    print(pH_to)
    vec_rI = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rI)
    # print(tail(vec_rI))
    # print(tail(vec_rA))
    vec_rA = gaussian_function(x= pH_to, mean=vec_opt_pH, std= gauss_std, max_height=vec_max_rA)
    parameters = list(gamI=vec_gamma, rI =vec_rI, gamA= vec_gamma, rA = vec_rA, kI = rep(0.01, k), kA = rep(0.01, k))
    # print(parameter$rI)
    states = list(x = rel_abun, A = 2, I = 0)
    outc <- ode(unlist(states), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
    df_add <- as.data.frame(outc)
    df_add$pH <- pH_to
    df_out <- rbind(df_out,df_add)
  }
  colnames(df_out)
  df_out <- melt(df_out, id.vars = c("time", "pH"))
  tail(df_out)
  dim(df_out)
  df_ai <- df_out %>% filter(variable %in% vec_met) # use 1 or both
  dim(df_ai)
  colnames(df_ai)
  
  # plot nitrate, nitrite
  names(df_ai)[3] <- "Metabolite" # variable -> Metabolite
  colnames(df_ai)
  
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  colnames(df_ai)
  head(df_ai)
  df_ai$value <- ifelse(df_ai$value < 0, 0, df_ai$value)
  
  require(pracma)
  df_a <- df_ai %>% filter(Metabolite =="Nitrate (NO3-)")
  colnames(df_a)
  df_corr <- df_a %>% group_by(pH) %>% summarize(auc = trapz(time, value)) %>% ungroup()
  
  plot(df_corr$pH, df_corr$auc)
  
  df_corr$pH_2 <- (df_corr$pH)^2
  fit.no3 <- lm(auc ~ pH + pH_2, df_corr)
  summary(fit.no3)
  
  perturbpH <- seq(2, 13, 0.1)
  aucPredict <- predict(fit.no3,list(pH=perturbpH, pH_2=perturbpH^2))
  df_auc_quad <- data.frame(pH = perturbpH, Time_hours = aucPredict)
  plot(perturbpH, aucPredict)
  
  # (1) Plot fitted linear regression line
  ggplot(df_corr, aes(x=pH, y=auc)) +
    geom_point(size=2.5, shape=16, color = "brown") +
    # stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1) +
    # geom_errorbar(aes(ymin=NO3_mM - sd_NO3_mM, ymax=NO3_mM + sd_NO3_mM), width=.05)+
    # scale_color_brewer(palette='Set2') +
    # scale_color_manual(values = c("maroon2","deepskyblue4"))+
    xlab("perturbed pH \n") +
    ylab("\n Area under curve (NO3-)") +
    # scale_x_continuous(breaks = seq(0,16,1), limits=c(0, 16))+
    #scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # geom_text_repel(aes(label = round(NO3_mM,3)), size = 3,family="serif", show.legend = FALSE)+
    ggtitle(paste0(title," \n")) +
    # geom_abline(slope = 1, intercept=0, show.legend = "y=x")+
    # regression line
    geom_line(data = df_auc_quad, aes(x = pH, y = Time_hours), color = "maroon2", size = 1) +
    # show equation
    annotate("text",x= annotate_x,y=annotate_y, label= paste0("y = ", round(coef(fit.no3)[[1]],3), "+", round(coef(fit.no3)[[2]],3),"x+",round(coef(fit.no3)[[3]],3), "x^2", ",  R^2: ", round(summary(fit.no3)$r.squared,3)), color = "maroon2") +
    mytheme_2d
}



  

  
  
  
  
  
## Gaussian community
plot_perturbation_rel_abun(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c("A","I"), title = paste0("[Gaussian community] Simulated Area under curve NO3- (n=",k,")"), time = 10, time_by = 0.01, ode_method = "vode")

## Gaussian community - AUC
plot_perturbation_rel_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun1, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c("A","I"), title = paste0("[Gaussian community] Simulated Area under curve NO3- (n=",k,")"), time = 10, time_by = 0.01, ode_method = "vode", annotate_x = 7.5, annotate_y = 3.5)

## Uniform community
plot_perturbation_rel_abun(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun2, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c("A","I"), title = paste0("[Uniform community] Simulated Area under curve NO3- (n=",k,")"), time = 10, time_by = 0.01, ode_method = "vode")

## Uniform community - AUC
plot_perturbation_rel_abun_auc(vec_opt_pH, vec_max_rI, vec_max_rA, rel_abun = rel_abun2, pH_from = 7, pH_perturb = c(seq(-5, -0.5, by =0.5), seq(0.5, 5, by =0.5)), gauss_std = 2, vec_met =c("A","I"), title = paste0("[Uniform community] Simulated Area under curve NO3- (n=",k,")"), time = 10, time_by = 0.01, ode_method = "vode", annotate_x = 7.5, annotate_y = 3.5)












```








