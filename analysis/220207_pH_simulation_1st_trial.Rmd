---
title: "220207_pH_simulation_1st_trial"
author: "KiseokLee"
date: "2022-02-07"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(fig.width=11, fig.height=9,
                      error=TRUE, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE,
                      tidy.opts=list(width.cutoff=40),tidy=TRUE)
```

## 220207 Denitrification and pH perturbation simulation first trial 
Name: **Kiseok Lee** \
Date: 2/7/22 \
Lab: **Seppe Kuehn lab**

```{r, echo=FALSE}
# libraries
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(vegan)
library(tidyverse)
library(magrittr)
library(readxl)
library(reshape2)
library(gtools)
library(devtools)
library(openxlsx)
library(ape)
library(stringr)
library(tidyr)
library(ggrepel)
library(ggpubr)
library(deSolve)

## theme for ggplot
mytheme <- theme_bw() + 
  theme(text = element_text(family="serif")) +
  theme(plot.title = element_text(size = 19,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10, family="serif"))+
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank(),panel.background=element_blank(),panel.border=element_blank(),plot.background=element_blank())+
  theme(axis.ticks = element_line(size = 1.1))

mytheme_2d <- theme_bw() + 
  theme(text = element_text(family="serif")) +
  theme(plot.title = element_text(size = 19,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=13, family="serif"))+
  # theme(panel.grid.major = element_blank()) +
  # theme(panel.grid.minor = element_blank(),panel.background=element_blank(),plot.background=element_blank()) +
  theme(axis.ticks = element_line(size = 1.1))
  # theme(legend.text=element_text(size=13))


# color collection
my_color_collection <- c(
  "#CBD588", "#5F7FC7", "orange", "#AD6F3B", "#673770", 
  "#D14285", "#652926", "#C84248", "#8569D5", "#5E738F",
  "#D1A33D", "#8A7C64", "#599861","#616163", "#FFCDB2",
  "#6D9F71", "#242F40",
  "#CCA43B", "#F92A82", "#ED7B84", "#7EB77F", 
  "#DEC4A1", "#E5D1D0", '#0E8482', '#C9DAEA', '#337357', 
  '#95C623', '#E55812', '#04471C', '#F2D7EE', '#D3BCC0', 
  '#A5668B', '#69306D', '#0E103D', '#1A535C', '#4ECDC4', 
  '#F7FFF7', '#FF6B6B', '#FFE66D', '#6699CC', '#FFF275', 
  '#FF8C42', '#FF3C38', '#A23E48', '#000000', '#CF5C36', 
  '#EEE5E9', '#7C7C7C', '#EFC88B', '#2E5266', '#6E8898', 
  '#9FB1BC', '#D3D0CB', '#E2C044', '#5BC0EB', '#FDE74C', 
  '#9BC53D', '#E55934', '#FA7921', "#CD9BCD", "#508578", "#DA5724")

# for git push, use this instead of using wflow_git_push()
# git push -u origin master (in the Git app / in the working directory)

# for making pdf file
library(rmarkdown)
# render("analysis/~~.Rmd", "pdf_document")

```

## 1. Setting up 

## 1.1. First let's set up the consumer resource model dynamics

```{r}
## Consumer resource model
#' @param x cell biomass (OD)
#' @param I nitrite concentration (mM)
#' @param A nitrate concentration (mM)
#' @param gamI biomass yields from nitrite (OD/mM)
#' @param gamA biomass yields from nitrate (OD/mM)
#' @param rI reduction rate of nitrite ((mM/OD)/h)
#' @param rA reduction rate of nitrate ((mM/OD)/h)
#' @param kI half velocity constant of nitrate reduction (mM)
#' @param kA half velocity constant of nitrate reduction (mM)

# set up the Consumer Resource model ode
crGrowth <- function(t, state, parameters) {
  with(as.list(c(state, parameters)),{
  # biomass
  dx <- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
  # nitrate
  dA <- - rA*(A/(kA + A)) *x
  # nitrite
  dI <- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
  list(c(dx, dA, dI))
  }) # end with(as.list ...
} 

parameters <- c(gamI=0.01, rI=1.6, gamA=0.01, rA=3.1, kI = 0.01, kA = 0.01)
parameters <- c(gamI=1, rI=1, gamA=1, rA=1, kI = 1, kA = 1)

state <- c(x = 2, A = 2, I = 0 )

times <- seq(0, 10, by = 1)
outc <- ode(state, times, crGrowth, parameters, method = "lsoda", atol = 1e-4, rtol = 1e-4)
outc

plot(outc, xlab = "time", ylab = "-")
plot(outc, xlab="Time (hr)", ylab=c("Biomass (OD)","Nitrite (mM)","Nitrate (mM)"), col='black', type = "l",lty = 1, pch=19,lwd=1, main="Consumer Resource model")

```


## 1.2. Enable many strains (community level dynamics)

```{r}
# set up the Consumer Resource model ode
parameters = list(gamI=c(0.01,0.02), rI =c(1.6,1.5), gamA= c(0.01,0.02), rA = c(3.1,3.2), kI = c(0.01,0.02), kA = c(0.01,0.02))
state = list(x = c(2,3), A = 2, I = 0)

crGrowth <- function(t,state, parameters ) {
  with(as.list(c(state, parameters)),{
    
    dx <- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
    print(paste0("dx: ",dx))
    # nitrate
    dA <- - rA*(A/(kA + A)) *x
    print(paste0("dA: ",dA))
    # nitrite
    dI <- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
    print(paste0("dI: ",dI))
    # print(paste0("return sum(dI): ", sum(dI)))
    # print(paste0("Please return the values in the same order as state variable"))
    list( c(dx, sum(dA), sum(dI)) )
  }) # end with(as.list ...
}

crGrowth(t=1, state, parameters)
crGrowth(t=2, state, parameters)
crGrowth(t=3, state, parameters)
crGrowth(t=4, state, parameters)

# ODE solver
times <- seq(0, 10, by = 0.1)
outc <- ode(unlist(state), times, crGrowth, parameters, method = "vode", atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
outc

# plot
n_strains <- length(state$x)
plot(outc, xlab = "time", ylab = "")
plot(outc, xlab="Time (hr)", ylab=c(rep("Biomass (OD)",n_strains),"Nitrate NO3- (mM)","Nitrite NO2- (mM)"), col='black', type = "l",lty = 1, pch=19,lwd=1, main="Consumer Resource model")


## test if it is correct
# just with first component x1
parameters1 = list(gamI=c(0.01), rI =c(1.6), gamA= c(0.01), rA = c(3.1), kI = c(0.01), kA = c(0.01))
state1 = list(x = c(0.01), A = 2, I = 0)

gamI=c(0.01); rI =c(1.6); gamA= c(0.01); rA = c(3.1); kI = c(0.01); kA = c(0.01)
x = c(0.01); A = 2; I = 0
(gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x

# set up the Consumer Resource model ode
crGrowth(t=1, state1, parameters1) # 0.06169154 -6.16915423  6.16915423

# then with second compnent x2
parameters2 = list(gamI=c(0.02), rI =c(1.5), gamA= c(0.02), rA = c(3.2), kI = c(0.02), kA = c(0.02))
state2 = list(x = c(0.01), A = 2, I = 0)

gamI=c(0.02); rI =c(1.5); gamA= c(0.02); rA = c(3.2); kI = c(0.02); kA = c(0.02)
x = c(0.01); A = 2; I = 0
(gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
crGrowth(t=1, state2, parameters2) # 0.190099 -9.504950  9.504950

# sum up 
# 0.06169154, 0.190099  -15.6741 15.6741
parameters = list(gamI=c(0.01,0.02), rI =c(1.6,1.5), gamA= c(0.01,0.02), rA = c(3.1,3.2), kI = c(0.01,0.02), kA = c(0.01,0.02))
state = list(x = c(0.01,0.01), A = 2, I = 0)
crGrowth(t=1, state, parameters)

parameters3 = list(gamI=c(0.01,0.02,0.03), rI =c(1.6,1.5,1.2), gamA= c(0.01,0.02,0.03), rA = c(3.1,3.2,2), kI = rep(0.01,3), kA = rep(0.01,3))
state3 = list(x = c(1,1,1), A = 2, I = 0)
crGrowth(t=1, state3, parameters3)

```
The new crGrowth function seems to be doing a good job summing up all dA/dt from x1, x2.

## 1.3. Let's simulate a community
Let's say we have n strains
```{r}
# set up the Consumer Resource model ode
crGrowth <- function(t,state, parameters ) {
  with(as.list(c(state, parameters)),{
    dx <- (gamA*rA*(A/(kA + A))+gamI*rI*(I/(kI + I))) *x
    # nitrate
    dA <- - rA*(A/(kA + A)) *x
    # nitrite
    dI <- ( rA*(A/(kA + A)) - rI*(I/(kI + I)) ) *x
    # print(paste0("dI: ",dI))
    # print(paste0("return sum(dI): ", sum(dI)))
    # print(paste0("Please return the values in the same order as state variable"))
    list( c(dx, sum(dA), sum(dI)) )
  }) # end with(as.list ...
}

## as in Karna's paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna's paper)
## rI, rA max is 15 (from Karna's paper)
k = 10
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(1,k), A = 2, I = 0)

# hist(rpois(1000, lambda = 4))

crGrowth(t=1, state, parameters)

# ODE solver
times <- seq(0, 10, by = 0.1)
outc <- ode(unlist(state), times, crGrowth, parameters, method = "vode", atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)
outc

# plot
n_strains <- length(state$x)
plot(outc, xlab = "time", ylab = "")
plot(outc, xlab="Time (hr)", ylab=c(rep("Biomass (OD)",n_strains),"Nitrate NO3- (mM)","Nitrite NO2- (mM)"), col='black', type = "l",lty = 1, pch=19,lwd=1, main="Consumer Resource model")

# using ggplot to get 3 graphs
colnames(outc)
class(outc)
df_out <- as.data.frame(outc)
head(df_out)
df_out <- melt(df_out, id.vars = c("time"))
dim(df_out)
df_com <- df_out %>% filter(!(variable %in% c("A","I")))
dim(df_com)
tail(df_com)
df_ai <- df_out %>% filter(variable %in% c("A","I"))
dim(df_ai)

# plot strain dynamics
names(df_com)[2] <- "Strain" 

p_strain <- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  # scale_color_manual(values=grad_pH) +
  ylab("Biomass (OD) \n") +
  xlab("\n Time (hr)") +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  expand_limits(y=0) +
  ggtitle("Consumer-resource model community dynamics \n") +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))

p_strain

# plot nitrate, nitrite
names(df_ai)[2] <- "Metabolite"
df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")

p_ai <- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
  ylab("Nitrate or Nitrite (mM) \n") +
  xlab("\n Time (hr)") +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  # expand_limits(y=0) +
  ggtitle("Metabolite dynamics \n") +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
p_ai

df_i <- df_ai %>% filter(Metabolite == "Nitrite (NO2-)")
p_nitrite <- ggplot(df_i, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
  # geom_point(size=2.5, shape=16) +
  geom_line(size=1.2)+
  # scale_colour_gradientn(colours = col_pH(100)) +
  scale_color_manual(values=c("#ad4620")) + ## blue = nitrate, red = nitrite
  ylab("Nitrite (mM) \n") +
  xlab("\n Time (hr)") +
  # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
  # expand_limits(y=0) +
  ggtitle("Nitrite close-up dynamics \n") +
  # label
  # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
  mytheme_2d
  # facet_grid(. ~ Soil) +
  # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
p_nitrite

require(gridExtra)
grid.arrange(p_strain, p_ai, p_nitrite, nrow=1)



```

## 1.4. Wrap this into a function

```{r}
# plot community dynamics, metabolite, nitrite close up

## as in Karna's paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna's paper)
## rI, rA max is 15 (from Karna's paper)
k = 10 # number of strains in a community
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(1,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))

plot_3results <- function(time = 10, time_by = 0.01,  parameters, state){
  # ODE solver
  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state), times, crGrowth, parameters, method = "vode", atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out <- as.data.frame(outc)
  head(df_out)
  df_out <- melt(df_out, id.vars = c("time"))
  dim(df_out)
  df_com <- df_out %>% filter(!(variable %in% c("A","I")))
  dim(df_com)
  tail(df_com)
  df_ai <- df_out %>% filter(variable %in% c("A","I"))
  dim(df_ai)
  
  # plot strain dynamics
  names(df_com)[2] <- "Strain" 
  
  p_strain <- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=grad_pH) +
    ylab("Biomass (OD) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Consumer-resource model community dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_strain
  
  # plot nitrate, nitrite
  names(df_ai)[2] <- "Metabolite"
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  
  p_ai <- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
    ylab("Nitrate or Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Metabolite dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_ai
  
  df_i <- df_ai %>% filter(Metabolite == "Nitrite (NO2-)")
  p_nitrite <- ggplot(df_i, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c("#ad4620")) + ## blue = nitrate, red = nitrite
    ylab("Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Nitrite close-up dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_nitrite
  
  require(gridExtra)
  return(grid.arrange(p_strain, p_ai, p_nitrite, nrow=1))
}

plot_2results <- function(title, time = 10, time_by = 0.01, ode_method = "vode", parameters, state){
  # ODE solver
  times <- seq(0, time, by = time_by)
  outc <- ode(unlist(state), times, crGrowth, parameters, method = ode_method, atol = 1e-4, rtol = 1e-4) # vode (variable-coefficient ODE solver), daspk(high order implicit solver for differential-algebraic equations) is best (give positive value)

  # using ggplot to get 3 graphs
  colnames(outc)
  class(outc)
  df_out <- as.data.frame(outc)
  head(df_out)
  df_out <- melt(df_out, id.vars = c("time"))
  dim(df_out)
  df_com <- df_out %>% filter(!(variable %in% c("A","I")))
  dim(df_com)
  tail(df_com)
  df_ai <- df_out %>% filter(variable %in% c("A","I"))
  dim(df_ai)
  
  # plot strain dynamics
  names(df_com)[2] <- "Strain" 
  
  p_strain <- ggplot(df_com, aes(x=time, y=value, color=Strain, group=Strain)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    # scale_color_manual(values=grad_pH) +
    ylab("Biomass (OD) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle(paste0(title," \n")) +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  # p_strain
  
  # plot nitrate, nitrite
  names(df_ai)[2] <- "Metabolite"
  df_ai$Metabolite <- ifelse(df_ai$Metabolite == "A", "Nitrate (NO3-)", "Nitrite (NO2-)")
  
  p_ai <- ggplot(df_ai, aes(x=time, y=value, color=Metabolite, group=Metabolite)) +
    # geom_point(size=2.5, shape=16) +
    geom_line(size=1.2)+
    # scale_colour_gradientn(colours = col_pH(100)) +
    scale_color_manual(values=c("#3958ab","#ad4620")) + ## blue = nitrate, red = nitrite
    ylab("Nitrate or Nitrite (mM) \n") +
    xlab("\n Time (hr)") +
    # scale_y_continuous(breaks = seq(0,0.3,0.05), limits=c(0, 0.3))+
    # expand_limits(y=0) +
    ggtitle("Metabolite dynamics \n") +
    # label
    # geom_text(aes(label = round(Ave_NO3_mM,3)), size = 3, vjust = -1.5, family="serif", show.legend = FALSE)+
    mytheme_2d
    # facet_grid(. ~ Soil) +
    # theme(strip.background = element_rect(colour="black", fill="white", size=0.1))
  require(gridExtra)
  return(grid.arrange(p_strain, p_ai, nrow=1))
}

## testing if the function works
## as in Karna's paper, fix kI and kA = 0.01 mM
## First, use random distribution
## 10 strains
## gamI, gamA max is 0.02 (from Karna's paper)
## rI, rA max is 15 (from Karna's paper)
k = 10 # number of strains in a community
set.seed(2)
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.01,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = "Consumer resource model: uniformly sampled model parameters",time = 30, time_by= 0.01,  parameters=parameters, state=state)

```

## 1.5. Why is the time scale so fast?

```{r}
k = 3 # number of strains in a community
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.0001,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = "Consumer resource model",time = 30, time_by = 0.01, parameters=parameters, state=state)


```

## 1.6. Let's import Karna SDM(succinate defined media) and plot those dynamics

```{r}
df_karna <- read.csv("data/consumer_resource_parameters_SDM.csv") # succinate defined media 
names(df_karna)[1] <- "Strain"

head(df_karna)
df_karna[1,]
parameters = c(rA = df_karna[1,2], gamA = df_karna[1,3], rI = df_karna[1,4], gamI = df_karna[1,5], kI = 0.01, kA = 0.01) 
state = list(x = 0.01, A = 2, I = 0)
plot_2results(title = "Consumer resource model (1 strain: ACM01)",time = 30, time_by = 0.01, parameters=parameters, state=state)

# Another strain
head(df_karna)
df_karna[1,]
strain_i = 2
parameters = c(rA = df_karna[strain_i,2], gamA = df_karna[strain_i,3], rI = df_karna[strain_i,4], gamI = df_karna[strain_i,5], kI = 0.01, kA = 0.01) 
state = list(x = 0.01, A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (1 strain:", df_karna[strain_i,1],")"),time = 30, time_by = 0.01, parameters=parameters, state=state)

```

## 1.7. Validate with 2 strain community
There is sth wrong with my ode function
```{r}
# 2 strain
head(df_karna)
df_2strain <- df_karna %>% filter(Strain %in% c("ACV02","AGB01"))

k = 2
vec_strain = 1:k
parameters = list(rA = df_2strain[vec_strain,2], gamA = df_2strain[vec_strain,3], rI = df_2strain[vec_strain,4], gamI = df_2strain[vec_strain,5], kI = rep(0.01,k), kA = rep(0.01,k))
state = list(x = c(0.01,0.01), A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (2 strain:", df_2strain[1,1],"+",df_2strain[2,1],")"),time = 72, time_by = 0.01, parameters=parameters, state=state, ode_method = "vode")

```


## 1.8. 10 strains from real data

```{r}

head(df_karna)
dim(df_karna)

# randomly pick k=10 strains
k=10
set.seed(1)
vec_strain = sample(1:nrow(df_karna), k, replace = F)

parameters = list(rA = df_karna[vec_strain,2], gamA = df_karna[vec_strain,3], rI = df_karna[vec_strain,4], gamI = df_karna[vec_strain,5], kI = rep(0.01,k), kA = rep(0.01,k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (", k," Karna strains)"),time = 30, time_by = 0.01, parameters=parameters, state=state)


```

## 1.9. 5 strains from real data parameters

```{r}

head(df_karna)
dim(df_karna)

# randomly pick k=10 strains
k=5
set.seed(1)
vec_strain = sample(1:nrow(df_karna), k, replace = F)

parameters = list(rA = df_karna[vec_strain,2], gamA = df_karna[vec_strain,3], rI = df_karna[vec_strain,4], gamI = df_karna[vec_strain,5], kI = rep(0.01,k), kA = rep(0.01,k))
# all strains will start from OD600 of 0.01
state = list(x = rep(0.01,k), A = 2, I = 0)
plot_2results(title = paste0("Consumer resource model (", k," Karna strains)"),time = 30, time_by = 0.01, parameters=parameters, state=state)

```

## 1.10. 5 strains from randomly sampled parameters
```{r}
k = 5 # number of strains in a community
set.seed(2)
parameters = list(gamI=runif(k, 0, 0.02), rI =runif(k, 0, 15), gamA= runif(k, 0, 0.02), rA = runif(k, 0, 15), kI = rep(0.01, k), kA = rep(0.01, k))
# same biomass 1
state = list(x = rep(0.01,k), A = 2, I = 0)
# hist(rpois(1000, lambda = 4))
plot_2results(title = "Consumer resource model: uniformly sampled model parameters",time = 30, time_by= 0.01,  parameters=parameters, state=state)



```


## 2. Now simulate pH perturbation
(1) First, simulate rI_i dependent on pH (gaussian distribution of mean = opt_pH)
(2) Second, construct soil community of pH 7, where relative abundance of strains with opt_pH is high.
(3) Third, perturb the pH and see how it changes.

```{r}














```



